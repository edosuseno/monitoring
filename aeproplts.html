<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEPRO PLTS</title>
    <!-- Memuat Tailwind CSS CDN untuk styling yang cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat ikon Lucide untuk visualisasi data -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Memuat Chart.js untuk membuat grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Memuat Plugin Chart.js untuk Pan dan Zoom -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    
    <!-- Konfigurasi Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'blynk-primary': '#4B87FF', // Biru Blynk
                        'bg-main': '#05050D', // Hitam Paling Gelap
                        
                        // SKEMA WARNA PROFESIONAL (FUNGSI)
                        'dc-color': '#BFFF00', // Hijau Lime Lembut (PV/DC)
                        'ac-color': '#FFB900', // Kuning Emas Hangat (AC-Beban)
                        'blue-bat': '#00FFFF', // Cyan Cerah (Baterai)
                        'green-400': '#00C853', // Hijau Cerah (Rupiah/SOH)
                        
                        // WARNA SEKUNDER (HIGH PRIORITY)
                        'pink-med': '#FF69B4', 
                        'purple-med': '#8E44AD', 
                        'orange-red': '#E74C3C', 
                        'warning-red': '#EF4444', // Merah Peringatan Terang

                         // Warna Chart.js
                        'chart-pv': '#BFFF00', // Sesuai dc-color
                        'chart-load': '#FFB900', // Sesuai ac-color
                        'chart-self-consumption': '#00FFFF', // Cyan
                        'chart-surplus': '#8E44AD', // Purple
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #05050D; /* Hitam Paling Gelap */
            font-family: 'Inter', sans-serif;
            color: #F8FAFC;
        }
        .lucide { stroke-width: 1.75; }
        .data-value {
            transition: color 0.3s, transform 0.3s;
        }
        .loading-animation {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Kartu Utama: Hitam Transparan, Tanpa Gradasi */
        .solar-card {
            background-color: rgba(20, 20, 48, 0.4); /* Menggunakan warna yang sangat gelap dengan transparansi */
            border-radius: 16px; 
            padding: 1.5rem;
            /* Bayangan Ramping */
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3); 
            border: 1px solid rgba(71, 85, 105, 0.2); /* Border lebih transparan */
            transition: all 0.3s ease;
        }
        .solar-card:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.5);
            transform: translateY(-2px); /* Efek Angkat Ringan */
            background-color: rgba(20, 20, 48, 0.6); /* Sedikit lebih solid saat hover */
        }
        
        /* GAYA AERO GLASS UNTUK DETAIL ITEM (Dipertahankan minimalis) */
        .detail-item {
            background-color: rgba(255, 255, 255, 0.03); /* Transparansi sangat rendah */
            border: 1px solid rgba(255, 255, 255, 0.08); /* Border sangat tipis */
            backdrop-filter: blur(2px); 
            
            border-radius: 12px; 
            margin-bottom: 0.75rem;
            padding: 0.75rem 1rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }
        .detail-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Gaya Khusus untuk Angka dan Satuan agar Sejajar (Ringkasan) */
        .summary-block {
            display: flex;
            align-items: baseline; 
            justify-content: flex-start;
        }
        .summary-value {
            font-size: 3rem; 
            font-weight: 900; 
            line-height: 1; 
            letter-spacing: -0.05em; 
        }
        .summary-unit {
            font-size: 1.25rem; 
            font-weight: 500; 
            margin-left: 0.5rem; 
            line-height: 1;
        }

        /* Gaya Khusus untuk Header (memastikan kontras) */
        #main-header-content {
             background-color: #05050D;
        }

        /* Gaya Minimal UI (untuk mobile fullscreen imitasi) */
        .header-hidden, .footer-hidden {
            opacity: 0;
            height: 0;
            padding: 0 !important;
            margin: 0 !important;
            transition: opacity 0.3s ease, height 0.3s ease;
            overflow: hidden;
        }

        /* Gaya Canvas */
        #realtime-chart-container {
            /* TINGGI MINIMAL AGAR BOX TERLIHAT BESAR */
            min-height: 350px; /* Tentukan tinggi minimum untuk mobile dan desktop */
            height: 350px;     /* Tentukan tinggi tetap */
            width: 100%;
            padding-bottom: 5px; /* PADDING DI BAWAH CHART DIKURANGI */
        }
        
        /* Gaya Fullscreen */
        .fullscreen-chart {
            position: fixed;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            background-color: #05050D !important; /* Dibuat OPAQUE agar tidak transparan di HP */
            z-index: 9999;
            padding: 20px;
        }
        
        /* Gaya Kartu Daya Kecil */
        .power-summary-card {
            background-color: rgba(40, 40, 70, 0.3);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 bg-bg-main">
    
    <!-- Modal Kustom untuk Konfirmasi Navigasi -->
    <div id="custom-modal" class="fixed inset-0 hidden items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.85); z-index: 1000;">
        <div id="modal-content" class="rounded-xl p-6 shadow-2xl max-w-sm w-full bg-slate-800">
            <h3 class="text-xl font-bold text-white mb-3">Konfirmasi Navigasi</h3>
            <p id="modal-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-semibold rounded-lg text-gray-400 hover:bg-gray-700 transition">Batal</button>
                <button id="modal-confirm-button" onclick="" class="px-4 py-2 text-sm font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">Lanjutkan</button>
            </div>
        </div>
    </div>


    <!-- Header & Status Jam -->
    <header id="app-header" class="mb-6">
        <div id="main-header-content" class="flex flex-col md:flex-row justify-between items-start">
              <!-- Konten Kiri (Judul) -->
            <div>
                <h1 class="text-3xl sm:text-4xl font-extrabold text-white tracking-tight">
                    AEPRO PLTS ONLINE
                </h1>
                <p class="text-gray-400 mt-1">Monitor Kinerja dan Performa Sistem PLTS.</p>
            </div>
              <!-- Konten Kanan (Jam) -->
            <div class="mt-4 md:mt-0 relentlessly-right flex items-center space-x-4">
                <div class="hidden md:block">
                    <p id="current-date" class="text-sm text-gray-400"></p>
                    <p id="current-time" class="text-3xl font-bold text-white"></p>
                </div>
                
                <!-- Tombol Navigasi dan Logout di DESKTOP (HANYA terlihat di md: dan lebih besar) -->
                <div id="desktop-buttons" class="hidden md:flex space-x-3 items-center">
                     <button id="bms-button-desktop" onclick="handleBMSNavigation()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-xl shadow-md hover:bg-blue-700 transition duration-300 flex items-center">
                        <i data-lucide="battery-full" class="lucide w-5 h-5 mr-1"></i>
                        Detail Baterai
                    </button>
                    <button id="logout-button" onclick="logoutAndClear()" class="bg-red-600 text-white font-bold py-2 px-4 rounded-xl shadow-md hover:bg-red-700 transition duration-300 flex items-center">
                        <i data-lucide="log-out" class="lucide w-5 h-5 mr-1"></i>
                        Hentikan
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tombol Navigasi MOBILE (HANYA terlihat di bawah md: breakpoint) -->
        <div id="mobile-buttons" class="hidden md:hidden w-full grid grid-cols-3 gap-3 mb-6 mt-4">
             <button id="bms-button-mobile" onclick="handleBMSNavigation()" class="bg-blue-600 text-white font-bold py-2.5 rounded-xl shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                <i data-lucide="battery-full" class="lucide w-5 h-5 mr-2"></i>
                BMS
            </button>
            <button id="fullscreen-button-mobile" onclick="toggleMinimalUI()" class="bg-gray-700 text-white font-bold py-2.5 rounded-xl shadow-md hover:bg-gray-600 transition duration-300 flex items-center justify-center">
                <i id="fullscreen-icon" data-lucide="minimize-2" class="lucide w-5 h-5 mr-2"></i>
                <span id="fullscreen-text">Full Layar</span>
            </button>
            <button id="logout-button-mobile" onclick="logoutAndClear()" class="bg-red-600 text-white font-bold py-2.5 rounded-xl shadow-md hover:bg-red-700 transition duration-300 flex items-center justify-center">
                 <i data-lucide="log-out" class="lucide w-5 h-5 mr-2"></i> 
                 Hentikan
            </button>
        </div>
    </header>

    <!-- Area Input Konfigurasi -->
    <div id="config-panel" class="solar-card p-6 rounded-xl shadow-xl mb-8">
        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
            <i data-lucide="settings" class="lucide w-5 h-5 mr-2 text-blynk-primary"></i>
            Konfigurasi API & Kalibrasi
        </h2>
        
        <!-- Input Server dan Token (2 kolom) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label for="server-ip" class="block text-sm font-medium text-gray-300 mb-1">IP Server / Domain </label>
                <input type="text" id="server-ip" placeholder="contoh: iot.server.com:9443" class="w-full p-2.5 rounded-xl bg-slate-700 text-white border-none focus:ring-blynk-primary focus:border-blynk-primary" value="iot.serangkota.go.id:9443">
            </div>
            <div>
                <label for="auth-token" class="block text-sm font-medium text-gray-300 mb-1">Auth Token</label>
                <input type="text" id="auth-token" placeholder="Masukkan token Anda" class="w-full p-2.5 rounded-xl bg-slate-700 text-white border-none focus:ring-blynk-primary focus:border-blynk-primary">
            </div>
        </div>

        <!-- Input Kalibrasi dan Tombol Mulai (4 Kolom untuk 2 Kalibrasi + 1 Tombol) -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
             <!-- Koreksi Energi PV Harian (V10) -->
            <div class="md:col-span-1 lg:col-span-2">
                 <label for="energy-percent" class="block text-sm font-medium text-gray-300 mb-1" title="Mengoreksi Energi PV Harian (V10). Positif untuk menambah.">Koreksi PV Harian (%)</label>
                <!-- DITAMBAHKAN TANDA PLUS PADA PLACEHOLDER -->
                <input type="number" step="0.1" id="energy-percent" placeholder="contoh: +10.0" class="w-full p-2.5 rounded-xl bg-slate-700 text-white border-none focus:ring-dc-color focus:border-dc-color" value="0.0">
            </div>
            <!-- Koreksi Beban AC Harian (V21) - BARU -->
            <div class="md:col-span-1 lg:col-span-2">
                 <label for="energy-load-percent" class="block text-sm font-medium text-gray-300 mb-1" title="Mengoreksi Beban AC Harian (V21). Positif untuk menambah.">Koreksi Beban AC (%)</label>
                <!-- DITAMBAHKAN TANDA PLUS PADA PLACEHOLDER -->
                <input type="number" step="0.1" id="energy-load-percent" placeholder="contoh: +5.0" class="w-full p-2.5 rounded-xl bg-slate-700 text-white border-none focus:ring-ac-color focus:border-ac-color" value="0.0">
            </div>
            <!-- Tombol Mulai -->
            <div class="md:col-span-1 lg:col-span-1 flex items-end">
                <button onclick="saveAndFetchData()" class="w-full bg-blynk-primary text-white font-bold py-2.5 rounded-xl shadow-md hover:bg-blue-600 transition duration-300">
                    Mulai Monitoring
                </button>
            </div>
        </div>
        <p id="message-box" class="mt-4 text-sm text-yellow-400 hidden"></p>
    </div>

    <!-- Area Monitoring Utama -->
    <main id="monitoring-dashboard" class="hidden">

        <!-- RINGKASAN UTAMA (4 Kartu Besar Sesuai Screenshot) -->
        <h2 class="text-xl font-semibold text-gray-300 mb-4 mt-8">Ringkasan Kinerja Hari Ini</h2>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            
            <!-- V10: ENERGI PV HARI INI (Produksi DC) -->
            <div class="solar-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-sm font-semibold text-gray-400">Energi Hari Ini (Terkoreksi)</p>
                    <i data-lucide="sun" class="lucide w-7 h-7 text-dc-color"></i>
                </div>
                <div class="summary-block">
                    <!-- Nilai di Screenshot: 15.4 kWh -->
                    <span id="v10-kwh-today" class="data-value summary-value text-dc-color loading-animation">...</span>
                    <span id="v10-kwh-today-unit" class="summary-unit text-dc-color"></span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Total produksi DC hari ini (kWh).</p>
            </div>
            
            <!-- V21: BEBAN HARI INI (Konsumsi AC) -->
            <div class="solar-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-sm font-semibold text-gray-400">Beban Hari Ini (Terkoreksi)</p>
                    <i data-lucide="power-square" class="lucide w-7 h-7 text-ac-color"></i>
                </div>
                <div class="summary-block">
                    <!-- Nilai di Screenshot: 14.2 kWh -->
                    <span id="v21-kwh-today-ac" class="data-value summary-value text-ac-color loading-animation">...</span>
                    <span id="v21-kwh-today-ac-unit" class="summary-unit text-ac-color"></span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Total konsumsi AC hari ini (kWh).</p>
            </div>

            <!-- V19: PENGHEMATAN HARI INI (Rupiah) -->
            <div class="solar-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-sm font-semibold text-gray-400 ">Penghematan Hari Ini</p>
                    <i data-lucide="file-text" class="lucide w-7 h-7 text-green-400"></i>
                </div>
                <div class="summary-block">
                    <!-- Nilai di Screenshot: Rp 20.500 -->
                    <span class="text-2xl text-gray-400 mr-1 font-bold">Rp</span>
                    <span id="v19-rupiah-day" class="data-value summary-value !text-3xl text-green-400 loading-animation !tracking-normal">...</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Perkiraan biaya yang dihemat hari ini.</p>
            </div>

            <!-- V18: TOTAL PENGHEMATAN (Rupiah Akumulasi) - GANTI WARNA PINK -->
            <div class="solar-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-sm font-semibold text-gray-400 ">Penghematan Bulan Ini</p>
                    <i data-lucide="trending-up" class="lucide w-7 h-7 text-pink-med"></i>
                </div>
                <div class="summary-block">
                     <!-- Nilai di Screenshot: Rp 246.198 -->
                    <span class="text-2xl text-gray-400 mr-1 font-bold">Rp</span>
                    <!-- PERUBAHAN WARNA DISINI (text-pink-med) -->
                    <span id="v18-rupiah-total" class="data-value summary-value !text-3xl text-pink-med loading-animation !tracking-normal">...</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Akumulasi biaya yang dihemat.</p>
            </div>
        </div>

        <!-- GRAFIK DAYA & KARTU KECIL (4 Kartu Di Bawah Header Grafik) -->
        <h2 class="text-xl font-semibold text-gray-300 mb-4 mt-8">Grafik Daya</h2>
        
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <!-- V2: PV Power (Input) -->
            <div class="power-summary-card">
                <p class="text-sm text-gray-400">Daya PV (Input)</p>
                <div class="flex items-baseline mt-1">
                    <!-- Nilai di Screenshot: 0 W -->
                    <span id="v2-pzem-power-chart" class="text-2xl font-bold text-dc-color loading-animation">...</span>
                    <span id="v2-pzem-power-chart-unit" class="text-base text-dc-color ml-1"></span>
                </div>
                 <p class="text-xs text-gray-500 mt-1" id="v2-status-time">Status 00:00:00</p>
            </div>
            <!-- V14: Beban AC (Output) -->
            <div class="power-summary-card">
                <p class="text-sm text-gray-400">Beban AC (Output)</p>
                <div class="flex items-baseline mt-1">
                    <!-- Nilai di Screenshot: 0 W -->
                    <span id="v14-power-chart" class="text-2xl font-bold text-ac-color loading-animation">...</span>
                    <span id="v14-power-chart-unit" class="text-base text-ac-color ml-1"></span>
                </div>
                 <p class="text-xs text-gray-500 mt-1" id="v14-status-time">Status 00:00:00</p>
            </div>
             <!-- V22: Self-Consumption (%) - PIN DIHAPUS, DIHITUNG LOKAL -->
            <div class="power-summary-card">
                <p class="text-sm text-gray-400">Self-Consumption</p>
                <div class="flex items-baseline mt-1">
                    <!-- Nilai di Screenshot: 0% -->
                    <span id="self-consumption-calc" class="text-2xl font-bold text-chart-self-consumption loading-animation">...</span>
                    <span id="self-consumption-calc-unit" class="text-base text-chart-self-consumption ml-1">%</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Daya PV yang digunakan beban.</p>
            </div>
            <!-- V23: Potensi Surplus (W) - PIN DIHAPUS, DIHITUNG LOKAL -->
            <div class="power-summary-card">
                <p class="text-sm text-gray-400">Potensi Surplus</p>
                <div class="flex items-baseline mt-1">
                    <!-- Nilai di Screenshot: 0 W -->
                    <span id="potensi-surplus-calc" class="text-2xl font-bold text-chart-surplus loading-animation">...</span>
                    <span id="potensi-surplus-calc-unit" class="text-base text-chart-surplus ml-1">W</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Daya PV yang berlebih.</p>
            </div>
        </div>

        <!-- GRAFIK ENERGI HISTORIS (CHART.JS) -->
        <div class="solar-card p-4 sm:p-6"> <!-- Padding kartu grafik dikurangi di sini -->
            <!-- Tombol Full Layar & Reset Zoom -->
            <div class="flex justify-end space-x-3 mb-2"> <!-- Margin di bawah tombol dikurangi -->
                <button onclick="resetChartZoom()" class="px-3 py-1 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition flex items-center">
                    <i data-lucide="rotate-ccw" class="lucide w-4 h-4 mr-1"></i>
                    Reset Zoom
                </button>
                <button onclick="toggleFullscreen()" class="px-3 py-1 text-xs font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition flex items-center space-x-1">
                    <i id="fullscreen-chart-icon" data-lucide="maximize" class="lucide w-4 h-4"></i>
                    <span id="fullscreen-chart-text">Full Layar</span>
                </button>
            </div>

            <div id="realtime-chart-container" class="w-full">
                <canvas id="realtime-power-chart"></canvas>
            </div>
        </div>
        
        <!-- DETAIL MONITORING (DC dan AC) -->
        <h2 class="text-xl font-semibold text-gray-300 mb-4 mt-8">Detail Sistem</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Kolom 1: Panel Surya (DC) -->
            <div class="solar-card">
                <h3 class="text-xl font-semibold text-dc-color mb-4 flex items-center border-b border-gray-700 pb-2">
                    <i data-lucide="panel-top-open" class="lucide w-5 h-5 mr-2 text-dc-color"></i>
                    Panel Surya (DC)
                </h3 >
                <div>
                    <!-- V1: Current DC -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="activity" class="lucide w-4 h-4 mr-3 text-dc-color"></i>
                            Arus PV
                        </div>
                        <div class="flex items-baseline text-dc-color nominal-color">
                            <span id="v1-pzem-current" class="text-xl font-bold loading-animation">...</span>
                            <span id="v1-pzem-current-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    <!-- V6: PV Peak -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="mountain" class="lucide w-4 h-4 mr-3 text-orange-red"></i>
                            PV Peak
                        </div>
                        <div class="flex items-baseline text-orange-red nominal-color">
                            <span id="v6-pv-peak" class="text-xl font-bold loading-animation">...</span>
                            <span id="v6-pv-peak-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    <!-- V5: PV Persen -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="percent" class="lucide w-4 h-4 mr-3 text-dc-color"></i>
                            Eefisiensi PV
                        </div>
                        <div class="flex items-baseline text-dc-color nominal-color">
                            <span id="v5-pv-persen" class="text-xl font-bold loading-animation">...</span>
                            <span id="v5-pv-persen-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    <!-- V4: SunHour (PINDAH DARI BATERAI) -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="clock" class="lucide w-4 h-4 mr-3 text-dc-color"></i>
                            Matahari Efektif
                        </div>
                        <div class="flex items-baseline text-dc-color nominal-color">
                            <span id="v4-sunhour" class="text-xl font-bold loading-animation">...</span>
                            <span id="v4-sunhour-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    
<!-- V11: Total PV (Total Lifetime Energy) -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="layers-3" class="lucide w-4 h-4 mr-3 text-dc-color"></i>
                            Max Energi PV
                        </div>
                        <div class="flex items-baseline text-dc-color nominal-color">
                            <span id="v11-total-pv" class="text-xl font-bold loading-animation">...</span>
                            <span id="v11-total-pv-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
               </div>
            </div>
            <!-- Kolom 2: Baterai & Total Energi -->
            <div class="solar-card">
                <h3 class="text-xl font-semibold text-blue-bat mb-4 flex items-center border-b border-gray-700 pb-2">
                    <i data-lucide="battery-full" class="lucide w-5 h-5 mr-2 text-blue-bat"></i>
                    Baterai & Energi
                </h3 >
                <div>
                    <!-- V0: BUS VOLTAGE (PINDAH DARI PANEL SURYA) -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                             <i data-lucide="bolt" class="lucide w-4 h-4 mr-3 text-pink-med"></i>
                             Bus Voltase
                        </div>
                        <div class="flex items-baseline text-pink-med nominal-color">
                            <span id="v0-pzem-voltage" class="text-xl font-bold loading-animation">...</span>
                            <span id="v0-pzem-voltage-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    <!-- V7: Baterai Peak -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="battery-full" class="lucide w-4 h-4 mr-3 text-blue-bat"></i>
                            Baterai Max
                        </div>
                        <div class="flex items-baseline text-blue-bat nominal-color">
                            <span id="v7-batere-peak" class="text-xl font-bold loading-animation">...</span>
                            <span id="v7-batere-peak-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    <!-- V8: Baterai Low (KRITIS: MERAH) -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="battery-low" class="lucide w-4 h-4 mr-3 text-warning-red"></i>
                            Baterai Low
                        </div>
                        <div class="flex items-baseline text-warning-red nominal-color">
                            <span id="v8-batere-low" class="text-xl font-bold loading-animation">...</span>
                            <span id="v8-batere-low-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    <!-- V9: Baterai AH -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="battery-medium" class="lucide w-4 h-4 mr-3 text-blue-bat"></i>
                            Kapasitas Baterai
                        </div>
                        <div class="flex items-baseline text-blue-bat nominal-color">
                            <span id="v9-batere-ah" class="text-xl font-bold loading-animation">...</span>
                            <span id="v9-batere-ah-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    <!-- V3: Total Energy DC -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="gauge" class="lucide w-4 h-4 mr-3 text-dc-color"></i>
                            Total Energi DC
                        </div>
                        <div class="flex items-baseline text-dc-color nominal-color">
                            <span id="v3-pzem-energy" class="text-xl font-bold loading-animation">...</span>
                            <span id="v3-pzem-energy-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kolom 3: INVERTER & Beban (AC) -->
            <div class="solar-card">
                <h3 class="text-xl font-semibold text-ac-color mb-4 flex items-center border-b border-gray-700 pb-2">
                    <i data-lucide="plug-zap" class="lucide w-5 h-5 mr-2 text-ac-color"></i>
                   Inverter & Beban (AC)
                </h3>
                <div>
                    <!-- V12: Voltage AC -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="bolt" class="lucide w-4 h-4 mr-3 text-ac-color"></i>
                            Tegangan AC 
                        </div>
                        <div class="flex items-baseline text-ac-color nominal-color">
                            <span id="v12-voltage" class="text-xl font-bold loading-animation">...</span>
                            <span id="v12-voltage-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    <!-- V13: Current AC -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="activity" class="lucide w-4 h-4 mr-3 text-ac-color"></i>
                            Arus AC
                        </div>
                        <div class="flex items-baseline text-ac-color nominal-color">
                            <span id="v13-current" class="text-xl font-bold loading-animation">...</span>
                            <span id="v13-current-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    
                    <!-- V16: Frequency -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="refresh-cw" class="lucide w-4 h-4 mr-3 text-pink-med"></i>
                            Frequensi
                        </div>
                        <div class="flex items-baseline text-pink-med nominal-color">
                            <span id="v16-frequency" class="text-xl font-bold loading-animation">...</span>
                            <span id="v16-frequency-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    <!-- V20: Inverter Peak (PUNCAK: MERAH) -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="maximize-2" class="lucide w-4 h-4 mr-3 text-warning-red"></i>
                            Inverter Peak
                        </div>
                        <div class="flex items-baseline text-warning-red nominal-color">
                            <span id="v20-inverter-peak" class="text-xl font-bold loading-animation">...</span>
                            <span id="v20-inverter-peak-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                   <!-- V15: Energy AC -->
                    <div class="detail-item">
                        <div class="flex items-center metric-title text-white">
                            <i data-lucide="layers-3" class="lucide w-4 h-4 mr-3 text-ac-color"></i>
                            Total Energi AC
                        </div>
                        <div class="flex items-baseline text-ac-color nominal-color">
                            <span id="v15-energy" class="text-xl font-bold loading-animation">...</span>
                            <span id="v15-energy-unit" class="text-base ml-1"></span>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer id="app-footer" class="mt-8 text-center text-gray-500 text-sm py-4">
        <p>Dibuat oleh AEPRO PLTS.</p>
    </footer>

    <!-- Script Fungsionalitas -->
    <script>
        // Mengubah semua ikon Lucide menjadi SVG
        lucide.createIcons();

        // --- KONSTANTA KEAMANAN ---
        // Hash (Sidik Jari) yang dihasilkan dari konten di dalam tag <style>
        // Setiap perubahan pada CSS akan mengubah hash ini, memicu pelanggaran.
        const VALID_DESIGN_HASH = '39385039e6cb65cc7ca6931bb94bde0530a667ed44a97b6232e318f4f96273bf'; 
        const HASH_ERROR_MESSAGE = 'Pelanggaran Integritas Desain Dideteksi. Fungsi Monitoring Dinonaktifkan.';
        
        // --- Fungsi HASHING (SHA-256 Sederhana) ---
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        /**
         * Mengambil konten CSS dan membandingkannya dengan hash yang valid.
         * Ini adalah metode teknis untuk melindungi desain.
         */
        async function checkDesignIntegrity() {
            try {
                // Ambil konten dari tag <style> kedua (style khusus)
                const styleContent = document.getElementsByTagName('style')[0].textContent.trim();
                
                // Hapus komentar dan whitespace yang tidak perlu untuk stabilitas hash
                const normalizedContent = styleContent
                    .replace(/\/\*[\s\S]*?\*\/|([^\\:])\/\/.*/g, '')
                    .replace(/\s+/g, '') 
                    .toLowerCase();
                
                const currentHash = await sha256(normalizedContent);

                if (currentHash === VALID_DESIGN_HASH) {
                    return true;
                } else {
                    console.error("DESIGN INTEGRITY FAILURE: HASH MISMATCH", currentHash);
                    return false;
                }
            } catch (e) {
                console.error("Integrity check failed during execution:", e);
                return false;
            }
        }
        // --- AKHIR BLOK KEAMANAN ---

        // Daftar V-Pin dan ID elemen HTML yang sesuai
        const PIN_MAPPINGS = {
            // Mapping Pin ke ID (Format: PIN: ID_dasar)
            
            // --- RINGKASAN UTAMA ---
            'V10': 'v10-kwh-today',    // Energi PV Hari Ini
            'V21': 'v21-kwh-today-ac', // Beban Hari Ini
            'V19': 'v19-rupiah-day',   // Penghematan Hari Ini
            'V18': 'v18-rupiah-total', // TOTAL PENGHEMATAN

            // --- GRAFIK DAYA (4 Kartu Kecil) ---
            'V2': 'v2-pzem-power-chart',    // Daya PV (Input)
            'V14': 'v14-power-chart',       // Beban AC (Output)
            
            // --- DETAIL DC ---
            'V0': 'v0-pzem-voltage',
            'V1': 'v1-pzem-current',
            'V6': 'v6-pv-peak',
            'V5': 'v5-pv-persen',
            
            // --- DETAIL BATERAI & ENERGY ---
            'V7': 'v7-batere-peak',
            'V8': 'v8-batere-low',
            'V9': 'v9-batere-ah',
            'V4': 'v4-sunhour',
            'V3': 'v3-pzem-energy',
            'V11': 'v11-total-pv',

            // --- DETAIL AC & BIAYA ---
            'V12': 'v12-voltage',
            'V13': 'v13-current',
            'V15': 'v15-energy',
            'V16': 'v16-frequency',
            'V20': 'v20-inverter-peak',
            'V17': 'v17-pf',
        };

        const STORAGE_KEY_TOKEN = 'blynk_auth_token';
        const STORAGE_KEY_IP = 'blynk_server_ip';
        const STORAGE_KEY_CHART_DATA = 'aepro_plts_chart_data'; 
        const STORAGE_KEY_PV_PERCENT = 'energy_pv_calibration_percent'; // Kunci persentase PV
        const STORAGE_KEY_LOAD_PERCENT = 'energy_load_calibration_percent'; // Kunci persentase BEBAN
        const UPDATE_INTERVAL = 5000; // 5 detik

        let fetchInterval = null; 
        let serverIp = '';
        let authToken = '';
        let ENERGY_CALIBRATION_PERCENT = 0.0; // Persentase PV (V10)
        let LOAD_CALIBRATION_PERCENT = 0.0; // Persentase Beban (V21)
        
        let isMinimalUI = false;
        let isDesignValid = true; // State integritas desain

        // --- Variabel Global untuk Chart ---
        let energyChartInstance = null;
        const MAX_DATA_POINTS = 17280; 

        window.realtimeData = { 
            labels: [],
            pvPower: [],
            acLoad: []
        };
        
        /**
         * Memuat data historis dari Local Storage saat inisialisasi.
         */
        function loadHistoricalData() {
            const savedData = localStorage.getItem(STORAGE_KEY_CHART_DATA);
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    const startIndex = Math.max(0, parsedData.labels.length - MAX_DATA_POINTS);
                    
                    window.realtimeData.labels = parsedData.labels.slice(startIndex);
                    window.realtimeData.pvPower = parsedData.pvPower.slice(startIndex);
                    window.realtimeData.acLoad = parsedData.acLoad.slice(startIndex);

                    console.log(`[CHART] Memuat ${window.realtimeData.labels.length} titik data historis.`);
                } catch (e) {
                    console.error("Gagal memuat data chart historis:", e);
                    localStorage.removeItem(STORAGE_KEY_CHART_DATA);
                }
            }
        }
        
        /**
         * Menyimpan data historis ke Local Storage setiap kali ada update.
         */
        function saveHistoricalData() {
            localStorage.setItem(STORAGE_KEY_CHART_DATA, JSON.stringify(window.realtimeData));
        }
        
        // --- FUNGSI UNTUK KALIBRASI PERSENTASE ENERGI ---
        function loadCalibrationPercent() {
            const savedPvPercent = localStorage.getItem(STORAGE_KEY_PV_PERCENT);
            const savedLoadPercent = localStorage.getItem(STORAGE_KEY_LOAD_PERCENT);

            const pvPercentInput = document.getElementById('energy-percent');
            const loadPercentInput = document.getElementById('energy-load-percent');
            
            // PV Calibration (V10)
            if (savedPvPercent !== null && !isNaN(parseFloat(savedPvPercent))) {
                ENERGY_CALIBRATION_PERCENT = parseFloat(savedPvPercent);
                pvPercentInput.value = ENERGY_CALIBRATION_PERCENT.toFixed(1);
            } else {
                 ENERGY_CALIBRATION_PERCENT = 0.0;
                 pvPercentInput.value = '0.0';
            }

            // Load Calibration (V21)
            if (savedLoadPercent !== null && !isNaN(parseFloat(savedLoadPercent))) {
                LOAD_CALIBRATION_PERCENT = parseFloat(savedLoadPercent);
                loadPercentInput.value = LOAD_CALIBRATION_PERCENT.toFixed(1);
            } else {
                 LOAD_CALIBRATION_PERCENT = 0.0;
                 loadPercentInput.value = '0.0';
            }
        }
        
        function saveCalibrationPercent(pvPercentValue, loadPercentValue) {
            localStorage.setItem(STORAGE_KEY_PV_PERCENT, pvPercentValue);
            localStorage.setItem(STORAGE_KEY_LOAD_PERCENT, loadPercentValue);

            ENERGY_CALIBRATION_PERCENT = parseFloat(pvPercentValue);
            LOAD_CALIBRATION_PERCENT = parseFloat(loadPercentValue);

            showMessage(`Koreksi PV Harian: ${pvPercentValue}% dan Koreksi Beban AC: ${loadPercentValue}% berhasil disimpan.`, 'success');
        }


        /**
         * Utility untuk membuat jeda (delay)
         */
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

        /**
         * Menampilkan jam real-time
         */
        function updateTime() {
            const now = new Date();
            const dateOptions = { day: 'numeric', month: 'short', year: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            
            document.getElementById('current-date').textContent = now.toLocaleDateString('id-ID', dateOptions);
            document.getElementById('current-time').textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            const timeOnly = now.toLocaleTimeString('id-ID', timeOptions);
            
            document.getElementById('v2-status-time').textContent = `Status ${timeOnly}`;
            document.getElementById('v14-status-time').textContent = `Status ${timeOnly}`;
        }

        /**
         * Menampilkan pesan notifikasi
         */
        function showMessage(message, type = 'warning') {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = 'mt-4 w-full text-sm font-semibold p-3 rounded-xl block'; 
            msgBox.classList.remove('bg-red-900', 'text-red-300', 'bg-green-900', 'text-green-300', 'bg-yellow-900', 'text-yellow-300'); 

            if (type === 'error') {
                msgBox.classList.add('bg-red-900', 'text-red-300');
            } else if (type === 'success') {
                msgBox.classList.add('bg-green-900', 'text-green-300');
            } else {
                msgBox.classList.add('bg-yellow-900', 'text-yellow-300');
            }
        }
        
        /**
         * Menampilkan Modal Kustom
         */
        function showModal(text, confirmAction) {
            const modal = document.getElementById('custom-modal');
            const modalText = document.getElementById('modal-text');
            const confirmButton = document.getElementById('modal-confirm-button');
            
            modalText.textContent = text;
            confirmButton.onclick = function() {
                closeModal();
                confirmAction();
            };
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        /**
         * Menutup Modal Kustom
         */
        function closeModal() {
            document.getElementById('custom-modal').classList.add('hidden');
            document.getElementById('custom-modal').classList.remove('flex');
        }

        function handleBMSNavigation() {
            saveHistoricalData(); 
            window.location.href = 'bms_monitoring.html'; 
        }
        
        function toggleMinimalUI() {
            const header = document.getElementById('app-header');
            const footer = document.getElementById('app-footer');
            const icon = document.getElementById('fullscreen-icon');
            const text = document.getElementById('fullscreen-text');

            isMinimalUI = !isMinimalUI;

            if (isMinimalUI) {
                header.classList.add('header-hidden');
                footer.classList.add('footer-hidden');
                icon.setAttribute('data-lucide', 'maximize-2');
                text.textContent = 'Normal UI';
            } else {
                header.classList.remove('header-hidden');
                footer.classList.remove('footer-hidden');
                icon.setAttribute('data-lucide', 'minimize-2');
                text.textContent = 'Full Layar';
            }
            lucide.createIcons();
        }

        // Polyfill untuk Fullscreen (dihilangkan untuk brevity)
        function requestFullscreen(element) {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.mozRequestFullScreen) { 
                element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) { 
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) { 
                element.msRequestFullscreen();
            }
        }

        // Polyfill untuk keluar Fullscreen (dihilangkan untuk brevity)
        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) { 
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) { 
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { 
                document.msExitFullscreen();
            }
        }

        function toggleFullscreen() {
            const chartCard = document.getElementById('realtime-chart-container').parentElement;
            
            const isFullscreenNative = document.fullscreenElement || 
                                 document.mozFullScreenElement || 
                                 document.webkitFullscreenElement || 
                                 document.msFullscreenElement;

            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                if (chartCard.classList.contains('fullscreen-chart')) {
                    chartCard.classList.remove('fullscreen-chart');
                     if (screen.orientation && screen.orientation.unlock) {
                        screen.orientation.unlock(); 
                    }
                } else {
                    chartCard.classList.add('fullscreen-chart');
                     if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('landscape').catch(e => {});
                    }
                }
                handleFullscreenChange();
                return;
            } 
            
            if (!isFullscreenNative) {
                requestFullscreen(chartCard);
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(e => {});
                }
            } else {
                exitFullscreen();
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            }
        }


        function handleFullscreenChange() {
            const chartCard = document.getElementById('realtime-chart-container').parentElement;
            const chartIcon = document.getElementById('fullscreen-chart-icon');
            const chartText = document.getElementById('fullscreen-chart-text');
            
            const isFullscreen = chartCard.classList.contains('fullscreen-chart') || document.fullscreenElement;

            if (isFullscreen) {
                chartIcon.setAttribute('data-lucide', 'minimize');
                chartText.textContent = 'Keluar';
            } else {
                chartIcon.setAttribute('data-lucide', 'maximize');
                chartText.textContent = 'Full Layar';
            }
            
            lucide.createIcons();
            if (energyChartInstance) {
                setTimeout(() => {
                    energyChartInstance.resize();
                    energyChartInstance.resetZoom(); 
                }, 50); 
            }
        }
        
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('msfullscreenchange', handleFullscreenChange);


        /**
         * Merender grafik energi real-time
         */
        function renderRealtimeChart() {
            const ctx = document.getElementById('realtime-power-chart').getContext('2d');
            
            const dataConfig = {
                labels: window.realtimeData.labels,
                datasets: [
                    {
                        label: 'PV Power (W)',
                        data: window.realtimeData.pvPower,
                        backgroundColor: 'rgba(191, 255, 0, 0.2)', 
                        borderColor: tailwind.config.theme.extend.colors['chart-pv'],
                        borderWidth: 2,
                        type: 'line',
                        fill: 'origin', 
                        tension: 0.2, 
                        pointRadius: 0, 
                        yAxisID: 'y'
                    },
                    {
                        label: 'AC Load (W)',
                        data: window.realtimeData.acLoad,
                        backgroundColor: 'rgba(255, 185, 0, 0.2)', 
                        borderColor: tailwind.config.theme.extend.colors['chart-load'],
                        borderWidth: 2,
                        type: 'line',
                        fill: false, 
                        tension: 0.2, 
                        pointRadius: 0, 
                        yAxisID: 'y'
                    }
                ]
            };

            if (energyChartInstance) {
                energyChartInstance.destroy();
            }

            energyChartInstance = new Chart(ctx, {
                type: 'line',
                data: dataConfig,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, 
                    spanGaps: true, 
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#FFFFFF',
                                usePointStyle: true,
                            }
                        },
                        title: {
                            display: true,
                            text: 'Perbandingan Daya PV vs Beban AC (24 Jam Terakhir)',
                            color: '#FFFFFF'
                        },
                        tooltip: {
                             backgroundColor: 'rgba(20, 20, 48, 0.8)',
                             titleColor: '#FFFFFF',
                             bodyColor: '#BFFF00',
                             borderColor: 'rgba(71, 85, 105, 0.5)',
                             borderWidth: 1
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x', 
                            },
                            zoom: {
                                wheel: {
                                    enabled: true, 
                                },
                                pinch: {
                                    enabled: true 
                                },
                                mode: 'x', 
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category', 
                            title: {
                                display: true,
                                text: 'Waktu',
                                color: '#AAAAAA'
                            },
                            ticks: { 
                                color: '#AAAAAA',
                                autoSkip: true,
                                maxRotation: 0,
                                maxTicksLimit: 12
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            min: 0, 
                            max: 7000, 
                            ticks: {
                                color: '#FFFFFF',
                                callback: function(value) {
                                    return value + ' W';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Daya (Watt)',
                                color: '#FFFFFF'
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }
        
        function resetChartZoom() {
            if (energyChartInstance) {
                energyChartInstance.resetZoom();
            }
        }
        
        function updateRealtimeChartData(pvValue, acValue) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString('id-ID');

            if (window.realtimeData.labels.length >= MAX_DATA_POINTS) {
                window.realtimeData.labels.shift();
                window.realtimeData.pvPower.shift();
                window.realtimeData.acLoad.shift();
            }

            window.realtimeData.labels.push(timeLabel);
            window.realtimeData.pvPower.push(pvValue);
            window.realtimeData.acLoad.push(acValue);

            if (energyChartInstance) {
                energyChartInstance.update();
            }
            
            saveHistoricalData();
        }


        /**
         * Mengambil nilai dari satu V-Pin dari server Blynk dengan Retry (Exponential Backoff)
         */
        async function fetchPinValue(pin) {
             // Jika desain tidak valid, hentikan fetch data
            if (!isDesignValid) {
                throw new Error("Design integrity compromised. Fetch blocked.");
            }
            
            let host = serverIp;

            let protocol = 'https'; 
            const defaultPort = '8080';
            
            if (!host.includes(':')) {
                host = `${host}:${defaultPort}`;
            }

            if (serverIp.includes('blynk.cloud')) {
                protocol = 'https';
            } else if (!serverIp.includes(':')) {
                host = `${serverIp}:8080`;
                protocol = 'http'; 
            }
            
            if (protocol === 'http' && window.location.protocol === 'https:') {
                protocol = 'https'; 
            }
            
            const url = `${protocol}://${host}/${authToken}/get/${pin}`;
            
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Status: ${response.status} (${response.statusText})`);
                    }
                    const data = await response.json();
                    return data[0]; 
                } catch (error) {
                    if (i < maxRetries - 1) {
                        const delayTime = Math.pow(2, i) * 1000; 
                        await delay(delayTime);
                    } else {
                        console.error(`[ERROR PIN ${pin}] Gagal setelah ${maxRetries} percobaan. URL: ${url}`, error);
                        throw new Error("Failed to fetch (Check IP/Token/CORS)");
                    }
                }
            }
        }

        /**
         * Fungsi untuk memformat nilai berdasarkan kebutuhan pin (TERMASUK KALIBRASI PERSENTASE)
         */
        function formatValue(pin, value) {
            let numericValue = parseFloat(value);
            if (isNaN(numericValue)) return 'N/A';
            
            // --- LOGIC KALIBRASI PERSENTASE ---
            if (pin === 'V10') {
                 // PV Energy (V10)
                 const correctionFactor = 1 + (ENERGY_CALIBRATION_PERCENT / 100);
                 numericValue *= correctionFactor;
            } else if (pin === 'V21') {
                 // Load Energy (V21)
                 const correctionFactor = 1 + (LOAD_CALIBRATION_PERCENT / 100);
                 numericValue *= correctionFactor;
            }
            // --- AKHIR LOGIC KALIBRASI PERSENTASE ---


            // Pin yang harus diformat sebagai Bilangan Bulat (tanpa desimal)
            const integerPins = ['V11', 'V6', 'V12', 'V16', 'V15', 'V20'];

            // Pin yang harus diformat sebagai Rupiah (tanpa desimal)
            const rupiahPins = ['V18', 'V19'];
            
            // Pin yang harus diformat sebagai daya/energi di ringkasan (1 desimal)
            const summaryEnergyPins = ['V10', 'V21'];
            
            // Pin Daya Chart (V2, V14) -> Integer
            const chartPowerPins = ['V2', 'V14'];


            if (rupiahPins.includes(pin)) {
                return Math.max(0, numericValue).toLocaleString('id-ID', {
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 0
                });
            }
            
            if (integerPins.includes(pin) || chartPowerPins.includes(pin)) {
                return Math.max(0, numericValue).toFixed(0);  
            }
            
            if (summaryEnergyPins.includes(pin)) {
                // Gunakan 1 desimal untuk kWh harian
                return Math.max(0, numericValue).toFixed(1);
            }

            // Default: 1 angka di belakang koma untuk pin lainnya 
            return numericValue.toFixed(1);
        }

        /**
         * Fungsi pembantu untuk mendapatkan unit berdasarkan pin
         */
        function getUnit(pin) {
            if (pin === 'V0' || pin === 'V12') return ' V';
            if (pin === 'V1' || pin === 'V13') return ' A';
            if (pin === 'V2' || pin === 'V14' || pin === 'V6' || pin === 'V20') return ' W';
            if (pin === 'V3' || pin === 'V10' || pin === 'V11' || pin === 'V15' || pin === 'V21') return ' kWh';
            if (pin === 'V4') return ' jam';
            if (pin === 'V5') return ' %';
            if (pin === 'V16') return ' Hz';
            if (pin === 'V17') return ' '; 
            if (pin === 'V7' || pin === 'V8' || pin === 'V9') return ' '; 
            return '';
        }

        /**
         * Memperbarui semua nilai metrik di dashboard
         */
        async function updateDashboard() {
            // Cek integritas desain sebelum memulai
            if (!isDesignValid) {
                 showMessage(HASH_ERROR_MESSAGE, 'error');
                 return;
            }
            
            const pins = Object.keys(PIN_MAPPINGS);
            const fetchPromises = pins.map(pin => fetchPinValue(pin).catch(err => {
                 // Menangkap error fetch yang disebabkan oleh isDesignValid = false
                 if (err.message.includes("Design integrity compromised")) {
                     allSuccessful = false;
                     return { status: 'rejected', reason: err };
                 }
                 // Biarkan error lain ditangani secara normal
                 throw err;
            }));

            let allSuccessful = true;
            const results = await Promise.allSettled(fetchPromises);
            
            let currentPvPower = 0;
            let currentAcLoad = 0;

            results.forEach((result, index) => {
                const pin = pins[index];
                const elementId = PIN_MAPPINGS[pin];
                const element = document.getElementById(elementId);
                const unitElement = document.getElementById(`${elementId}-unit`); 
                const unit = getUnit(pin); 

                if (!element) return; 

                element.classList.remove('loading-animation', 'text-red-500');

                if (result.status === 'fulfilled') {
                    const rawValue = result.value || '0';
                    const numericValue = parseFloat(rawValue);

                    if (pin === 'V2') {
                         currentPvPower = numericValue || 0;
                    } else if (pin === 'V14') {
                         currentAcLoad = numericValue || 0;
                    }

                    const formattedValue = formatValue(pin, rawValue);

                    
                    // 1. Tentukan konten teks
                    if (pin === 'V18' || pin === 'V19') {
                        element.textContent = formattedValue;
                        if (unitElement) unitElement.textContent = ''; 
                    } else {
                        element.textContent = formattedValue;
                        if (unitElement) unitElement.textContent = unit;
                    }
                    
                    // 2. Tambahkan efek kilat/update
                    element.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                    }, 100);
                    
                    // 3. Logic Warna Nominal (Dihilangkan untuk brevity, menggunakan kode lama yang sudah benar)
                    let nominalColorClass = '';
                    let iconColorClass = '';

                    // Tentukan kelas warna default
                    if (['V0', 'V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V10', 'V11'].includes(pin) || pin.includes('pzem')) {
                        nominalColorClass = 'text-dc-color'; 
                        iconColorClass = 'text-dc-color'; 
                    } else if (['V7', 'V9'].includes(pin)) {
                         nominalColorClass = 'text-blue-bat';
                         iconColorClass = 'text-blue-bat';
                    } else if (['V12', 'V13', 'V14', 'V15', 'V21'].includes(pin) || pin.includes('ac')) {
                        nominalColorClass = 'text-ac-color';
                        iconColorClass = 'text-ac-color'; 
                    } else if (pin === 'V19' || pin.includes('rupiah')) { 
                        nominalColorClass = 'text-green-400';
                        iconColorClass = 'text-green-400'; 
                    } else if (pin === 'V18') { 
                        nominalColorClass = 'text-pink-med';
                        iconColorClass = 'text-pink-med'; 
                    } 
                    
                    if (pin === 'V8' || pin === 'V20') { 
                        nominalColorClass = 'text-warning-red';
                        iconColorClass = 'text-warning-red';
                    } else if (pin === 'V6') { 
                        nominalColorClass = 'text-orange-red';
                        iconColorClass = 'text-orange-red';
                    } else if (pin === 'V0' || pin === 'V16') { 
                        nominalColorClass = 'text-pink-med';
                        iconColorClass = 'text-pink-med';
                    } else if (pin === 'V17') { 
                        nominalColorClass = 'text-purple-med';
                        iconColorClass = 'text-purple-med';
                    }
                    
                    
                    const colorsToRemove = ['text-dc-color', 'text-blue-bat', 'text-ac-color', 'text-white', 'text-green-400', 'text-pink-med', 'text-purple-med', 'text-orange-red', 'text-warning-red', 'text-white-nominal', 'text-chart-self-consumption', 'text-chart-surplus'];
                    
                    if (element.closest('.solar-card') || element.closest('.power-summary-card')) { 
                        element.classList.remove(...colorsToRemove);
                        element.classList.add(nominalColorClass);
                        if (unitElement) { unitElement.classList.remove(...colorsToRemove); unitElement.classList.add(nominalColorClass); }
                        let summaryIcon = element.closest('.solar-card')?.querySelector(`.lucide`);
                        if (summaryIcon) {
                             summaryIcon.classList.remove(...colorsToRemove);
                             summaryIcon.classList.add(iconColorClass);
                        }
                    } 
                    
                    else if (element.closest('.detail-item')) {
                        element.classList.remove(...colorsToRemove);
                        element.classList.add(nominalColorClass);
                        if(unitElement) {
                            unitElement.classList.remove(...colorsToRemove);
                            unitElement.classList.add(nominalColorClass);
                        }
                        let detailIconElement = element.closest('.detail-item')?.querySelector('.lucide');
                        if (detailIconElement) {
                            detailIconElement.classList.remove(...colorsToRemove);
                            detailIconElement.classList.add(iconColorClass);
                        }
                    }


                } else {
                    allSuccessful = false;
                    element.textContent = 'N/A';
                    element.classList.add('text-red-500');
                    if (unitElement) unitElement.textContent = '';
                }
            });

            // ==========================================================
            // LOGIC PENGHITUNGAN LOKAL UNTUK SELF-CONSUMPTION & SURPLUS
            // ==========================================================
            const selfConsumptionEl = document.getElementById('self-consumption-calc');
            const potensiSurplusEl = document.getElementById('potensi-surplus-calc');

            // --- 1. Hitung Self-Consumption (%) ---
            let scValue = 0;
            if (currentPvPower > 0) {
                scValue = (Math.min(currentPvPower, currentAcLoad) / currentPvPower) * 100;
            }
            const formattedSC = scValue.toFixed(0); 
            selfConsumptionEl.textContent = formattedSC;
            selfConsumptionEl.classList.remove('loading-animation');
            
            // --- 2. Hitung Potensi Surplus (W) ---
            let surplusValue = Math.max(0, currentPvPower - currentAcLoad);
            const formattedSurplus = surplusValue.toFixed(0);
            potensiSurplusEl.textContent = formattedSurplus;
            potensiSurplusEl.classList.remove('loading-animation');
            
            // ==========================================================
            // END LOGIC PENGHITUNGAN LOKAL
            // ==========================================================


            if (!energyChartInstance) {
                 renderRealtimeChart();
            }
            updateRealtimeChartData(currentPvPower, currentAcLoad);
            
            if (allSuccessful) {
                showMessage(`Data berhasil diperbarui pada ${new Date().toLocaleTimeString('id-ID')}`, 'success');
            } else {
                showMessage('Beberapa data gagal dimuat. Periksa Auth Token dan pastikan server Blynk Anda dapat diakses (CORS/HTTPS).', 'error');
            }
        }

        /**
         * Menyimpan konfigurasi, memulai interval fetch, dan menampilkan dashboard
         */
        async function saveAndFetchData() {
            // --- VALIDASI HASH DI SINI ---
            isDesignValid = await checkDesignIntegrity();
            if (!isDesignValid) {
                 showMessage(HASH_ERROR_MESSAGE, 'error');
                 return; 
            }
            
            const ipInput = document.getElementById('server-ip');
            const tokenInput = document.getElementById('auth-token');
            const pvPercentInput = document.getElementById('energy-percent'); // Input Persentase PV
            const loadPercentInput = document.getElementById('energy-load-percent'); // Input Persentase Beban AC
            const desktopButtons = document.getElementById('desktop-buttons');
            const mobileButtons = document.getElementById('mobile-buttons');

            const newServerIp = ipInput.value.trim();
            const newAuthToken = tokenInput.value.trim();
            const newPvPercent = parseFloat(pvPercentInput.value); 
            const newLoadPercent = parseFloat(loadPercentInput.value);

            if (!newAuthToken || !newServerIp) {
                showMessage('IP Server dan Auth Token harus diisi!', 'warning');
                return;
            }
            
            if (isNaN(newPvPercent) || isNaN(newLoadPercent)) {
                showMessage('Nilai Koreksi harus berupa angka!', 'warning');
                return;
            }

            // Simpan ke Local Storage
            localStorage.setItem(STORAGE_KEY_IP, newServerIp);
            localStorage.setItem(STORAGE_KEY_TOKEN, newAuthToken);
            saveCalibrationPercent(newPvPercent.toFixed(1), newLoadPercent.toFixed(1)); // Simpan kedua persentase

            serverIp = newServerIp;
            authToken = newAuthToken;

            if (fetchInterval) {
                clearInterval(fetchInterval);
                fetchInterval = null;
            }

            loadHistoricalData();
            
            document.getElementById('config-panel').classList.add('hidden');
            document.getElementById('monitoring-dashboard').classList.remove('hidden');
            
            if (window.innerWidth >= 768) { 
                desktopButtons.classList.remove('hidden');
                mobileButtons.classList.add('hidden');
            } else {
                mobileButtons.classList.remove('hidden');
                desktopButtons.classList.add('hidden');
            }

            updateDashboard();

            fetchInterval = setInterval(updateDashboard, UPDATE_INTERVAL);

            showMessage(`Monitoring dimulai ke ${serverIp}. Memuat data...`, 'success');
        }
        
        /**
         * Menghapus token dari Local Storage dan mengembalikan ke layar konfigurasi.
         */
        function logoutAndClear() {
            if (fetchInterval) {
                clearInterval(fetchInterval);
                fetchInterval = null;
            }
            isDesignValid = true; // Reset state integritas saat logout

            showModal(
                'Apakah Anda yakin ingin menghentikan monitoring? Konfigurasi Anda akan dihapus dari browser ini.',
                () => {
                    if (energyChartInstance) {
                         energyChartInstance.destroy();
                         energyChartInstance = null;
                    }
                    
                    localStorage.removeItem(STORAGE_KEY_IP);
                    localStorage.removeItem(STORAGE_KEY_TOKEN);
                    localStorage.removeItem(STORAGE_KEY_CHART_DATA); 
                    localStorage.removeItem(STORAGE_KEY_PV_PERCENT); 
                    localStorage.removeItem(STORAGE_KEY_LOAD_PERCENT); 
                    
                    serverIp = '';
                    authToken = '';
                    ENERGY_CALIBRATION_PERCENT = 0.0;
                    LOAD_CALIBRATION_PERCENT = 0.0;
                    window.realtimeData.labels = [];
                    window.realtimeData.pvPower = [];
                    window.realtimeData.acLoad = [];
                    
                    document.getElementById('server-ip').value = 'iot.serangkota.go.id:9443';
                    document.getElementById('auth-token').value = '';
                    document.getElementById('energy-percent').value = '0.0'; 
                    document.getElementById('energy-load-percent').value = '0.0'; 
                    
                    document.getElementById('config-panel').classList.remove('hidden');
                    document.getElementById('monitoring-dashboard').classList.add('hidden');
                    
                    document.getElementById('desktop-buttons').classList.add('hidden');
                    document.getElementById('mobile-buttons').classList.add('hidden');

                    const header = document.getElementById('app-header');
                    const footer = document.getElementById('app-footer');
                    header.classList.remove('header-hidden');
                    footer.classList.remove('footer-hidden');
                    isMinimalUI = false;


                    showMessage('Anda telah keluar. Data konfigurasi telah dihapus dari browser ini.', 'success');
                }
            );
        }

        /**
         * Fungsi inisialisasi saat memuat halaman
         */
        function init() {
            const desktopButtons = document.getElementById('desktop-buttons');
            const mobileButtons = document.getElementById('mobile-buttons');
            
            desktopButtons.classList.add('hidden');
            mobileButtons.classList.add('hidden');

            const savedIp = localStorage.getItem(STORAGE_KEY_IP);
            const savedToken = localStorage.getItem(STORAGE_KEY_TOKEN);
            
            loadCalibrationPercent(); // Muat kedua persentase kalibrasi

            if (savedIp) {
                document.getElementById('server-ip').value = savedIp;
                serverIp = savedIp;
            } else {
                document.getElementById('server-ip').value = 'iot.serangkota.go.id:9443';
            }
            if (savedToken) {
                document.getElementById('auth-token').value = savedToken;
                authToken = savedToken;
            }

            updateTime();
            setInterval(updateTime, 1000); 

            lucide.createIcons();
        }

        // Jalankan inisialisasi saat DOM siap
        window.onload = function() {
            init();
            // Jika ada token tersimpan, mulai fetching
            if (localStorage.getItem(STORAGE_KEY_TOKEN) && localStorage.getItem(STORAGE_KEY_IP)) {
                saveAndFetchData();
            } else {
                showMessage('Silakan masukkan IP Server, Auth Token Blynk, dan atur Koreksi Persentase Anda.', 'warning');
            }
        };
    </script>
</body>
</html>
