<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#05050D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="AEPRO PLTS">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>AEPRO PLTS & BMS</title>
    <!-- MEMUAT SEMUA LIB YANG DIPERLUKAN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.0.16/svg.min.js"></script>

    <!-- Konfigurasi Tailwind & Variabel CSS -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'blynk-primary': '#4B87FF',
                        'bg-main': '#05050D',
                        'dc-color': '#BFFF00',
                        'ac-color': '#FFB900',
                        'blue-bat': '#00FFFF',
                        'green-400': '#00C853',
                        'pink-med': '#FF69B4',
                        'purple-med': '#8E44AD',
                        'orange-red': '#E74C3C',
                        'warning-red': '#EF4444',
                        'chart-pv': '#BFFF00',
                        'chart-load': '#FFB900',
                        'chart-self-consumption': '#00FFFF',
                        'chart-surplus': '#8E44AD',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            --solar-dark: #05050D;
            --solar-card-bg: rgba(20, 20, 48, 0.4);
            --blue-bat: #00FFFF;
            --green-400: #00C853;
            --warning-red: #EF4444;
            --stabilo-green: #BFFF00;
            --soft-brown: #B8860B;
            --red-cell: #F87171;
            --green-cell: #34D399;
            --color-solar: #BFFF00; /* Hijau Stabilo (DC) */
            --color-battery: #FF69B4; /* Pink Med (Baterai) */
            --color-grid: #00FFFF; /* Cyan Cerah/Biru Bat (Grid) */
            --color-load: #FFB900; /* Kuning Emas (AC Load) */
            --color-inverter: #BBBBBB;
            --color-bar-green: #4CAF50; 
            --color-bar-green-light: #A5C916;
            --color-bar-yellow: #FFC107;
            --color-bar-red: #E57373;
            --color-bar-empty: #444444;
            --secondary: #00C853; /* Definisi untuk LED aktif (Green-400) */
        }
        body { background-color: var(--solar-dark); font-family: 'Inter', sans-serif; color: #F8FAFC; }
        .solar-card { background-color: var(--solar-card-bg); color: #F8FAFC; border-radius: 16px; box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3); border: 1px solid rgba(71, 85, 105, 0.2); transition: all 0.3s ease; }
        .solar-card:hover { box-shadow: 0 8px 15px rgba(0, 0, 0, 0.5); transform: translateY(-2px); background-color: rgba(20, 20, 48, 0.6); }
        .diagram-section-container { width: 100%; background: var(--solar-card-bg); padding: 10px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); border-radius: 12px; border: 1px solid rgba(71, 85, 105, 0.2); }
        .svg-container { width: 100%; padding-bottom: 72%; position: relative; }
        .svg-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .st3, .remaining-energy, .pv-detail-text { font-size: 11px; font-weight: 400; fill: #C0C0C0; }
        .st4 { font-size: 15px; font-weight: 600; }
        .st10 { font-size: 18px; font-weight: 500; }
        .st13 { font-size: 20px; font-weight: 600; }
        .pv-detail-value { font-size: 11px !important; font-weight: 500 !important; fill: #C0C0C0 !important; }
        .pv-extra-detail { font-size: 11px; font-weight: 400; fill: #C0C0C0; }
        .pv-bus-label { font-size: 9px; font-weight: 400; fill: #C0C0C0; }
        #Solar [fill="grey"], #Solar [stroke="grey"], #Solar path[fill="#FFFFFF"] { fill: var(--color-solar) !important; stroke: var(--color-solar) !important; }
        #Solar text:not(.pv-detail-value):not(.pv-extra-detail):not(.pv-bus-label) { fill: var(--color-solar) !important; }
        #pv1_power_186 { fill: var(--color-solar) !important; }
        #grid-flow circle { r: 3.5; fill: var(--color-grid) !important; }
        #load-flow circle { r: 3.5; fill: var(--color-load) !important; }
        #battery_flow circle { r: 3.5; fill="var(--color-battery)" !important; }
        #solar-flow circle { r: 3.5; fill: var(--color-solar) !important; }
        #Grid #grid_total_power, #Grid #daily_grid_buy_value { fill: var(--color-grid) !important; }
        #Load #ess_power, #Load #daily_load_value { fill="var(--color-load)" !important; }
        #battery_main #data\.batteryPower_190 { fill="var(--color-battery)" !important; }
        #Inverter path { fill="var(--color-inverter)" !important; }
        #Inverter text { fill="var(--color-inverter)" !important; }
        #solar-flow path, #grid-flow path, #load-flow path, #bat-line { stroke-width: 2; }
        #solar_power_box rect, #grid_power_box rect, #load_power_box rect, #battery_power_box rect { fill: none; }
        .battery-current-disch { fill: var(--color-battery) !important; font-weight: 600; }
        .battery-current-charge { fill="var(--color-load)" !important; font-weight: 600; }
        .soh-default { fill: #C0C0C0 !important; font-weight: 600; }
        #status-message-diagram, #message-box { display: none !important; }
        .led { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-left: 6px; background: #ccc; transition: background-color 0.3s ease; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .led.active { 
            background: var(--secondary); 
            box-shadow: 0 0 8px var(--secondary); 
        }
        .progress-bar { height: 8px; border-radius: 4px; overflow: hidden; background-color: rgba(51, 65, 85, 0.5); }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        /* Kelas Tailwind dinamis yang digunakan di JS (penting untuk JIT) */
        .bg-soc-red { background-color: var(--warning-red); }
        .bg-soc-yellow { background-color: var(--color-bar-yellow); }
        .bg-soc-green { background-color: var(--green-400); }
        /* Kelas Teks dinamis yang digunakan di JS */
        .text-soc-red { color: var(--warning-red); }
        .text-soc-yellow { color: var(--color-bar-yellow); }
        .text-soc-green { color: var(--green-400); }

        .text-charging { color: var(--stabilo-green); }
        .text-discharging { color: var(--soft-brown); }
        .text-standby { color: #F8FAFC; }
        .text-amp-discharging { color: var(--warning-red); }
        .text-power-standby { color: var(--pink-400); }
        .text-purple-400 { color: #A78BFA; }
        .modal-summary-card { padding: 1rem; border-radius: 0.75rem; display: flex; flex-direction: column; justify-content: space-between; min-height: 120px; background-color: rgba(20, 20, 48, 0.8); border-bottom: 5px solid; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .modal-soc { border-bottom-color: #3b82f6; }
        .modal-soh { border-bottom-color: #22c55e; }
        .modal-cycles { border-bottom-color: #a855f7; }
        
        /* PERBAIKAN GRID SEL: Max 3 kolom di HP, max 5 di layar besar */
        #modalCells { 
            display: grid; 
            grid-template-columns: repeat(3, minmax(0, 1fr)); /* Default 3 kolom (HP) */
            gap: 0.75rem; 
        }
        @media (min-width: 640px) { #modalCells { grid-template-columns: repeat(4, minmax(0, 1fr)); } } /* 4 kolom di layar kecil/tablet */
        @media (min-width: 768px) { #modalCells { grid-template-columns: repeat(5, minmax(0, 1fr)); } } /* 5 kolom di tablet/desktop */
        @media (min-width: 1280px) { #modalCells { grid-template-columns: repeat(5, minmax(0, 1fr)); } } 

        /* PERUBAHAN KRITIS: Hapus pengaturan width/height tetap pada fullscreen-chart */
        .fullscreen-chart { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw !important; /* Gunakan 100vw untuk memastikan lebar penuh */
            height: 100vh !important; /* Gunakan 100vh untuk memastikan tinggi penuh */
            background-color: #05050D !important; 
            z-index: 9999; 
            padding: 20px; 
            /* Memastikan chart mengisi ruang di dalam container fullscreen */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* Pastikan canvas juga mengisi ruang yang tersedia di mode fullscreen */
        #realtime-chart-container.full-screen-container { 
            height: 100% !important; 
            width: 100% !important; 
            max-height: 100%;
        }

        #realtime-chart-container { height: 350px; margin-top: 1rem; }
        @media (min-width: 768px) { #realtime-chart-container { height: 350px; } }
        .summary-block { display: flex; align-items: baseline; justify-content: flex-start; }
        .summary-value { font-size: 3rem; font-weight: 900; line-height: 1; letter-spacing: -0.05em; }
        .summary-unit { font-size: 1.25rem; font-weight: 500; margin-left: 0.5rem; line-height: 1; }
        .power-summary-card { background-color: rgba(40, 40, 70, 0.3); padding: 1rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: all 0.2s; }
        .detail-item { background-color: rgba(255, 255, 255, 0.03); border: 1px solid rgba(71, 85, 105, 0.2); border-radius: 10px; margin-bottom: 0.5rem; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; }
        .metric-title { font-size: 0.95rem; }
        .nominal-color span { font-size: 1.125rem; font-weight: 700; }
        .solar-card h3 { padding-top: 0.25rem; padding-bottom: 0.5rem; margin-bottom: 1rem; padding-left: 1rem; }
        .detail-metric { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(51, 65, 85, 0.5); }
        .battery-metric-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem 0.75rem; margin-top: 0.75rem; }
        @media (min-width: 1024px) { .battery-metric-grid { grid-template-columns: repeat(3, 1fr); gap: 0.75rem 1rem; } }
        .battery-metric-item { display: flex; align-items: center; padding: 0.25rem; }
        .battery-metric-grid > div:nth-child(2n):not(:last-child)::after { content: ""; border-right: 1px solid rgba(71, 85, 105, 0.4); margin-left: 0.75rem; }
        @media (min-width: 1024px) {
            .battery-metric-grid > div:nth-child(3n)::after { content: none; }
            .battery-metric-grid > div:nth-child(3n-1)::after { content: ""; }
            .battery-metric-grid > div:nth-child(3n-2)::after { content: ""; }
        }
    </style>
</head>

<body class="min-h-screen p-4 sm:p-8 bg-bg-main">

    <!-- Modal Kustom Konfirmasi -->
    <div id="custom-modal" class="fixed inset-0 hidden items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.85); z-index: 1000;">
        <div id="modal-content" class="rounded-xl p-6 shadow-2xl max-w-sm w-full bg-slate-800">
            <h3 class="text-xl font-bold text-white mb-3">Konfirmasi Navigasi</h3>
            <p id="modal-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-semibold rounded-lg text-gray-400 hover:bg-gray-700 transition">Batal</button>
                <button id="modal-confirm-button" onclick="" class="px-4 py-2 text-sm font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- Modal Detail Baterai (BMS) -->
    <div id="batteryModal" class="fixed inset-0 hidden bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 rounded-xl shadow-2xl max-w-5xl w-full max-h-[95vh] overflow-hidden flex flex-col">
          <div class="flex items-center justify-between px-6 py-4 border-b border-gray-700">
            <div class="flex items-center">
              <h2 id="modalTitle" class="text-xl font-semibold text-white">Baterai #<span id="modalAddr">N/A</span></h2>
              <div id="led-modal" class="led ml-4"></div>
            </div>
            <button id="closeModalButton" class="text-gray-400 hover:text-white">
              <i data-lucide="x" class="lucide w-6 h-6"></i>
            </button>
          </div>

          <!-- Menambahkan overflow-y-auto untuk mengizinkan scrolling di konten utama modal -->
          <div class="flex-1 p-6 overflow-y-auto"> 
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="modal-summary-card modal-soc text-white"><h3 class="text-sm font-medium">State of Charge</h3><div class="text-4xl font-extrabold"><span id="modalSOCPercent">N/A</span><span id="modalSOCUnit">%</span></div><div class="text-xs text-blue-300 mt-2">Sisa Kapasitas: <span id="modalRemaining">N/A</span> Ah</div></div>
              <div class="modal-summary-card modal-soh text-white"><h3 class="text-sm font-medium">State of Health</h3><div class="text-4xl font-extrabold text-green-400"><span id="modalSOHPercent">N/A</span>%</div><div class="text-xs text-green-300 mt-2">Kapasitas Penuh: <span id="modalCapacity">N/A</span> Ah</div></div>
              <div class="modal-summary-card modal-cycles text-white"><h3 class="text-sm font-medium">Cycle Count</h3><div class="text-4xl font-extrabold text-purple-300"><span id="modalCycles">N/A</span></div><div class="text-xs text-purple-300 mt-2">Terakhir diperbarui: <span id="modalLastUpdate">N/A</span></div></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-medium text-gray-300 mb-3 flex items-center"><i data-lucide="zap" class="lucide w-4 h-4 text-yellow-500 mr-2"></i> Metrik Tegangan</h3>
                <div class="space-y-3 text-sm">
                    <div class="detail-metric"><span class="text-gray-400">Tegangan Pack</span><span class="font-semibold text-white" id="modalVoltage">N/A</span></div>
                    <div class="detail-metric"><span class="text-gray-400">Tegangan Bus</span><span class="font-semibold text-white" id="modalBusVoltage">N/A</span></div>
                    <div class="detail-metric"><span class="text-gray-400">Tegangan Sel Min</span><span class="font-semibold text-white" id="modalcellmin">N/A</span></div>
                    <div class="detail-metric"><span class="text-gray-400">Tegangan Sel Max</span><span class="font-semibold text-white" id="modalcellmax">N/A</span></div>
                    <div class="detail-metric"><span class="text-gray-400">Perbedaan Tegangan</span><span class="font-semibold text-white" id="modalcelldif">N/A</span></div>
                </div>
              </div>

              <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-medium text-gray-300 mb-3 flex items-center"><i data-lucide="activity" class="lucide w-4 h-4 text-blue-500 mr-2"></i> Metrik Arus & Daya</h3>
                <div class="space-y-3 text-sm">
                    <div class="detail-metric"><span class="text-gray-400">Arus Pack</span><span class="font-semibold text-white" id="modalCurrent">N/A</span></div>
                    <div class="detail-metric"><span class="text-gray-400">Daya (Power)</span><span class="font-semibold text-white" id="modalPower">N/A</span></div>
                    <div class="detail-metric"><span class="text-gray-400">Status Temp</span><span class="font-semibold text-white" id="modalTemp">N/A</span></div>
                    <!-- Baris kosong dipertahankan untuk keseimbangan layout -->
                    <div class="detail-metric"><span class="text-gray-400">_</span><span class="font-semibold text-white">_</span></div>
                    <div class="detail-metric"><span class="text-gray-400">_</span><span class="font-semibold text-white">_</span></div>
                </div>
              </div>
            </div>

            <div class="solar-card p-4 rounded-lg mt-6">
              <h3 class="font-medium text-gray-300 mb-4 flex items-center">
                <i data-lucide="layout-grid" class="lucide w-4 h-4 text-green-500 mr-2"></i> Tegangan Sel (Cell Voltages)
              </h3>
              <div id="modalCells" class="grid gap-3"></div>
            </div>
          </div>
        </div>
    </div>

    <!-- Container Utama Aplikasi -->
    <div id="app-container" class="max-w-7xl mx-auto">

        <!-- Halaman PLTS Dashboard -->
        <div id="plts-page" class="w-full">
            <header id="app-header" class="mb-6">
                <div id="main-header-content" class="flex flex-col md:flex-row justify-between items-center">
                    <div class="w-full text-center md:text-left">
                        <h1 class="text-3xl sm:text-4xl font-extrabold text-white tracking-tight">AEPRO PLTS ONLINE</h1>
                        <p class="text-gray-400 mt-1">Monitor Kinerja dan Performa Sistem PLTS.</p>
                    </div>
                    <div class="mt-4 md:mt-0 relentlessly-right flex flex-col md:flex-row items-center space-x-4">
                        <div class="show md:block text-center md:text-right">
                            <p id="current-date" class="text-sm text-gray-400"></p>
                            <p id="current-time" class="text-3xl font-bold text-white"></p>
                        </div>
                        <div id="desktop-buttons" class="hidden md:flex space-x-3 items-center"></div>
                    </div>
                </div>
                <div id="mobile-buttons" class="hidden md:hidden w-full grid grid-cols-2 gap-3 mb-6 mt-4"></div>
            </header>

            <p id="message-box" class="mt-4 w-full text-sm font-semibold p-3 rounded-xl hidden"></p>
            <div id="status-message-diagram" class="mt-4 w-full"></div>

            <!-- DIAGRAM ALIRAN ENERGI (SVG) -->
            <div class="diagram-section-container mb-8">
                <div class="w-full p-2 shadow-xl rounded-xl border border-gray-700">
                    <div class="svg-container">
                        <svg preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="-2 0 490 430" class="svg-content">
                            <defs></defs>
                            <svg id="Solar" style="overflow: visible; display: inline;" x="0%" y="-6%">
                                <svg id="sun" x="120" y="48" width="30" height="30" viewBox="0 0 24 24"><path fill="var(--color-solar)" d="M11.45 2v3.55L15 3.77L11.45 2m-1 6L8 10.46l3.75 1.25L10.45 8M2 11.45L3.77 15l1.78-3.55H2M10 2H2v8c.57.17 1.17.25 1.77.25c3.58.01 6.49-2.9 6.5-6.5c-.01-.59-.1-1.18-.27-1.75m7 20v-6h-3l5-9v6h3l-5 9Z"></path></svg>
                                <text id="total_solar_generation" x="239" y="72" dominant-baseline="central" text-anchor="middle" display="" class="st3" fill="var(--color-solar)">TOTAL ENERGY / TOTAL SOLAR</text>
                                <a href="#"><text id="total_solar_value" x="239" y="55" dominant-baseline="central" text-anchor="middle" class="st10" fill="var(--color-solar)">-- kWh / -- kWh</text></a>
                                <svg width="70" height="30" viewBox="0 0 70 30" overflow="visible" id="pv1" x="204" y="90"><rect width="70" height="30" rx="4.5" ry="4.5" fill="none" stroke-width="1" pointer-events="all" id="pv1" stroke="var(--color-solar)" class=""></rect></svg>
                                <svg id="solar_power_box" x="204" y="90"><a href="#"><text id="pv1_power_186" x="35" y="15" dominant-baseline="central" text-anchor="middle" class="st4" fill="var(--color-solar)">-- W</text></a></svg>
                                <g id="pv_extra_info" x="0%" y="0%">
                                    <text x="197" y="133" dominant-baseline="central" text-anchor="end" class="pv-bus-label">Volt Bus:</text>
                                    <a href="#"><text id="pv2_voltage_label" x="230" y="133" dominant-baseline="central" text-anchor="end" class="pv-bus-label">-- V</text></a>
                                    <text id="pv_peak_label_text" x="247" y="133" dominant-baseline="central" text-anchor="start" class="pv-bus-label">Peak:</text>
                                    <text id="pv_peak_label" x="273" y="133" dominant-baseline="central" text-anchor="start" class="pv-bus-label">-- W</text>
                                    <text x="197" y="145" dominant-baseline="central" text-anchor="end" class="pv-bus-label">Arus:</text>
                                    <a href="#"><text id="pv2_current_label" x="230" y="145" dominant-baseline="central" text-anchor="end" class="pv-bus-label">-- A</text></a>
                                    <text id="pv_efficiency_value_text" x="247" y="145" dominant-baseline="central" text-anchor="start" class="pv-bus-label">Effic:</text>
                                    <text id="pv_efficiency_value" x="272" y="145" dominant-baseline="central" text-anchor="start" class="pv-bus-label">--%</text>
                                    <text id="effective_sun_hours_text" x="198" y="157" dominant-baseline="central" text-anchor="end" class="pv-bus-label">Matahari Efektif:</text>
                                    <text id="effective_sun_hours" x="201" y="157" dominant-baseline="central" text-anchor="start" class="pv-bus-label">-- Hrs</text>
                                    <text id="pv_placeholder_text" x="247" y="157" dominant-baseline="central" text-anchor="start" class="pv-bus-label">SOC:</text>
                                    <text id="pv_placeholder" x="274" y="157" dominant-baseline="central" text-anchor="start" class="pv-bus-label">-- %</text>
                                </g>
                                <svg xmlns:xlink="http://www.w3.org/1999/xlink" overflow="visible" id="solar-flow">
                                    <path fill="none" stroke-miterlimit="10" pointer-events="stroke" id="solar-line-1" d="M 239 120 L 239 215" display="" stroke="var(--color-solar)" stroke-width="2" class="st12"></path>
                                    <circle cx="0" cy="0" r="3.5" fill="var(--color-solar)"><animateMotion id="solar_flow_anim_1" repeatCount="indefinite" keyTimes="0;1" calcMode="linear" dur="2s"><mpath href="#solar-line-1"></mpath></animateMotion></circle>
                                </svg>
                            </svg>
                            <svg id="Inverter" style="overflow: visible" x="0%">
                                <svg x="213.5" y="179.5" width="54" height="79" viewBox="0 0 74 91" preserveAspectRatio="xMidYMid meet" opacity="1"><g transform="translate(0.000000,91.000000) scale(0.100000,-0.100000)" stroke="none" fill="var(--color-inverter)"><path d="M35 887 l-27 -23 0 -404 0 -404 27 -23 c26 -23 28 -23 329 -23 284 0 305 1 327 19 l24 19 0 412 0 412 -24 19 c-22 18 -43 19 -327 19 -301 0 -303 0 -329 -23z m585 -157 l0 -80 -255 0 -255 0 0 80 0 80 255 0 255 0 0 -80z m-242 -229 c44 -34 40 -46 -14 -46 -60 0 -97 -38 -93 -94 5 -64 -23 -80 -35 -20 -9 44 24 113 63 134 35 18 34 15 21 50 -11 29 -14 30 58 -24z m110 -129 c4 -51 -19 -97 -59 -117 -27 -14 -30 -20 -23 -48 l6 -31 -51 43 c-29 24 -49 46 -46 49 3 4 23 5 44 3 58 -4 95 32 97 95 3 60 1 57 17 52 6 -3 13 -23 15 -46z"></path></g></svg>
                                <a href="#"><text id="inverter_voltage_154" x="315" y="165" display="" class="st3 left-align" fill="var(--color-inverter)">-- V</text></a>
                                <a href="#"><text id="inverter_current_164" x="315" y="177" display="" class="st3 left-align" fill="var(--color-inverter)">-- A</text></a>
                                <a href="#"><text id="load_frequency_192" x="315" y="189" display="" class="st3 left-align" fill="var(--color-inverter)">-- Hz</text></a>
                                <text id="autarkyp_value" x="110" y="260" display="" class="st3 left-align" fill="var(--color-inverter)">--%</text>
                                <text id="autarky" x="110" y="273" display="" class="st3 left-align" fill="var(--color-inverter)">Autarky</text>
                                <text id="ratiop_value" x="165" y="260" display="" class="st3 left-align" fill="var(--color-inverter)">--%</text>
                                <text id="ratio" x="166" y="273" display="" class="st3 left-align" fill="var(--color-inverter)">Ratio</text>
                            </svg>
                            <svg id="Grid" style="overflow: visible; display: inline;">
                                <svg x="20" y="185" width="64.5" height="64.5" viewBox="0 0 24 24"><path fill="var(--color-grid)" d="m8.28 5.45l-1.78-.9L7.76 2h8.47l1.27 2.55l-1.78.89L15 4H9l-.72 1.45M18.62 8h-4.53l-.79-3h-2.6l-.79 3H5.38L4.1 10.55l1.79.89l.73-1.44h10.76l.72 1.45l1.79-.89L18.62 8m-.85 14H15.7l-.24-.9L12 15.9l-3.47 5.2l-.23.9H6.23l2.89-11h2.07l-.36 1.35L12 14.1l1.16-1.75l-.35-1.35h2.07l2.89 11m-6.37-7l-.9-1.35l-1.18 4.48L11.4 15m3.28 3.12l-1.18-4.48l-.9 1.36l2.08 3.12Z"></path></svg>
                                <svg id="grid_power_box" x="103" y="203.5"><rect width="70" height="30" rx="4.5" ry="4.5" fill="none" stroke-width="1" pointer-events="all" stroke="var(--color-grid)"></rect><a href="#"><text id="grid_total_power" x="35" y="15" dominant-baseline="central" text-anchor="middle" class="st4" fill="var(--color-grid)">-- W</text></a></svg>
                                <svg id="grid-flow">
                                    <path fill="none" stroke-miterlimit="10" pointer-events="stroke" id="grid-line-1" d="M 77 218.5 L 103 218.5" display="" stroke="var(--color-grid)" stroke-width="2"></path>
                                    <path fill="none" stroke-miterlimit="10" pointer-events="stroke" id="grid-line-2" d="M 173 218.5 L 214 218.5" display="" stroke="var(--color-grid)" stroke-width="2"></path>
                                    <circle cx="0" cy="0" r="3.5" fill="var(--color-grid)"><animateMotion id="grid_flow_anim_1" repeatCount="indefinite" keyTimes="0;1" calcMode="linear" dur="2s"><mpath href="#grid-line-1"></mpath></animateMotion></circle>
                                    <circle cx="0" cy="0" r="3.5" fill="var(--color-grid)"><animateMotion id="grid_flow_anim_2" repeatCount="indefinite" keyTimes="0;1" calcMode="linear" dur="2s"><mpath href="#grid-line-2"></mpath></animateMotion></circle>
                                </svg>
                                <text id="daily_grid_buy_value" x="30" y="265" dominant-baseline="central" text-anchor="start" class="st10" fill="var(--color-grid)">--</text>
                                <text id="daily_grid_buy" x="30" y="280" dominant-baseline="central" text-anchor="start" class="st3" fill="var(--color-grid)">GRID PLN</text>
                            </svg>
                            <svg id="Load" style="overflow: visible" x="0%">
                                <svg id="load_power_box" x="304" y="203.5"><rect width="70" height="30" rx="4.5" ry="4.5" fill="none" stroke-width="1" pointer-events="all" stroke="var(--color-load)"></rect><a href="#"><text id="ess_power" x="35" y="15" dominant-baseline="central" text-anchor="middle" class="st4" fill="var(--color-load)">-- W</text></a></svg>
                                <svg id="load-flow">
                                    <path fill="none" stroke-miterlimit="10" pointer-events="stroke" id="es-line-1" d="M 265 218.5 L 304 218.5" display="" stroke="var(--color-load)" stroke-width="2"></path>
                                    <path fill="none" stroke-miterlimit="10" pointer-events="stroke" id="es-line-2" d="M 374 218.5 L 398 218.5" display="" stroke="var(--color-load)" stroke-width="2"></path>
                                    <circle cx="0" cy="0" id="es-dot-1" r="3.5" fill="var(--color-load)"><animateMotion id="load_flow_anim_1" repeatCount="indefinite" keyTimes="0;1" calcMode="linear" dur="2s"><mpath href="#es-line-1"></mpath></animateMotion></circle>
                                    <circle cx="0" cy="0" id="es-dot-2" r="3.5" fill="var(--color-load)"><animateMotion id="load_flow_anim_2" repeatCount="indefinite" keyTimes="0;1" calcMode="linear" dur="2s"><mpath href="#es-line-2"></mpath></animateMotion></circle>
                                </svg>
                                <a href="#"><svg id="essen" viewBox="0 0 24 24" x="395" y="176" width="79" height="79"><path fill="var(--color-load)" d="m15 13l-4 4v-3H2v-2h9V9l4 4M5 20v-4h2v2h10v-7.81l-5-4.5L7.21 10H4.22L12 3l10 9h-3v8H5Z"></path></svg></a>
                                <a href="#"><text id="daily_load_value" x="400" y="265" dominant-baseline="central" text-anchor="start" class="st10" fill="var(--color-load)">-- kWh</text></a>
                                <text id="daily_load" x="404" y="280" dominant-baseline="central" text-anchor="start" class="st3" fill="var(--color-load)">DAILY LOAD</text>
                            </svg>
                            <svg id="battery_main" style="overflow: visible; display: inline;" x="0%">
                                <g>
                                    <svg id="battery_power_box" x="204" y="280"><rect width="70" height="30" rx="4.5" ry="4.5" fill="none" stroke-width="1" pointer-events="all" stroke="var(--color-battery)"></rect><a href="#"><text id="data.batteryPower_190" x="35" y="15" dominant-baseline="central" text-anchor="middle" class="st4" fill="var(--color-battery)">-- W</text></a></svg>
                                    <svg id="battery_flow" style="overflow: visible;">
                                        <path fill="none" stroke-miterlimit="10" pointer-events="stroke" id="bat-line" d="M 239 250 L 239 280" display="" stroke="var(--color-battery)" stroke-width="2"></path>
                                        <path fill="none" stroke-miterlimit="10" pointer-events="stroke" id="bat-line-to-icon" d="M 239 310 L 239 345" display="" stroke="var(--color-battery)" stroke-width="2"></path>
                                        <circle cx="0" cy="0" id="power-dot-discharge" r="3.5" fill="var(--color-battery)"><animateMotion id="bat_flow_anim_1" repeatCount="indefinite" keyTimes="0;1" calcMode="linear" dur="2s"><mpath href="#bat-line"></mpath></animateMotion></circle>
                                        <circle cx="0" cy="0" id="power-dot-internal" r="3.5" fill="var(--color-battery)"><animateMotion id="bat_flow_anim_2" repeatCount="indefinite" keyTimes="0;1" calcMode="linear" dur="2s"><mpath href="#bat-line-to-icon"></mpath></animateMotion></circle>
                                    </svg>
                                    <svg id="battery_icon" style="overflow: visible;" x="0%"><a href="#"><svg id="bat_outter" y="338.5" width="78.75" height="78.75" preserveAspectRatio="none" viewBox="0 0 24 24" x="213.0"><defs></defs><path fill="var(--color-battery)" d="M10 20H4V6h8L12 20m.67-16H11V2H5v2H3.33C2.6 4 2 4.6 2 5.33v15.34C2 21.4 2.6 22 3.33 22h9.34c.74 0 1.33-.59 1.33-1.33V5.33C14 4.6 13.4 4 12.67 4"></path></svg><svg id="bat_inner" y="342" width="78.75" height="68.75" preserveAspectRatio="none" viewBox="0 0 24 24" x="211.0"></svg></a></svg>
                                    <text id="battery_remaining_energy" x="292.375" y="362" dominant-baseline="central" text-anchor="start" class="remaining-energy" fill="var(--color-battery)">-- Ah</text>
                                    <svg id="Battery1_SOC" style="overflow: visible; display: inline;"><a href="#"><text id="battery_soc_184" x="292.375" y="380" dominant-baseline="central" text-anchor="start" class="st13" fill="var(--color-battery)">--% | --%</text></a></svg>
                                    <svg id="battery_1_runtime" style="overflow: visible; display: inline;">
                                        <text id="duration" x="292.375" y="401" dominant-baseline="central" text-anchor="start" class="st4" fill="var(--color-inverter)">-- V</text>
                                        <text id="duration_text" x="292.375" y="415" dominant-baseline="central" text-anchor="start" class="st3" fill="var(--color-battery)">-- A</text>
                                    </svg>
                                    <svg id="battery_daily" style="overflow: visible;">
                                        <svg id="battery_daily_charge" style="overflow: visible;" x="0%" y="0%">
                                            <text id="daily_bat_charge_value" x="100" y="365" dominant-baseline="central" text-anchor="start" class="st10" fill="var(--color-battery)">0.00 kWh</text>
                                            <text id="daily_bat_charge" x="105" y="382" dominant-baseline="central" text-anchor="start" class="st3" fill="var(--color-battery)">DAILY CHARGE</text>
                                        </svg>
                                        <svg id="battery_daily_discharge" style="overflow: visible;" x="0%" y="0%">
                                            <text id="daily_bat_dischcharge_value" x="100" y="399" dominant-baseline="central" text-anchor="start" class="st10" fill="var(--color-battery)">0.00 kWh</text>
                                            <text id="daily_bat_dischcharge" x="85" y="415" dominant-baseline="central" text-anchor="start" class="st3" fill="var(--color-battery)">DAILY DISCHARGE</text>
                                        </svg>
                                    </svg>
                                </g>
                            </svg>
                        </svg>
                    </div>
                </div>
            </div>
            <!-- END DIAGRAM ALIRAN ENERGI -->


            <!-- Area Monitoring Utama (PLTS) -->
            <main id="monitoring-dashboard" class="block">
                <h2 class="text-xl font-semibold text-gray-300 mb-4 mt-8">Ringkasan Kinerja Hari Ini</h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="solar-card p-4 summary-kwh-card">
                        <div class="flex justify-between items-start mb-2"><p class="text-sm font-semibold text-gray-400">Energi Hari Ini</p><i data-lucide="sun" class="lucide w-7 h-7 text-dc-color"></i></div>
                        <div class="summary-block"><span id="v10-kwh-today" class="data-value summary-value text-dc-color loading-animation">...</span><span id="v10-kwh-today-unit" class="summary-unit text-dc-color"></span></div>
                        <p class="text-xs text-gray-500 mt-1">Total produksi DC hari ini.</p>
                    </div>
                    <div class="solar-card p-4 summary-kwh-card">
                        <div class="flex justify-between items-start mb-2"><p class="text-sm font-semibold text-gray-400">Beban Hari Ini</p><i data-lucide="power-square" class="lucide w-7 h-7 text-ac-color"></i></div>
                        <div class="summary-block"><span id="v21-kwh-today-ac" class="data-value summary-value text-ac-color loading-animation">...</span><span id="v21-kwh-today-ac-unit" class="summary-unit text-ac-color"></span></div>
                        <p class="text-xs text-gray-500 mt-1">Total konsumsi AC hari ini.</p>
                    </div>
                    <div class="solar-card p-4 summary-kwh-card">
                        <div class="flex justify-between items-start mb-2"><p class="text-sm font-semibold text-gray-400 ">Penghematan Hari Ini</p><i data-lucide="file-text" class="lucide w-7 h-7 text-green-400"></i></div>
                        <div class="summary-rupiah-block"><span class="text-2xl text-gray-400 mr-1 font-bold">Rp</span><span id="v19-rupiah-day" class="data-value summary-value !text-3xl text-green-400 loading-animation !tracking-normal">...</span></div>
                        <p class="text-xs text-gray-500 mt-1">Perkiraan biaya yang dihemat hari ini.</p>
                    </div>
                    <div class="solar-card p-4 summary-kwh-card">
                        <div class="flex justify-between items-start mb-2"><p class="text-sm font-semibold text-gray-400 ">Penghematan Bulan Ini</p><i data-lucide="trending-up" class="lucide w-7 h-7 text-pink-med"></i></div>
                        <div class="summary-rupiah-block"><span class="text-2xl text-gray-400 mr-1 font-bold">Rp</span><span id="v18-rupiah-total" class="data-value summary-value !text-3xl text-pink-med loading-animation !tracking-normal">...</span></div>
                        <p class="text-xs text-gray-500 mt-1">Akumulasi biaya listrik yang dihemat.</p>
                    </div>
                </div>

                <h2 class="text-xl font-semibold text-gray-300 mb-4 mt-8">Grafik Daya</h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="power-summary-card">
                        <p class="text-sm text-gray-400">Daya PV (Input)</p>
                        <div class="flex items-baseline mt-1"><span id="v2-pzem-power-chart" class="text-2xl font-bold text-dc-color loading-animation">...</span><span id="v2-pzem-power-chart-unit" class="text-base text-dc-color ml-1"></span></div>
                        <p class="text-xs text-gray-500 mt-1" id="v2-status-time">Status 00:00:00</p>
                    </div>
                    <div class="power-summary-card">
                        <p class="text-sm text-gray-400">Beban AC (Output)</p>
                        <div class="flex items-baseline mt-1"><span id="v14-power-chart" class="text-2xl font-bold text-ac-color loading-animation">...</span><span id="v14-power-chart-unit" class="text-base text-ac-color ml-1"></span></div>
                        <p class="text-xs text-gray-500 mt-1" id="v14-status-time">Status 00:00:00</p>
                    </div>
                    <div class="power-summary-card">
                        <p class="text-sm text-gray-400">Self-Consumption</p>
                        <div class="flex items-baseline mt-1"><span id="self-consumption-calc" class="text-2xl font-bold text-chart-self-consumption loading-animation">...</span><span id="self-consumption-calc-unit" class="text-base text-chart-self-consumption ml-1">%</span></div>
                        <p class="text-xs text-gray-500 mt-1">Daya PV yang digunakan.</p>
                    </div>
                    <div class="power-summary-card">
                        <p class="text-sm text-gray-400">Potensi Surplus</p>
                        <div class="flex items-baseline mt-1"><span id="potensi-surplus-calc" class="text-2xl font-bold text-chart-surplus loading-animation">...</span><span id="potensi-surplus-calc-unit" class="text-base text-chart-surplus ml-1">W</span></div>
                        <p class="text-xs text-gray-500 mt-1">Daya PV yang berlebih.</p>
                    </div>
                </div>

                <!-- GRAFIK ENERGI HISTORIS (CHART.JS) -->
                <div class="solar-card p-4 sm:p-6">
                    
                    <div class="flex flex-wrap justify-start space-x-3 mb-2">
                        <button onclick="resetChartZoom()" class="px-3 py-1 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition flex items-center mb-2"><i data-lucide="rotate-ccw" class="lucide w-4 h-4 mr-1"></i>Reset Zoom</button>
                        <button onclick="toggleFullscreen()" class="px-3 py-1 text-xs font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition flex items-center space-x-1 mb-2"><i id="fullscreen-chart-icon" data-lucide="maximize" class="lucide w-4 h-4"></i><span id="fullscreen-chart-text">Full Layar</span></button>
                    </div>
                    
                    <div id="realtime-chart-container" class="w-full">
                        <canvas id="realtime-power-chart"></canvas>
                    </div>
                </div>

                <!-- DETAIL MONITORING (DC dan AC) -->
                <h2 class="text-xl font-semibold text-gray-300 mb-4 mt-8">Detail Sistem</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="solar-card">
                        <h3 class="text-xl font-semibold text-dc-color flex items-center border-b border-gray-700 pl-4"><i data-lucide="panel-top-open" class="lucide w-5 h-5 mr-2 text-dc-color"></i>Panel Surya (DC)</h3>
                        <div>
                            <!-- Arus PV (V1) - Tetap DC Color/Stabilo -->
                            <div class="detail-item">
                                <div class="flex items-center metric-title text-white"><i data-lucide="activity" class="lucide w-4 h-4 mr-3 text-dc-color"></i>Arus PV</div>
                                <div class="nominal-color text-dc-color"><span id="v1-pzem-current" class="text-lg font-bold loading-animation">...</span><span id="v1-pzem-current-unit" class="text-sm ml-1"></span></div>
                            </div>
                            <!-- PV Peak (V6) - Diubah menjadi Pink Med -->
                            <div class="detail-item">
                                <div class="flex items-center metric-title text-white"><i data-lucide="mountain" class="lucide w-4 h-4 mr-3 text-pink-med"></i>PV Peak</div>
                                <div class="nominal-color text-pink-med"><span id="v6-pv-peak" class="text-lg font-bold loading-animation">...</span><span id="v6-pv-peak-unit" class="text-sm ml-1"></span></div>
                            </div>
                            <!-- Eefisiensi PV (V5) - Diubah menjadi Chart Self-Consumption (Cyan) -->
                            <div class="detail-item">
                                <div class="flex items-center metric-title text-white"><i data-lucide="percent" class="lucide w-4 h-4 mr-3 text-chart-self-consumption"></i>Eefisiensi PV</div>
                                <div class="nominal-color text-chart-self-consumption"><span id="v5-pv-persen" class="text-lg font-bold loading-animation">...</span><span id="v5-pv-persen-unit" class="text-sm ml-1"></span></div>
                            </div>
                            <!-- Matahari Efektif (V4) - Diubah menjadi Purple 400 -->
                            <div class="detail-item">
                                <div class="flex items-center metric-title text-white"><i data-lucide="clock" class="lucide w-4 h-4 mr-3 text-purple-400"></i>Matahari Efektif</div>
                                <div class="nominal-color text-purple-400"><span id="v4-sunhour" class="text-lg font-bold loading-animation">...</span><span id="v4-sunhour-unit" class="text-sm ml-1"></span></div>
                            </div>
                            <!-- Max Energi PV (V11) - Diubah menjadi Green 400 -->
                            <div class="detail-item">
                                <div class="flex items-center metric-title text-white"><i data-lucide="layers-3" class="lucide w-4 h-4 mr-3 text-green-400"></i>Max Energi PV</div>
                                <div class="nominal-color text-green-400"><span id="v11-total-pv" class="text-lg font-bold loading-animation">...</span><span id="v11-total-pv-unit" class="text-sm ml-1"></span></div>
                            </div>
                        </div>
                    </div>
                    <div class="solar-card">
                        <h3 class="text-xl font-semibold text-blue-bat flex items-center border-b border-gray-700 pl-4"><i data-lucide="battery-full" class="lucide w-5 h-5 mr-2 text-blue-bat"></i>Baterai & Energi</h3>
                        <div>
                            <div class="detail-item"><div class="flex items-center metric-title text-white"><i data-lucide="bolt" class="lucide w-4 h-4 mr-3 text-pink-med"></i>Bus Voltase</div><div class="nominal-color"><span id="v0-pzem-voltage" class="text-lg font-bold loading-animation">...</span><span id="v0-pzem-voltage-unit" class="text-sm ml-1"></span></div></div>
                            <div class="detail-item"><div class="flex items-center metric-title text-white"><i data-lucide="battery-full" class="lucide w-4 h-4 mr-3 text-blue-bat"></i>Baterai Max</div><div class="nominal-color"><span id="v7-batere-peak" class="text-lg font-bold loading-animation">...</span><span id="v7-batere-peak-unit" class="text-sm ml-1"></span></div></div>
                            <div class="detail-item"><div class="flex items-center metric-title text-white"><i data-lucide="battery-low" class="lucide w-4 h-4 mr-3 text-warning-red"></i>Baterai Low</div><div class="nominal-color"><span id="v8-batere-low" class="text-lg font-bold loading-animation">...</span><span id="v8-batere-low-unit" class="text-sm ml-1"></span></div></div>
                            <div class="detail-item"><div class="flex items-center metric-title text-white"><i data-lucide="battery-medium" class="lucide w-4 h-4 mr-3 text-blue-bat"></i>Kapasitas Baterai</div><div class="nominal-color"><span id="v9-batere-ah" class="text-lg font-bold loading-animation">...</span><span id="v9-batere-ah-unit" class="text-sm ml-1"></span></div></div>
                            <div class="detail-item"><div class="flex items-center metric-title text-white"><i data-lucide="gauge" class="lucide w-4 h-4 mr-3 text-dc-color"></i>Total Energi DC</div><div class="nominal-color"><span id="v3-pzem-energy" class="text-lg font-bold loading-animation">...</span><span id="v3-pzem-energy-unit" class="text-sm ml-1"></span></div></div>
                        </div>
                    </div>
                    <div class="solar-card">
                        <h3 class="text-xl font-semibold text-ac-color flex items-center border-b border-gray-700 pl-4"><i data-lucide="plug-zap" class="lucide w-5 h-5 mr-2 text-ac-color"></i>Inverter & Beban (AC)</h3>
                        <div>
                            <div class="detail-item"><div class="flex items-center metric-title text-white"><i data-lucide="bolt" class="lucide w-4 h-4 mr-3 text-ac-color"></i>Tegangan AC</div><div class="nominal-color"><span id="v12-voltage" class="text-lg font-bold loading-animation">...</span><span id="v12-voltage-unit" class="text-sm ml-1"></span></div></div>
                            <div class="detail-item"><div class="flex items-center metric-title text-white"><i data-lucide="activity" class="lucide w-4 h-4 mr-3 text-ac-color"></i>Arus AC</div><div class="nominal-color"><span id="v13-current" class="text-lg font-bold loading-animation">...</span><span id="v13-current-unit" class="text-sm ml-1"></span></div></div>
                            <div class="detail-item"><div class="flex items-center metric-title text-white"><i data-lucide="refresh-cw" class="lucide w-4 h-4 mr-3 text-pink-med"></i>Frequensi</div><div class="nominal-color"><span id="v16-frequency" class="text-lg font-bold loading-animation">...</span><span id="v16-frequency-unit" class="text-sm ml-1"></span></div></div>
                            <div class="detail-item"><div class="flex items-center metric-title text-white"><i data-lucide="maximize-2" class="lucide w-4 h-4 mr-3 text-warning-red"></i>Inverter Peak</div><div class="nominal-color"><span id="v20-inverter-peak" class="text-lg font-bold loading-animation">...</span><span id="v20-inverter-peak-unit" class="text-sm ml-1"></span></div></div>
                           <div class="detail-item"><div class="flex items-center metric-title text-white"><i data-lucide="layers-3" class="lucide w-4 h-4 mr-3 text-ac-color"></i>Total Energi AC</div><div class="nominal-color"><span id="v15-energy" class="text-lg font-bold loading-animation">...</span><span id="v15-energy-unit" class="text-sm ml-1"></span></div></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- BMS MONITORING -->
        <div id="bms-content-section" class="w-full mt-12 pt-8 border-t border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col items-center text-center w-full mb-8">
                    <div class="flex items-center justify-center">
                        <div class="p-2 rounded-lg mr-2"><i data-lucide="battery-full" class="lucide w-7 h-7 text-blue-bat"></i></div>
                        <div><h2 class="text-3xl sm:text-4xl font-extrabold text-blue-bat tracking-tight">BMS MONITORING</h2></div>
                    </div>
                    <p class="text-gray-400 mt-0.5 text-lg">Detail Tegangan Sel dan Kesehatan Baterai.</p>
                    <div class="mt-2 text-xs text-gray-400">IP Logger: <span class="font-bold text-white" id="bms-logger-ip-header-desktop">N/A</span></div>
                </div>

                <main class="w-full">
                    <h3 class="text-xl font-semibold text-gray-300 mb-4">Ringkasan Baterai</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
                      <div class="solar-card p-4 shadow-xl">
                          <div class="flex justify-between items-center mb-2"><i data-lucide="battery-charging" class="lucide w-7 h-7 text-blue-bat" id="icon-soc-summary"></i><span class="text-3xl font-extrabold text-blue-bat" id="summary-soc">N/A</span></div>
                          <p class="text-sm font-medium text-gray-400">SOC</p>
                          <div class="progress-bar mt-2"><div id="soc-progress-summary" class="progress-fill" style="width: 0%"></div></div>
                      </div>
                      <div class="solar-card p-4 shadow-xl">
                          <div class="flex justify-between items-center mb-2"><i data-lucide="heart-pulse" class="lucide w-7 h-7 text-green-400" id="icon-soh-summary"></i><span class="text-3xl font-extrabold text-green-400" id="summary-soh">N/A</span></div>
                          <p class="text-sm font-medium text-gray-400">SOH</p>
                          <div class="progress-bar mt-2"><div id="soh-progress-summary" class="progress-fill bg-green-500" style="width: 0%"></div></div>
                      </div>
                      <div class="solar-card p-4 shadow-xl">
                          <div class="flex justify-between items-center mb-2"><i data-lucide="activity" class="lucide w-7 h-7 text-dc-color" id="icon-current-summary"></i><div class="flex items-baseline"><span class="text-3xl font-extrabold text-dc-color" id="summary-current">N/A</span><span class="text-3xl font-extrabold text-dc-color ml-1" id="summary-current-unit">A</span></div></div>
                          <p class="text-sm font-medium text-gray-400">Arus Baterai</p>
                          <p class="text-xs text-gray-500 mt-1" id="current-status-text">Total Arus Sistem</p>
                      </div>
                      <div class="solar-card p-4 shadow-xl">
                          <div class="flex justify-between items-center mb-2"><i data-lucide="power" class="lucide w-7 h-7 text-dc-color" id="icon-power-summary"></i><div class="flex items-baseline"><span class="text-3xl font-extrabold text-dc-color" id="summary-power">N/A</span><span class="text-3xl font-extrabold text-dc-color ml-1" id="summary-power-unit">W</span></div></div>
                          <p class="text-sm font-medium text-gray-400">Daya Baterai</p>
                          <p class="text-xs text-gray-500 mt-1" id="power-status-text">Total Daya Sistem</p>
                      </div>
                      <div class="solar-card p-4 shadow-xl">
                          <div class="flex justify-between items-center mb-2"><i data-lucide="bolt" class="lucide w-7 h-7 text-yellow-500" id="icon-pack-voltage-summary"></i><div class="flex items-baseline"><span class="text-3xl font-extrabold text-yellow-500" id="summary-voltage">N/A</span><span class="text-3xl font-extrabold text-yellow-500 ml-1">V</span></div></div>
                          <p class="text-sm font-medium text-gray-400">Tegangan Pack</p>
                          <p class="text-xs text-gray-500 mt-1" id="summary-voltage-desc">Rata-rata Tegangan Pack</p>
                      </div>
                      <div class="solar-card p-4 shadow-xl">
                          <div class="flex justify-between items-center mb-2"><i data-lucide="zap-off" class="lucide w-7 h-7 text-purple-400" id="icon-bus-voltage-summary"></i><div class="flex items-baseline"><span class="text-3xl font-extrabold text-purple-400" id="summary-bus-voltage">N/A</span><span class="text-3xl font-extrabold text-purple-400 ml-1" id="summary-bus-voltage-unit">V</span></div></div>
                          <p class="text-sm font-medium text-gray-400">Tegangan Bus</p>
                          <p class="text-xs text-gray-500 mt-1" id="summary-bus-voltage-unit-desc">Rata-rata Tegangan Bus </p>
                      </div>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-300 mb-4 mt-8">Baterai Terhubung (<span id="total-batteries">0</span>)</h3>
                    <div id="batteryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-5"></div>

                    <div id="empty-state" class="hidden text-center py-12 solar-card rounded-xl shadow-sm">
                      <div class="text-blue-500 mb-4"><i data-lucide="battery-off" class="lucide text-5xl opacity-50"></i></div>
                      <h3 class="text-lg font-medium text-gray-300 mb-2">Tidak ada baterai terhubung</h3>
                      <p class="text-gray-400 max-w-md mx-auto">Data baterai akan muncul di sini setelah sistem BMS Anda terhubung dan mengirim data.</p>
                    </div>
                  </div>
                </main>
            </div>
        </div>

        <footer id="app-footer" class="mt-12 text-center text-gray-500 text-sm py-4 border-t border-gray-700">
            <p>DESIGN THEME BY AEPRO PLTS.</p>
            <div class="mt-1 text-xs text-gray-600">BMS IP: <span class="font-bold text-gray-400" id="bms-logger-ip-footer">N/A</span></div>
        </footer>

    </div>

    <!-- Script Fungsionalitas -->
    <script>
        // ==========================================================
        // KONSTANTA & VARIABEL GLOBAL
        // ==========================================================
        const INSTANT_SERVER_IP = 'iot.serangkota.go.id:9443';
        const INSTANT_AUTH_TOKEN = 'q3SRjKexoyK-dgb5dM21WxgFSRQBdqDh';
        const INSTANT_PV_PERCENT = 0.0; 
        const INSTANT_LOAD_PERCENT = 0.0;
        const BMS_MQTT_TOPIC_KEY = "316506218";
        const NOMINAL_BATTERY_AH = 100.0; 
        const INVERTER_DISCHARGE_EFFICIENCY = 1.0; 
        const KWH_CALIBRATION_FACTOR = 1 + (6.2 / 100); 
        const CURRENT_THRESHOLD_A = 0.1;

        const STORAGE_KEY_CHARGE = 'dailyChargeWh';
        const STORAGE_KEY_DISCHARGE = 'dailyDischargeWh';
        const STORAGE_KEY_RESET_DATE = 'dailyResetDate';

        // --- KONSTANTA UNTUK LOGIKA SLIDING WINDOW (5 detik/data point) ---
        const UPDATE_INTERVAL_MS = 5000;
        const SECONDS_PER_UPDATE = UPDATE_INTERVAL_MS / 1000;
        // 24 jam * (3600 detik/jam) / (5 detik/update) = 17280 data points
        const MAX_DATA_POINTS = Math.ceil((24 * 3600) / SECONDS_PER_UPDATE); 
        const POINTS_PER_HOUR = 3600 / SECONDS_PER_UPDATE; // 720 points/jam
        const POINTS_PER_30_MIN = POINTS_PER_HOUR / 2; // 360 points/30 menit
        const POINTS_PER_10_MIN = POINTS_PER_HOUR / 6; // 120 points/10 menit
        const STORAGE_KEY_CHART_DATA = 'aepro_plts_chart_data_sliding';
        // -------------------------------------------------------------------

        let lastUpdateTime = Date.now();
        let dailyChargeWh = 0;
        let dailyDischargeWh = 0;
        // Waktu yang diharapkan untuk titik data berikutnya (untuk menjaga agar waktu sumbu X terus berjalan)
        let nextDataPointTime = Date.now();
        
        const PIN_MAPPINGS = {
            'V10': 'v10-kwh-today', 'V21': 'v21-kwh-today-ac', 'V19': 'v19-rupiah-day', 'V18': 'v18-rupiah-total',
            'V2': 'v2-pzem-power-chart', 'V14': 'v14-power-chart',
            'V0': 'v0-pzem-voltage', 'V1': 'v1-pzem-current', 'V6': 'v6-pv-peak', 'V5': 'v5-pv-persen',
            'V7': 'v7-batere-peak', 'V8': 'v8-batere-low', 'V9': 'v9-batere-ah', 'V4': 'v4-sunhour',
            'V3': 'v3-pzem-energy', 'V11': 'v11-total-pv',
            'V12': 'v12-voltage', 'V13': 'v13-current', 'V15': 'v15-energy', 'V16': 'v16-frequency', 'V20': 'v20-inverter-peak',
        };
        
        const UPDATE_INTERVAL = 5000;

        let fetchInterval = null;
        let serverIp = INSTANT_SERVER_IP;
        let authToken = INSTANT_AUTH_TOKEN;
        let ENERGY_CALIBRATION_PERCENT = INSTANT_PV_PERCENT;
        let LOAD_CALIBRATION_PERCENT = INSTANT_LOAD_PERCENT;
        let energyChartInstance = null;
        
        // Data diinisialisasi sebagai array kosong, akan diisi dari localStorage
        window.realtimeData = { 
            labels: [], 
            pvPower: [], 
            acLoad: []
        };
        
        let client;
        let batteries = [];
        let currentAddr = null;
        const cardTimers = {};
        let lastRenderedAddresses = '';

        const DEFAULT_DISPLAY = 0.0;
        const DEFAULT_DISPLAY_STR = '--';
        const CONFIG_PV_PEAK_WATT_DEFAULT = 2000.0;
        const CONFIG_EFFECTIVE_SUN_HOURS_DEFAULT = 5.0;

        let vpack = DEFAULT_DISPLAY;
        let current = DEFAULT_DISPLAY;

        let latestDiagramData = {
            solarPower: DEFAULT_DISPLAY, loadPower: DEFAULT_DISPLAY, batteryPower: DEFAULT_DISPLAY, rawBmsPower: DEFAULT_DISPLAY,
            gridPower: 0.0, rawGridPower: DEFAULT_DISPLAY, dailySolar: DEFAULT_DISPLAY_STR, dailyLoad: DEFAULT_DISPLAY_STR,
            dailyGridBuy: DEFAULT_DISPLAY_STR, dailyGridSell: DEFAULT_DISPLAY_STR, dailyBatCharge: DEFAULT_DISPLAY_STR,
            dailyBatDischarge: DEFAULT_DISPLAY_STR, pvPeakPower: CONFIG_PV_PEAK_WATT_DEFAULT, pvEfficiency: DEFAULT_DISPLAY,
            effectiveSunHours: CONFIG_EFFECTIVE_SUN_HOURS_DEFAULT, batterySOC: 0, batterySOH: 100, batteryRemainingEnergy: DEFAULT_DISPLAY,
            inverterVoltage: DEFAULT_DISPLAY_STR + ' V', inverterCurrent: DEFAULT_DISPLAY_STR + ' A', loadFrequency: DEFAULT_DISPLAY_STR + ' Hz',
            pvVoltage: DEFAULT_DISPLAY_STR + ' V', pvCurrent: DEFAULT_DISPLAY_STR + ' A', inverterStatus: DEFAULT_DISPLAY_STR,
            autarkyPercentage: DEFAULT_DISPLAY, ratioPercentage: DEFAULT_DISPLAY, totalSolarMWh: 0.0
        };

        const DIAGRAM_BLYNK_MAPPING = {
            'V0': { key: 'pvVoltage', unit: 'V', isVoltage: true }, 'V1': { key: 'pvCurrent', unit: 'A', isCurrent: true },
            'V2': { key: 'solarPower', unit: 'W', isPower: true }, 'V3': { key: 'dailySolar', unit: 'kWh', isDailyEnergy: true },
            'V11': { key: 'totalSolarMWh', isTotalEnergy: true }, 'V4': { key: 'effectiveSunHours', isStatic: true },
            'V6': { key: 'pvPeakPower', isStatic: true }, 'V12': { key: 'inverterVoltage', unit: 'V', isVoltage: true },
            'V13': { key: 'inverterCurrent', unit: 'A', isCurrent: true }, 'V14': { key: 'loadPower', unit: 'W', isPower: true },
            'V16': { key: 'loadFrequency', unit: 'Hz', isFrequency: true }, 'V21': { key: 'dailyLoad', unit: 'kWh', isDailyEnergy: true },
            'V7': { key: 'vpack', isGlobal: true, isBatVoltage: true }, 'V9': { key: 'current', isGlobal: true, isBatCurrent: true },
            'V10': { key: 'dailyBatCharge', unit: 'kWh', isDailyEnergy: true, isBatCharge: true},
        };

        // ==========================================================
        // UTILITY FUNCTIONS
        // ==========================================================

        function loadDailyEnergy() {
            dailyChargeWh = parseFloat(localStorage.getItem(STORAGE_KEY_CHARGE) || '0');
            dailyDischargeWh = parseFloat(localStorage.getItem(STORAGE_KEY_DISCHARGE) || '0');
        }
        
        function saveDailyEnergy() {
             localStorage.setItem(STORAGE_KEY_CHARGE, dailyChargeWh.toString());
             localStorage.setItem(STORAGE_KEY_DISCHARGE, dailyDischargeWh.toString());
        }

        // FUNGSI INI DIJAGA HANYA UNTUK RESET ENERGI HARIAN (kWh), BUKAN DATA CHART
        function resetDailyEnergy() {
            const now = new Date();
            const todayDate = now.toISOString().split('T')[0]; 
            const lastResetDate = localStorage.getItem(STORAGE_KEY_RESET_DATE);

            if (lastResetDate !== todayDate) {
                 dailyChargeWh = 0;
                 dailyDischargeWh = 0;
                 localStorage.setItem(STORAGE_KEY_RESET_DATE, todayDate); 
                 localStorage.setItem(STORAGE_KEY_CHARGE, '0');
                 localStorage.setItem(STORAGE_KEY_DISCHARGE, '0');
                 
                 document.getElementById("daily_bat_charge_value").textContent = "0.00 kWh";
                 document.getElementById("daily_bat_dischcharge_value").textContent = "0.00 kWh";
                 
                 console.log(`[DAILY ENERGY RESET] Daily energy reset to 0 and date updated. New date: ${todayDate}`);
            }
        }
        
        function updateBatteryEnergy(voltage, current) {
            resetDailyEnergy(); 

            const now = Date.now();
            const dt = (now - lastUpdateTime) / 1000; 
            lastUpdateTime = now;
            const power = voltage * current; 
            const energyWh = (power * dt) / 3600; 
            const chargeThreshold = 0.5;
            
            if (current > chargeThreshold) {
                dailyChargeWh += energyWh;
            } else if (current < -chargeThreshold) {
                dailyDischargeWh += Math.abs(energyWh);
            }
            saveDailyEnergy();

            document.getElementById("daily_bat_charge_value").textContent = (dailyChargeWh / 1000).toFixed(2) + " kWh";
            document.getElementById("daily_bat_dischcharge_value").textContent = (dailyDischargeWh / 1000).toFixed(2) + " kWh";
        }

        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

        function safeUpdate(id, content, isHtml = false) {
            const el = document.getElementById(id);
            if (el) {
                isHtml ? el.innerHTML = content : el.textContent = content;
            }
        }

        function getCurrentTimeHHMMSS() {
            const now = new Date();
            return now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }

        function tryParseFloat(value) {
            const parsed = parseFloat(value);
            return isNaN(parsed) || value === null || value === undefined ? DEFAULT_DISPLAY : parsed;
        }

        function updateTime() {
            const now = new Date();
            const dateOptions = { day: 'numeric', month: 'short', year: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const dateStr = now.toLocaleDateString('id-ID', dateOptions);
            const timeStr = now.toLocaleTimeString('id-ID', timeOptions);
            safeUpdate('current-date', dateStr);
            safeUpdate('current-time', timeStr);
            safeUpdate('v2-status-time', `Status ${timeStr}`);
            safeUpdate('v14-status-time', `Status ${timeStr}`);
        }

        function showMessage(message, type = 'warning') {
            /* Logic removed to reduce length, but preserved as comment placeholder */
        }

        function showDiagramStatus(message, type = 'warning') {
            /* Logic removed to reduce length, but preserved as comment placeholder */
        }

        function closeModal() {
            const pltsModal = document.getElementById('custom-modal');
            if (pltsModal) { pltsModal.classList.add('hidden'); pltsModal.classList.remove('flex'); }
            const batteryModal = document.getElementById("batteryModal");
            if (batteryModal) { batteryModal.classList.add('hidden'); batteryModal.classList.remove('flex'); currentAddr = null; }
        }

        function blinkLed(id) {
          const el = document.getElementById(id);
          if (!el) return;
          el.classList.remove("bg-gray-300");
          el.classList.add("active");
          setTimeout(() => {
            el.classList.remove("active");
            el.classList.add("bg-gray-300");
          }, 250);
        }

        function removeColorClasses(element, prefix) {
            if (element) {
                // Hapus kelas yang dimulai dengan prefix, biasanya untuk warna (misal: text-dc-color)
                Array.from(element.classList).forEach(className => {
                    if (className.startsWith(prefix)) {
                        element.classList.remove(className);
                    }
                });
            }
        }

        /**
         * FUNGSI KRITIS: Menambahkan kelas warna Tailwind/CSS khusus
         */
        function removeMetricColorClasses(element) { 
            if (!element) return;
            // Hapus kelas warna spesifik yang digunakan di BMS summary
            const colorClasses = ['text-dc-color', 'text-amp-discharging', 'text-charging', 'text-discharging', 'text-standby', 'text-pink-400', 'text-yellow-500', 'text-purple-400'];
            colorClasses.forEach(c => element.classList.remove(c));
        }

        function getSocColorClasses(soc) {
            let textColor = 'text-soc-yellow';
            let progressColor = 'bg-soc-yellow';
            let socColorClass = 'text-blue-bat'; // Default/placeholder
            
            if (soc > 70) { 
                textColor = 'text-soc-green'; 
                progressColor = 'bg-soc-green'; 
                socColorClass = 'text-green-400';
            }
            else if (soc >= 30) { 
                textColor = 'text-soc-yellow'; 
                progressColor = 'bg-soc-yellow'; 
                socColorClass = 'text-yellow-400';
            }
            else if (soc < 30) { 
                textColor = 'text-soc-red'; 
                progressColor = 'bg-soc-red'; 
                socColorClass = 'text-warning-red';
            }
            // Classes to clean up
            const textClassesToRemove = ['text-soc-red', 'text-soc-yellow', 'text-soc-green', 'text-blue-bat', 'text-green-400', 'text-warning-red', 'text-yellow-400', 'text-charging', 'text-discharging', 'text-standby', 'text-dc-color'];
            const bgClassesToRemove = ['bg-soc-red', 'bg-soc-yellow', 'bg-soc-green', 'bg-blue-500', 'bg-yellow-500', 'bg-red-500', 'bg-gray-500'];
            
            return { textColor, progressColor, textClassesToRemove, bgClassesToRemove, socColorClass };
        }

        // ==========================================================
        // BMS LOGIC
        // ==========================================================

        function getAggregatedBmsData() {
            let totalSoc = 0, totalSoh = 0, totalVoltage = 0, totalCurrent = 0, totalRemCapacity = 0, totalCapacity = 0, totalBusVoltage = 0;
            let validCount = 0, validCapacityCount = 0;

            batteries.forEach(b => {
                const soc = tryParseFloat(b.soc), soh = tryParseFloat(b.soh), voltage = tryParseFloat(b.voltage);
                const current = tryParseFloat(b.current), remCapacity = tryParseFloat(b.remaining);
                const capacity = tryParseFloat(b.capacity), busVoltage = tryParseFloat(b.busVoltage);

                if (!isNaN(current)) totalCurrent += current;
                if (!isNaN(soc) && !isNaN(voltage) && soc >= 0) { totalSoc += soc; totalVoltage += voltage; validCount++; }
                if (!isNaN(soh) && soh >= 0) totalSoh += soh;
                if (!isNaN(remCapacity) && remCapacity > 0) { totalRemCapacity += remCapacity; validCapacityCount++; }
                if (!isNaN(capacity)) totalCapacity += capacity;
                if (!isNaN(busVoltage)) totalBusVoltage += busVoltage;
            });

            const avgSoc = validCount > 0 ? totalSoc / validCount : 0;
            const avgSoh = validCount > 0 ? totalSoh / validCount : 100;
            const avgVoltage = validCount > 0 ? totalVoltage / validCount : DEFAULT_DISPLAY;
            const avgBusVoltage = validCount > 0 ? totalBusVoltage / validCount : DEFAULT_DISPLAY;
            let totalPowerDC = totalCurrent * avgVoltage;
            let remainingAh;
            let totalNominalAh;

            if (validCount === 0) {
                 totalNominalAh = NOMINAL_BATTERY_AH; 
                 remainingAh = 0;
            } else if (validCapacityCount > 0) {
                remainingAh = totalRemCapacity; 
                totalNominalAh = totalCapacity;
            } else {
                totalNominalAh = NOMINAL_BATTERY_AH * validCount; 
                remainingAh = (avgSoc / 100) * totalNominalAh;
            }

            return {
                soc: Math.round(avgSoc), soh: Math.round(avgSoh), voltage: avgVoltage, busVoltage: avgBusVoltage,
                current: totalCurrent, totalPower: totalPowerDC, remainingAh: remainingAh,
                totalCapacityAh: totalNominalAh, count: validCount
            };
        }

        function normalizeFromMqtt(data) {
             const cellVoltages = Array.isArray(data.cell_voltages) ? data.cell_voltages : [];
            const cells = cellVoltages.map(v => (v/1000).toFixed(3));
            const cell_vmax_val = cellVoltages.length > 0 ? Math.max(...cellVoltages) / 1000 : 'N/A';
            const cell_vmin_val = cellVoltages.length > 0 ? Math.min(...cellVoltages) / 1000 : 'N/A';
            let cell_vdiff_val = 'N/A';
            if (typeof cell_vmax_val === 'number' && typeof cell_vmin_val === 'number') {
                cell_vdiff_val = (cell_vmax_val - cell_vmin_val) * 1000;
            }

            const safeParseFloat = (value) => {
                  const parsed = parseFloat(value);
                  return isNaN(parsed) || value === null || value === undefined ? 'N/A' : parsed; 
            };

            const voltage = (data.bat_voltage !== undefined) ? data.bat_voltage : 'N/A';
            const current = (data.bat_current !== undefined) ? data.bat_current : 'N/A';
            const busVoltage = (data.bus_voltage !== undefined) ? data.bus_voltage : 'N/A';
            let power = 'N/A';
            if (typeof voltage === 'number' && typeof current === 'number' && !isNaN(voltage) && !isNaN(current)) {
                power = (parseFloat(voltage) * parseFloat(current)).toFixed(0);
            }

            const soc = safeParseFloat(data.SOC);
            let fullCapacity = (data.full_capacity !== undefined) ? safeParseFloat(data.full_capacity) : 'N/A';
            let remainingCapacity = (data.rem_capacity !== undefined) ? safeParseFloat(data.rem_capacity) : 'N/A';
            const nominalAhThreshold = 0.1;

            if (fullCapacity === 'N/A' || (typeof fullCapacity === 'number' && fullCapacity < nominalAhThreshold)) {
                fullCapacity = NOMINAL_BATTERY_AH;
            }

            if (remainingCapacity === 'N/A' || (typeof remainingCapacity === 'number' && remainingCapacity < nominalAhThreshold)) {
                if (typeof soc === 'number' && typeof fullCapacity === 'number') {
                    remainingCapacity = soc > nominalAhThreshold ? ((soc / 100) * fullCapacity) : 'N/A_FALLBACK'; 
                } else {
                    remainingCapacity = 'N/A';
                }
            }

            return {
              typeBattery: data.typeBattery || 'Baterai',
              addr: data.AddrBattery || 'N/A',
              soc: typeof soc === 'number' ? soc.toFixed(0) : 'N/A',
              soh: safeParseFloat(data.SOH) !== 'N/A' ? safeParseFloat(data.SOH).toFixed(0) : 'N/A',
              voltage: typeof voltage === 'number' ? parseFloat(voltage).toFixed(2) : voltage,
              busVoltage: typeof busVoltage === 'number' ? parseFloat(busVoltage).toFixed(2) : busVoltage,
              current: typeof current === 'number' ? parseFloat(current).toFixed(2) : current,
              capacity: typeof fullCapacity === 'number' ? fullCapacity.toFixed(2) : 'N/A',
              remaining: typeof remainingCapacity === 'number' ? remainingCapacity.toFixed(2) : (remainingCapacity === 'N/A_FALLBACK' ? 'N/A' : 'N/A'),
              cycles: safeParseFloat(data.cycle_count) !== 'N/A' ? parseInt(safeParseFloat(data.cycle_count) / 10) : 0,
              cell_vmax: typeof cell_vmax_val === 'number' ? cell_vmax_val.toFixed(3) : 'N/A',
              cell_vmin: typeof cell_vmin_val === 'number' ? cell_vmin_val.toFixed(3) : 'N/A',
              cell_vdif: typeof cell_vdiff_val === 'number' ? cell_vdiff_val.toFixed(0) : 'N/A',
              tempStatus: data.temp_status || 'Normal',
              time: getCurrentTimeHHMMSS(),
              cells: cellVoltages.map(v => (v/1000).toFixed(3)),
              power: power
            };
        }

        function startMQTT(){
            if (client && client.connected) return;
            client = mqtt.connect("wss://public.cloud.shiftr.io", { username: "public", password: "public", keepalive: 120 });

            client.on("connect", () => {
              client.subscribe("sysMon/"+BMS_MQTT_TOPIC_KEY+"/AutoPoll/#");
              client.subscribe("sysMon/"+BMS_MQTT_TOPIC_KEY+"/info/#");
            });

            client.on("message", (topic, message) => {
              if(topic == "sysMon/"+BMS_MQTT_TOPIC_KEY+"/info" ){
                let ip_address = message.toString().split(",")[0];
                if (ip_address && ip_address !== 'N/A') {
                    safeUpdate("bms-logger-ip-header-desktop", ip_address);
                    safeUpdate("bms-logger-ip-footer", ip_address);
                }
              } else {
                try {
                  const rawString = message.toString();
                  // Sanitize: Remove non-printable control characters (ASCII 0x00 to 0x1F) that break JSON parsing.
                  const sanitizedString = rawString.replace(/[\u0000-\u001F]/g, ''); 
                  const batt = normalizeFromMqtt(JSON.parse(sanitizedString));
                  const idx = batteries.findIndex(b => (b.addr === batt.addr)&&(b.typeBattery === batt.typeBattery));
                  if (idx >= 0) { batteries[idx] = batt; } else { batt.elementId = `battery-${batt.typeBattery}-${batt.addr}`; batteries.push(batt); }
                  renderCards(batt);
                  updateModal();
                  const bmsAggregatedData = getAggregatedBmsData();
                  calculateAndRenderDiagram(bmsAggregatedData);
                  const totalVoltage = bmsAggregatedData.voltage;
                  const totalCurrent = bmsAggregatedData.current;
                  
                  if (totalVoltage !== DEFAULT_DISPLAY && totalCurrent !== 0) { updateBatteryEnergy(totalVoltage, totalCurrent); }
                } catch (e) {
                  console.error("Invalid JSON or Processing Error: ", e, e.stack);
                }
              }
            });
        }

        function openModal(addr) {
             currentAddr = addr;
            const modal = document.getElementById("batteryModal");
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                updateModal();
                 if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        }


        function updateModal() {
             const modal = document.getElementById("batteryModal");
            if (currentAddr === null || (modal && modal.classList.contains("hidden"))) return;

            const batt = batteries.find(b => b.addr === currentAddr);
            if (!batt) return;

            safeUpdate("modalAddr", batt.addr);
            const socValue = batt.soc !== 'N/A' ? parseInt(batt.soc) : NaN;
            
            // Perbaikan SOC: Gunakan fungsi baru untuk warna
            const { textColor: summaryTextColor, textClassesToRemove: summaryTextClassesToRemove, socColorClass } = getSocColorClasses(socValue);
            
            const modalSOCPercentEl = document.getElementById("modalSOCPercent");
            const modalSOCUnitEl = document.getElementById("modalSOCUnit");
            
            // Hapus kelas lama, terapkan kelas baru (socColorClass)
            if (modalSOCPercentEl) { removeColorClasses(modalSOCPercentEl, 'text-'); modalSOCPercentEl.classList.add(socColorClass); }
            if (modalSOCUnitEl) { removeColorClasses(modalSOCUnitEl, 'text-'); modalSOCUnitEl.classList.add(socColorClass); }

            safeUpdate("modalSOCPercent", batt.soc);
            safeUpdate("modalRemaining", batt.remaining !== 'N/A' ? `${batt.remaining}` : 'N/A');
            safeUpdate("modalSOHPercent", batt.soh);
            safeUpdate("modalCapacity", batt.capacity !== 'N/A' ? `${batt.capacity}` : 'N/A');
            safeUpdate("modalCycles", batt.cycles);
            safeUpdate("modalLastUpdate", batt.time);

            const currentVal = tryParseFloat(batt.current);
            const currentThreshold = CURRENT_THRESHOLD_A;
            let battStatusClass = 'text-standby';
            if (!isNaN(currentVal)) {
                  if (currentVal > currentThreshold) { battStatusClass = 'text-charging'; }
                  else if (currentVal < -currentThreshold) { battStatusClass = 'text-discharging'; }
            }

            const ampModalColor = battStatusClass === 'text-discharging' ? 'text-amp-discharging' : battStatusClass;
            const modalCurrentEl = document.getElementById("modalCurrent");
            if(modalCurrentEl){ removeColorClasses(modalCurrentEl, 'text-'); modalCurrentEl.classList.add(ampModalColor); safeUpdate("modalCurrent", batt.current !== 'N/A' ? `${batt.current} A` : 'N/A'); }

            let powerModalColor = battStatusClass === 'text-standby' ? 'text-power-standby' : (battStatusClass === 'text-discharging' ? 'text-discharging' : battStatusClass);
            const modalPowerEl = document.getElementById("modalPower");
            if(modalPowerEl){ removeColorClasses(modalPowerEl, 'text-'); modalPowerEl.classList.add(powerModalColor); safeUpdate("modalPower", batt.power !== 'N/A' ? `${batt.power} W` : 'N/A'); }

            const modalVoltageEl = document.getElementById("modalVoltage");
            const modalBusVoltageEl = document.getElementById("modalBusVoltage");
            if(modalVoltageEl) { removeColorClasses(modalVoltageEl, 'text-'); modalVoltageEl.classList.add('text-yellow-500'); safeUpdate("modalVoltage", batt.voltage !== 'N/A' ? `${batt.voltage} V` : 'N/A'); }
            if(modalBusVoltageEl) { removeColorClasses(modalBusVoltageEl, 'text-'); modalBusVoltageEl.classList.add('text-yellow-500'); safeUpdate("modalBusVoltage", batt.busVoltage !== 'N/A' ? `${batt.busVoltage} V` : 'N/A'); }

            const modalCellMinEl = document.getElementById("modalcellmin");
            const modalCellMaxEl = document.getElementById("modalcellmax");
            const modalCellDifEl = document.getElementById("modalcelldif");
            if(modalCellMinEl) { removeColorClasses(modalCellMinEl, 'text-'); modalCellMinEl.classList.add('text-red-400'); safeUpdate("modalcellmin", batt.cell_vmin !== 'N/A' ? `${batt.cell_vmin} V` : 'N/A'); }
            if(modalCellMaxEl) { removeColorClasses(modalCellMaxEl, 'text-'); modalCellMaxEl.classList.add('text-green-400'); safeUpdate("modalcellmax", batt.cell_vmax !== 'N/A' ? `${batt.cell_vmax} V` : 'N/A'); }
            if(modalCellDifEl) { removeColorClasses(modalCellDifEl, 'text-'); modalCellDifEl.classList.add('text-blue-400'); safeUpdate("modalcelldif", batt.cell_vdif !== 'N/A' ? `${batt.cell_vdif} mV` : 'N/A'); }
            
            safeUpdate("modalTemp", batt.tempStatus);

            const cellsDiv = document.getElementById("modalCells");
            const cellData = Array.isArray(batt.cells) ? batt.cells : [];
            if (cellsDiv) {
                cellsDiv.innerHTML = "";
                cellData.forEach((v, i) => {
                  const cellValue = parseFloat(v);
                  let textColor = 'text-green-400';
                  let borderColor = 'var(--green-cell)';
                  if (cellValue < 3.200) { textColor = 'text-red-400'; borderColor = 'var(--red-cell)'; }
                  else if (cellValue < 3.350) { textColor = 'text-yellow-400'; borderColor = 'var(--warning)'; }
                  else if (cellValue > 3.650) { textColor = 'text-blue-400'; borderColor = 'var(--blue-bat)'; }

                  const cellBox = document.createElement("div");
                  cellBox.innerHTML = `<div class="text-xs font-medium text-gray-400 mb-1">Sel ${i + 1}</div><div class="text-sm font-bold ${textColor}">${v} V</div>`;
                  cellBox.className = `cell-voltage bg-gray-800 rounded-lg shadow-sm p-3 flex flex-col items-start justify-center transition hover:bg-gray-700`;
                  cellBox.style.borderLeft = `4px solid ${borderColor}`;
                  cellsDiv.appendChild(cellBox);
                });
            }

            blinkLed("led-modal");
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        }
        
        /**
         * FUNGSI HELPER BARU: Menghapus kelas latar belakang yang bersaing pada progress bar.
         */
        function clearProgressBarColors(el) {
            if (!el) return;
            const classes = Array.from(el.classList);
            // Target semua prefix bg-soc- dan bg-tailwind yang mungkin bersaing
            const bgPrefixes = ['bg-soc-', 'bg-red-', 'bg-yellow-', 'bg-green-', 'bg-blue-', 'bg-gray-'];
            classes.forEach(className => {
                if (bgPrefixes.some(p => className.startsWith(p))) {
                    el.classList.remove(className);
                }
            });
        }

        const CORE_BMS_UNIT_CLASSES = ['text-3xl', 'font-extrabold'];
        
        function renderCards(datane) {
            const aggregated = getAggregatedBmsData();
            let totalCurrent = aggregated.current;
            let avgVoltage = aggregated.voltage;
            let avgBusVoltage = aggregated.busVoltage;
            let validBatteryCount = aggregated.count;
            let displayPower = aggregated.totalPower;

            const currentThreshold = CURRENT_THRESHOLD_A;
            const powerThresholdSummary = 10;
            let currentStatusText = 'Standby';
            let statusClass = 'text-standby';

            if (validBatteryCount > 0) {
                if (totalCurrent > currentThreshold) { statusClass = 'text-charging'; currentStatusText = 'Charging'; }
                else if (totalCurrent < -currentThreshold) { statusClass = 'text-discharging'; currentStatusText = 'Discharging'; }
                else { currentStatusText = 'Idle'; }
            }

            safeUpdate('summary-voltage', avgVoltage !== DEFAULT_DISPLAY ? avgVoltage.toFixed(2) : DEFAULT_DISPLAY_STR);
            safeUpdate('summary-bus-voltage', avgBusVoltage !== DEFAULT_DISPLAY ? avgBusVoltage.toFixed(2) : DEFAULT_DISPLAY_STR);
            const currentValDisplay = (Math.abs(totalCurrent) > currentThreshold) ? totalCurrent.toFixed(2) : DEFAULT_DISPLAY_STR;
            safeUpdate('summary-current', currentValDisplay); 
            safeUpdate('current-status-text', `Total Arus Sistem (${currentStatusText})`);
            const totalPowerValSigned = (Math.abs(displayPower) > powerThresholdSummary) ? displayPower.toFixed(0) : DEFAULT_DISPLAY_STR;
            safeUpdate('summary-power', totalPowerValSigned); 
            safeUpdate('power-status-text', `Total Daya Sistem (${currentStatusText})`); 

            const ampColorClass = statusClass === 'text-discharging' ? 'text-amp-discharging' : statusClass;
            let powerColorClass = statusClass === 'text-standby' ? 'text-power-standby' : (statusClass === 'text-discharging' ? 'text-discharging' : statusClass);
            
            const currentSummaryEl = document.getElementById('summary-current');
            const currentUnitEl = document.getElementById('summary-current-unit');
            const currentIconEl = document.getElementById('icon-current-summary');

            // --- PERBAIKAN: Arus Baterai ---
            if (currentSummaryEl) { 
                removeMetricColorClasses(currentSummaryEl); // Hapus hanya kelas warna
                currentSummaryEl.classList.add(ampColorClass, ...CORE_BMS_UNIT_CLASSES); 
            }
            if (currentUnitEl) { 
                removeMetricColorClasses(currentUnitEl); // Hapus hanya kelas warna
                currentUnitEl.classList.add(ampColorClass, ...CORE_BMS_UNIT_CLASSES); 
            }
            if (currentIconEl) { removeMetricColorClasses(currentIconEl); currentIconEl.classList.add(ampColorClass); }

            const powerSummaryEl = document.getElementById('summary-power');
            // FIX: Deklarasi iconIconEl yang menyebabkan error di bagian ini
            const iconPowerSummary = document.getElementById('icon-power-summary'); 
            const powerUnitEl = document.getElementById('summary-power-unit');
            
            // --- PERBAIKAN: Daya Baterai ---
            if (powerSummaryEl) { 
                removeMetricColorClasses(powerSummaryEl); 
                powerSummaryEl.classList.add(powerColorClass, ...CORE_BMS_UNIT_CLASSES); 
            }
            if (iconPowerSummary) { 
                removeMetricColorClasses(iconPowerSummary); 
                iconPowerSummary.classList.add(powerColorClass); 
            }
            if (powerUnitEl) { 
                removeMetricColorClasses(powerUnitEl); 
                powerUnitEl.classList.add(powerColorClass, ...CORE_BMS_UNIT_CLASSES); 
            }

            const voltageSummaryEl = document.getElementById('summary-voltage');
            // Menemukan elemen unit voltage (ml-1 V)
            const voltageUnitEl = voltageSummaryEl ? voltageSummaryEl.parentNode.querySelector('span:last-child') : null;
            
            const busVoltageSummaryEl = document.getElementById('summary-bus-voltage');
            // **FIXED TYPO:** busVoltageSummaryL diubah menjadi busVoltageSummaryEl
            const busVoltageUnitEl = busVoltageSummaryEl ? busVoltageSummaryEl.parentNode.querySelector('span:last-child') : null;
            
            // --- PERBAIKAN: Tegangan Pack ---
            if (voltageSummaryEl) {
                removeMetricColorClasses(voltageSummaryEl);
                voltageSummaryEl.classList.add('text-yellow-500', ...CORE_BMS_UNIT_CLASSES);
            }
            if (voltageUnitEl) {
                removeMetricColorClasses(voltageUnitEl);
                voltageUnitEl.classList.add('text-yellow-500', ...CORE_BMS_UNIT_CLASSES);
            }

            // --- PERBAIKAN: Tegangan Bus ---
            if (busVoltageSummaryEl) {
                removeMetricColorClasses(busVoltageSummaryEl);
                busVoltageSummaryEl.classList.add('text-purple-400', ...CORE_BMS_UNIT_CLASSES);
            }
            if (busVoltageUnitEl) {
                removeMetricColorClasses(busVoltageUnitEl);
                busVoltageUnitEl.classList.add('text-purple-400', ...CORE_BMS_UNIT_CLASSES);
            }

            // FIX: Deklarasi iconSocEl yang menyebabkan error. Harus ditargetkan dari DOM.
            const iconSocEl = document.getElementById('icon-soc-summary');
            const avgSOC = aggregated.soc;
            const avgSOH = aggregated.soh;
            const socValue = parseInt(avgSOC);
            
            // Perbaikan: Ambil semua info warna SOC yang baru
            const { progressColor: summaryProgressColor, socColorClass } = getSocColorClasses(socValue);
            
            const summarySocEl = document.getElementById('summary-soc');
            const socProgress = document.getElementById("soc-progress-summary");
            const sohProgress = document.getElementById("soh-progress-summary");

            safeUpdate('summary-soc', avgSOC !== 'N/A' ? `${avgSOC}%` : 'N/A');
            
            // Perbaikan: Terapkan warna SOC yang baru ke nilai teks SOC (ringkasan)
            if (summarySocEl) { 
                removeMetricColorClasses(summarySocEl); 
                summarySocEl.classList.add(socColorClass);
            }
            if (iconSocEl) { 
                removeMetricColorClasses(iconSocEl); 
                iconSocEl.classList.add(socColorClass); 
            }
            // Perbaikan KRITIS: Terapkan warna ke progress bar SOC (Ringkasan)
            if (!isNaN(socValue) && socProgress) {
                socProgress.style.width = `${socValue}%`;
                clearProgressBarColors(socProgress); // Hapus semua warna bg- yang bersaing
                socProgress.classList.add(summaryProgressColor);
            }

            safeUpdate('summary-soh', avgSOH !== 'N/A' ? `${avgSOH}%` : 'N/A');
            if (avgSOH !== 'N/A' && tryParseFloat(avgSOH) !== 0 && sohProgress) {
                const sohVal = parseInt(avgSOH);
                sohProgress.style.width = `${sohVal}%`;
                sohProgress.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
                if (sohVal > 80) sohProgress.classList.add('bg-green-500');
                else if (sohVal > 60) sohProgress.classList.add('bg-yellow-500');
                else sohProgress.classList.add('bg-red-500');
            }
            
            batteries.sort((a, b) => parseInt(a.addr) - parseInt(b.addr));
            const grid = document.getElementById("batteryGrid");
            const emptyState = document.getElementById("empty-state");
            if (batteries.length === 0) {
              if (grid) grid.classList.add('hidden');
              if (emptyState) emptyState.classList.remove('hidden');
              safeUpdate('total-batteries', '0');
              if (typeof lucide !== 'undefined') { lucide.createIcons(); }
              return;
            }

            if (grid) grid.classList.remove('hidden');
            if (emptyState) emptyState.classList.add('hidden');
            safeUpdate('total-batteries', batteries.length.toString());

            const currentAddresses = batteries.map(b => b.addr).join(',');

            if (currentAddresses !== lastRenderedAddresses || batteries.length !== grid.children.length) {
                if (grid) grid.innerHTML = '';
                const fragment = document.createDocumentFragment();

                batteries.forEach(batt => {
                    const socVal = parseInt(batt.soc);
                    const { progressColor: cardProgressColor, socColorClass } = getSocColorClasses(socVal); 
                    const battCurrentVal = tryParseFloat(batt.current);
                    let battStatusClass = 'text-standby';
                    if (!isNaN(battCurrentVal)) {
                        if (battCurrentVal > currentThreshold) { battStatusClass = 'text-charging'; }
                        else if (battCurrentVal < -currentThreshold) { battStatusClass = 'text-discharging'; }
                    }
                    let battAmpColorClass = battStatusClass === 'text-discharging' ? 'text-amp-discharging' : battStatusClass;
                    let battPowerClass = battStatusClass === 'text-standby' ? 'text-power-standby' : (battStatusClass === 'text-discharging' ? 'text-discharging' : battStatusClass);

                    let card = document.createElement("div");
                    card.id = `card-${batt.typeBattery}-${batt.addr}`;
                    card.className = "solar-card rounded-xl shadow-md p-5 cursor-pointer hover:shadow-lg transition fade-in";
                    card.dataset.addr = String(batt.addr);
                    card.onclick = () => openModal(batt.addr);

                    const socBarClass = !isNaN(socVal) ? cardProgressColor : 'bg-gray-500';
                    const socBarWidth = !isNaN(socVal) ? `${batt.soc}%` : '0%';
                    const cardSocTextColor = socColorClass;


                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-3 border-b border-gray-700 pb-2">
                            <h3 class="text-lg font-bold text-white">${batt.typeBattery} <span class="text-blue-400 font-semibold">#${batt.addr}</span></h3>
                            <div class="led" id="led-card-${batt.typeBattery}-${batt.addr}"></div>
                        </div>
                        <div class="mb-3">
                            <div class="flex justify-between items-center mb-1 text-sm">
                            <span class="text-gray-400">SOC</span>
                            <span class="font-bold ${cardSocTextColor}" id="soc-text-${batt.typeBattery}-${batt.addr}">${batt.soc}%</span>
                            <span class="font-bold text-gray-400">/ ${batt.soh}%</span>
                            </div>
                            <div class="progress-bar mt-1">
                                <div id="soc-bar-${batt.typeBattery}-${batt.addr}" class="progress-fill ${socBarClass}" style="width: ${socBarWidth}"></div>
                            </div>
                        </div>
                        <div class="battery-metric-grid text-xs mt-2">
                            <div class="battery-metric-item"><i data-lucide="zap" class="lucide w-6 h-4 text-yellow-500 mr-2"></i><div><div class="text-gray-500">Tegangan</div><div id="voltage-${batt.typeBattery}-${batt.addr}" class="font-semibold text-yellow-500">${batt.voltage} V</div></div></div>
                            <div class="battery-metric-item"><i data-lucide="activity" class="lucide w-4 h-4 ${battAmpColorClass} mr-2" id="current-icon-${batt.typeBattery}-${batt.addr}"></i><div><div class="text-gray-500">Arus</div><div id="current-${batt.typeBattery}-${batt.addr}" class="font-semibold ${battAmpColorClass}">${batt.current} A</div></div></div>
                            <div class="battery-metric-item"><i data-lucide="divide" class="lucide w-4 h-4 text-blue-400 mr-2"></i><div><div class="text-gray-500">Selisih Sel</div><div id="voltagedif-${batt.typeBattery}-${batt.addr}" class="font-semibold text-blue-400">${batt.cell_vdif} mV</div></div></div>
                            <div class="battery-metric-item"><i data-lucide="power" class="lucide w-4 h-4 ${battPowerClass} mr-2" id="power-icon-${batt.typeBattery}-${batt.addr}"></i><div><div class="text-gray-500">Daya</div><div id="power-${batt.typeBattery}-${batt.addr}" class="font-semibold ${battPowerClass}">${batt.power} W</div></div></div>
                            <div class="battery-metric-item"><i data-lucide="minus-circle" class="lucide w-4 h-4 text-red-500 mr-2"></i><div><div class="text-gray-500">Sel Min</div><div id="cellmin-${batt.typeBattery}-${batt.addr}" class="font-semibold text-red-400">${batt.cell_vmin} V</div></div></div>
                            <div class="battery-metric-item"><i data-lucide="plus-circle" class="lucide w-4 h-4 text-green-500 mr-2"></i><div><div class="text-gray-500">Sel Max</div><div id="cellmax-${batt.typeBattery}-${batt.addr}" class="font-semibold text-green-400">${batt.cell_vmax} V</div></div></div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-700 text-xs text-gray-400 flex justify-between">
                            <span>Siklus: ${batt.cycles}</span>
                            <span class="last-update" id="time-update-${batt.typeBattery}-${batt.addr}"><i data-lucide="clock" class="lucide w-3 h-3 inline mr-1"></i>${batt.time}</span>
                        </div>
                    `;

                    fragment.appendChild(card);
                });

                if (grid) grid.appendChild(fragment);
                lastRenderedAddresses = currentAddresses;
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            } else {
                const batt = batteries.find(b => (b.addr === datane.addr) && (b.typeBattery === datane.typeBattery));
                if (!batt) return;

                const socVal = parseInt(batt.soc);
                const { progressColor: cardProgressColor, socColorClass: cardSocTextColor } = getSocColorClasses(socVal);
                const battCurrentVal = tryParseFloat(batt.current);
                let battStatusClass = 'text-standby';
                if (!isNaN(battCurrentVal)) {
                    if (battCurrentVal > currentThreshold) { battStatusClass = 'text-charging'; }
                    else if (battCurrentVal < -currentThreshold) { battStatusClass = 'text-discharging'; }
                }
                let battAmpColorClass = battStatusClass === 'text-discharging' ? 'text-amp-discharging' : battStatusClass;
                let battPowerClass = battStatusClass === 'text-standby' ? 'text-power-standby' : (battStatusClass === 'text-discharging' ? 'text-discharging' : battStatusClass);

                const socBar = document.getElementById(`soc-bar-${batt.typeBattery}-${batt.addr}`);
                const socTextEl = document.getElementById(`soc-text-${batt.typeBattery}-${batt.addr}`);
                if (socBar && socTextEl) {
                    socBar.style.width = `${batt.soc}%`;
                    
                    // Perbaikan: Update warna teks SOC
                    removeMetricColorClasses(socTextEl);
                    socTextEl.classList.add(cardSocTextColor);

                    // Perbaikan KRITIS: Update warna bar SOC
                    clearProgressBarColors(socBar);
                    socBar.classList.add(cardProgressColor);
                }

                const currentTextEl = document.getElementById(`current-${batt.typeBattery}-${batt.addr}`);
                const currentIconCardEl = document.getElementById(`current-icon-${batt.typeBattery}-${batt.addr}`);
                if (currentTextEl && currentIconCardEl) {
                    removeMetricColorClasses(currentTextEl); currentTextEl.classList.add(battAmpColorClass);
                    removeMetricColorClasses(currentIconCardEl); currentIconCardEl.classList.add(battAmpColorClass);
                }

                const powerTextEl = document.getElementById(`power-${batt.typeBattery}-${batt.addr}`);
                const powerIconCardEl = document.getElementById(`power-icon-${batt.typeBattery}-${batt.addr}`);
                if (powerTextEl && powerIconCardEl) {
                    removeMetricColorClasses(powerTextEl); powerTextEl.classList.add(battPowerClass);
                    removeMetricColorClasses(powerIconCardEl); powerIconCardEl.classList.add(battPowerClass);
                }

                safeUpdate(`voltage-${batt.typeBattery}-${batt.addr}`, `${batt.voltage} V`);
                safeUpdate(`current-${batt.typeBattery}-${batt.addr}`, `${batt.current} A`);
                safeUpdate(`voltagedif-${batt.typeBattery}-${batt.addr}`, `${batt.cell_vdif} mV`);
                safeUpdate(`power-${batt.typeBattery}-${batt.addr}`, `${batt.power} W`);
                safeUpdate(`cellmin-${batt.typeBattery}-${batt.addr}`, `${batt.cell_vmin} V`);
                safeUpdate(`cellmax-${batt.typeBattery}-${batt.addr}`, `${batt.cell_vmax} V`);

                const timeUpdateEl = document.getElementById(`time-update-${batt.typeBattery}-${batt.addr}`);
                if (timeUpdateEl) {
                    timeUpdateEl.innerHTML = `<i data-lucide="clock" class="lucide w-3 h-3 inline mr-1"></i>${batt.time}`;
                    if (typeof lucide !== 'undefined') { lucide.createIcons({ scope: timeUpdateEl }); }
                }
                
                const led = document.getElementById(`led-card-${batt.typeBattery}-${batt.addr}`);
                // Perbaikan: Panggil blinkLed untuk kedip
                if (led) { blinkLed(led.id); }
            }

            const cardId = `card-${datane.typeBattery}-${datane.addr}`;
            if (cardTimers[cardId]) { clearTimeout(cardTimers[cardId]); }
            cardTimers[cardId] = setTimeout(() => {
                let c = document.getElementById(cardId);
                if (c) c.remove();
                delete cardTimers[cardId];
            }, 30000);
        }

        // ==========================================================
        // PLTS LOGIC & DIAGRAM LOGIC
        // ==========================================================
        
        // Helper function untuk parsing yang lebih aman
        const MONTHS_ID = { 'Jan': '0', 'Feb': '1', 'Mar': '2', 'Apr': '3', 'Mei': '4', 'Jun': '5', 'Jul': '6', 'Agu': '7', 'Sep': '8', 'Okt': '9', 'Nov': '10', 'Des': '11' };
        
        // FUNGSI INI KEMBALI MENGHASILKAN LABEL DENGAN TANGGAL/WAKTU LENGKAP
        function safeParseTimeLabel(label) {
            // Label format expected: "DD Mmm YYYY HH:MM"
            const regex = /(\d{2}) ([A-Za-z]{3}) (\d{4}) (\d{2}):(\d{2})/;
            const match = label.match(regex);

            if (match) {
                const [_, day, monthStr, year, hour, minute] = match;
                const normalizedMonth = MONTHS_ID[monthStr];
                
                if (normalizedMonth !== undefined) {
                    // +1 karena index bulan di JS dimulai dari 0
                    const safeDateString = `${year}-${String(parseInt(normalizedMonth) + 1).padStart(2, '0')}-${day}T${hour}:${minute}:00`;
                    return Date.parse(safeDateString);
                }
            }

            // Fallback: Try native Date.parse
            return Date.parse(label);
        }

        // FUNGSI INI KEMBALI MENGHASILKAN LABEL DENGAN TANGGAL/WAKTU LENGKAP UNTUK DISIMPAN
        function formatTimeLabel(date) {
            const dateOptions = { day: '2-digit', month: 'short', year: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
            // Contoh output: "26 Okt 2025 15:30"
            return date.toLocaleDateString('id-ID', dateOptions) + ' ' + date.toLocaleTimeString('id-ID', timeOptions);
        }


        function loadHistoricalData() {
            const savedData = localStorage.getItem(STORAGE_KEY_CHART_DATA);
            
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    
                    // Ambil data yang tersimpan
                    window.realtimeData.labels = parsedData.labels || [];
                    window.realtimeData.pvPower = parsedData.pvPower || [];
                    window.realtimeData.acLoad = parsedData.acLoad || [];

                    // Pastikan tidak melebihi batas 24 jam (MAX_DATA_POINTS)
                    const startIndex = Math.max(0, window.realtimeData.labels.length - MAX_DATA_POINTS);
                    if (startIndex > 0) {
                        window.realtimeData.labels = window.realtimeData.labels.slice(startIndex);
                        window.realtimeData.pvPower = window.realtimeData.pvPower.slice(startIndex);
                        window.realtimeData.acLoad = window.realtimeData.acLoad.slice(startIndex);
                    }
                    
                } catch (e) {
                    console.error("Error loading historical data:", e);
                    localStorage.removeItem(STORAGE_KEY_CHART_DATA);
                    // Jika gagal parse, data dimulai dari kosong (Sliding Window)
                    window.realtimeData = { labels: [], pvPower: [], acLoad: [] };
                }
            }
             // Reset zoom saat memuat data baru
            if (energyChartInstance) {
                energyChartInstance.update(); 
                resetChartZoom();
            }
        }

        function saveHistoricalData() {
            // Panggilan localStorage ini tetap paling berat, tetapi tidak ada alternatif 
            // jika data harus persisten di browser. Frekuensi 5 detik sudah minimal.
            localStorage.setItem(STORAGE_KEY_CHART_DATA, JSON.stringify(window.realtimeData));
        }

        function requestFullscreen(element) {
            if (element.requestFullscreen) { element.requestFullscreen(); } 
            else if (element.mozRequestFullScreen) { element.mozRequestFullScreen(); } 
            else if (element.webkitRequestFullscreen) { element.webkitRequestFullscreen(); } 
            else if (element.msRequestFullscreen) { element.msRequestFullscreen(); }
        }

        function exitFullscreen() {
            if (document.exitFullscreen) { document.exitFullscreen(); } 
            else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); } 
            else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); } 
            else if (document.msExitFullscreen) { document.msExitFullscreen(); }
        }

        function handleFullscreenChange() {
            const chartCard = document.getElementById('realtime-chart-container').parentElement;
            const chartContainer = document.getElementById('realtime-chart-container');
            const chartIcon = document.getElementById('fullscreen-chart-icon');
            const chartText = document.getElementById('fullscreen-chart-text');
            
            // Check native fullscreen status
            const isFullscreenNative = document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
            // Check CSS class status for mobile override
            const isFullscreenClass = chartCard.classList.contains('fullscreen-chart');
            const isFullscreen = isFullscreenNative || isFullscreenClass;


            if (isFullscreen) {
                chartIcon.setAttribute('data-lucide', 'minimize');
                chartText.textContent = 'Keluar';
                chartContainer.classList.add('full-screen-container');
            } else {
                chartIcon.setAttribute('data-lucide', 'maximize');
                chartText.textContent = 'Full Layar';
                chartContainer.classList.remove('full-screen-container');
            }

            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            if (energyChartInstance) { setTimeout(() => { energyChartInstance.resize(); energyChartInstance.resetZoom(); }, 50); }
        }

        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange); // FIX: Mengoreksi typo handleFullscreenchange
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('msfullscreenchange', handleFullscreenChange);

        function toggleFullscreen() {
            const chartCard = document.getElementById('realtime-chart-container').parentElement;
            const isFullscreenNative = document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
            const isMobile = window.innerWidth < 768;
            const chartContainer = document.getElementById('realtime-chart-container');

            if (isMobile) {
                if (chartCard.classList.contains('fullscreen-chart')) {
                    chartCard.classList.remove('fullscreen-chart');
                    chartContainer.classList.remove('full-screen-container');
                     if (screen.orientation && screen.orientation.unlock) { screen.orientation.unlock(); }
                } else {
                    chartCard.classList.add('fullscreen-chart');
                    chartContainer.classList.add('full-screen-container');
                     if (screen.orientation && screen.orientation.lock) { screen.orientation.lock('landscape').catch(e => {}); }
                }
                handleFullscreenChange();
                return;
            }

            if (!isFullscreenNative) {
                requestFullscreen(chartCard);
                // Menghapus permintaan lock('landscape') di desktop/tablet agar lebih fleksibel
                // if (screen.orientation && screen.orientation.lock) { screen.orientation.lock('landscape').catch(e => {}); }
            } else {
                exitFullscreen();
                // if (screen.orientation && screen.orientation.unlock) { screen.orientation.unlock(); }
            }
        }

        function renderRealtimeChart() {
             const ctx = document.getElementById('realtime-power-chart');
            if (!ctx) return;
            const context = ctx.getContext('2d');

            const dataConfig = {
                labels: window.realtimeData.labels,
                datasets: [
                    {
                        label: 'Daya PV (W)', // Label Bahasa Indonesia
                        data: window.realtimeData.pvPower,
                        backgroundColor: 'rgba(191, 255, 0, 0.2)',
                        borderColor: tailwind.config.theme.extend.colors['chart-pv'],
                        borderWidth: 2, type: 'line', fill: 'origin', tension: 0.2, pointRadius: 1, yAxisID: 'y',
                        spanGaps: true // Izinkan gap jika data kosong (null)
                    },
                    {
                        label: 'Beban AC (W)', // Label Bahasa Indonesia
                        data: window.realtimeData.acLoad,
                        backgroundColor: 'rgba(255, 185, 0, 0.2)',
                        borderColor: tailwind.config.theme.extend.colors['chart-load'],
                        borderWidth: 2, type: 'line', fill: false, tension: 0.2, pointRadius: 1, yAxisID: 'y',
                        spanGaps: true // Izinkan gap jika data kosong (null)
                    }
                ]
            };

            if (energyChartInstance) { energyChartInstance.destroy(); }

            energyChartInstance = new Chart(context, {
                type: 'line',
                data: dataConfig,
                options: {
                    responsive: true, 
                    maintainAspectRatio: false, 
                    animation: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: '#FFFFFF', usePointStyle: true } },
                        title: { display: true, text: `Perbandingan Daya PV vs Beban AC`, color: '#FFFFFF' },
                        tooltip: { 
                             backgroundColor: 'rgba(20, 20, 48, 0.8)', 
                             titleColor: '#FFFFFF', 
                             bodyColor: '#BFFF00', 
                             borderColor: 'rgba(71, 85, 105, 0.5)', 
                             borderWidth: 1,
                             callbacks: {
                                // Tooltip title tetap menggunakan label penuh yang disimpan (DD Mmm YYYY HH:MM)
                                title: function(tooltipItems, data) {
                                    return tooltipItems[0].label;
                                }
                             }
                        },
                        // KONFIGURASI KRITIS UNTUK ZOOM DI HP
                        zoom: { 
                            pan: { 
                                enabled: true, 
                                mode: 'x', // Hanya geser horizontal
                                threshold: 5, // Sensitivitas pan/geser yang lebih rendah (lebih mudah digeser)
                            }, 
                            zoom: { 
                                wheel: { enabled: true }, 
                                pinch: { enabled: true }, // Aktifkan pinch-to-zoom (cubit di HP)
                                drag: { enabled: true, modifierKey: 'shift' }, // Mengaktifkan drag zoom dengan tombol shift (untuk desktop)
                                mode: 'x' // Hanya zoom horizontal (sumbu waktu)
                            } 
                        }
                    },
                    scales: {
                        x: { 
                            type: 'category', 
                            title: { display: true, text: 'Waktu', color: '#AAAAAA' }, 
                            ticks: { 
                                color: '#AAAAAA', 
                                autoSkip: true, 
                                maxRotation: 0, 
                                maxTicksLimit: 12, // Maksimal 12 label per 24 jam
                                callback: function(value, index, ticks) {
                                    // Callback ini mengambil label lengkap (DD Mmm YYYY HH:MM)
                                    const fullLabel = this.getLabelForValue(value);
                                    
                                    // Ambil hanya HH:MM (asumsi formatnya selalu konsisten)
                                    if (fullLabel && fullLabel.length >= 5) {
                                        // HH:MM adalah 5 karakter terakhir dalam format "DD Mmm YYYY HH:MM"
                                        const timePart = fullLabel.slice(-5);
                                        return timePart;
                                    }
                                    return ''; // Fallback
                                }
                            }, 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' } 
                        },
                        y: { 
                            min: 0, // Sumbu Y dimulai dari 0 Watt
                            suggestedMax: undefined, // Memaksa auto-scaling berdasarkan data yang terlihat
                            ticks: { color: '#FFFFFF', callback: function(value) { return value + ' W'; } }, 
                            title: { display: true, text: 'Daya (Watt)', color: '#FFFFFF' }, 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' } 
                        }
                    }
                }
            });
        }

        // FUNGSI DIPERBARUI: Mereset zoom ke seluruh rentang data (24 jam terakhir)
        function resetChartZoom() {
            if (!energyChartInstance || window.realtimeData.labels.length === 0) {
                 showMessage('Grafik kosong, tidak ada yang perlu di-reset.', 'warning');
                 return;
            }
            
            // Menggunakan resetZoom bawaan plugin yang akan mereset ke batas data penuh
            energyChartInstance.resetZoom(); 

            // Update grafik (ini akan memicu auto-scaling Y)
            energyChartInstance.update('none'); 
            
            showMessage('Zoom grafik di-reset ke data penuh 24 jam terakhir.', 'success');
        }

        // FUNGSI saveChartAsPNG() telah dihapus untuk menghilangkan fitur save
        /*
        function saveChartAsPNG() {
            ... (Logic dihapus) ...
        }
        */


        /**
         * DIPERBARUI: Menggunakan Sliding Window 24 jam (5 detik per data point)
         *
         * OPTIMASI KRITIS: Mengubah cara pembaruan array dari rebuild (buat ulang) menjadi
         * PUSH/SHIFT (tambah/hapus di ujung). Ini secara drastis mengurangi overhead LocalStorage
         * dan operasi Date/String pada array 17K elemen.
         */
        function updateRealtimeChartData(pvValue, acValue) {
            const now = new Date();
            const timeLabel = formatTimeLabel(now);
            
            // 1. Tambahkan data baru
            window.realtimeData.labels.push(timeLabel);
            window.realtimeData.pvPower.push(pvValue);
            window.realtimeData.acLoad.push(acValue);

            // 2. Pangkas array agar tetap MAX_DATA_POINTS (operasi SHIFT)
            if (window.realtimeData.labels.length > MAX_DATA_POINTS) {
                window.realtimeData.labels.shift();
                window.realtimeData.pvPower.shift();
                window.realtimeData.acLoad.shift();
            }

            // 3. Perbarui grafik dan simpan data
            if (energyChartInstance) { 
                // Gunakan metode update() yang efisien setelah data array diubah
                energyChartInstance.update('none'); 
            }
            
            // Panggilan localStorage ini tetap paling berat, tetapi tidak ada alternatif 
            // jika data harus persisten di browser. Frekuensi 5 detik sudah minimal.
            localStorage.setItem(STORAGE_KEY_CHART_DATA, JSON.stringify(window.realtimeData));
        }

        async function fetchPinValue(pin) {
            let host = serverIp;
            let protocol = 'https';
            const defaultPort = '8080';

            if (!host.includes(':')) { host = `${host}:${defaultPort}`; }
            if (serverIp.includes('blynk.cloud')) { protocol = 'https'; } 
            else if (!serverIp.includes(':')) { host = `${serverIp}:8080`; protocol = 'http'; }

            if (protocol === 'http' && window.location.protocol === 'https:') { protocol = 'https'; }

            const url = `${protocol}://${host}/${authToken}/get/${pin}`;

            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) { throw new Error(`Status: ${response.status} (${response.statusText})`); }
                    const data = await response.json();
                    return data[0];
                } catch (error) {
                    if (i < maxRetries - 1) { await delay(Math.pow(2, i) * 1000); } 
                    else { console.error(`[ERROR PIN ${pin}] Gagal setelah ${maxRetries} percobaan. URL: ${url}`, error); throw new Error("Failed to fetch (Check IP/Token/CORS)"); }
                }
            }
        }

        function getCorrectedNumericValue(pin, rawValue) {
             let numericValue = tryParseFloat(rawValue);
            if (numericValue === DEFAULT_DISPLAY && rawValue !== '0') return 0;
            const correctionFactor = 1 + (pin === 'V2' ? ENERGY_CALIBRATION_PERCENT : (pin === 'V14' ? LOAD_CALIBRATION_PERCENT : 0)) / 100;
            return numericValue * correctionFactor;
        }

        function formatValue(pin, value) {
            let numericValue = tryParseFloat(value);
            if (numericValue === DEFAULT_DISPLAY && value !== '0') return 'N/A';

            let correctionFactor = 1;
            if (pin === 'V10') { correctionFactor = KWH_CALIBRATION_FACTOR; } 
            else if (pin === 'V21') { correctionFactor = 1 + (LOAD_CALIBRATION_PERCENT / 100); }
            else if (pin === 'V2') { correctionFactor = 1 + (ENERGY_CALIBRATION_PERCENT / 100); } 
            else if (pin === 'V14') { correctionFactor = 1 + (LOAD_CALIBRATION_PERCENT / 100); }
            numericValue *= correctionFactor;

            const integerPins = ['V11', 'V6', 'V12', 'V16', 'V15', 'V20', 'V2', 'V14'];
            const rupiahPins = ['V18', 'V19'];
            const summaryEnergyPins = ['V10', 'V21'];
            const batteryDetailPins = ['V0', 'V7', 'V8', 'V9', 'V3']; // Termasuk V0, V7, V8, V9

            if (rupiahPins.includes(pin)) { return Math.max(0, numericValue).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
            if (integerPins.includes(pin)) { return Math.max(0, numericValue).toFixed(0); }
            if (summaryEnergyPins.includes(pin)) { return Math.max(0, numericValue).toFixed(1); }
            
            // Atur metrik baterai ke 1 desimal untuk voltase/kapasitas
            if (batteryDetailPins.includes(pin)) { return Math.max(0, numericValue).toFixed(1); }

            return numericValue.toFixed(1);
        }

        function getUnit(pin) {
            if (pin === 'V0' || pin === 'V12' || pin === 'V7' || pin === 'V8') return ' V'; // Tambahkan V7, V8
            if (pin === 'V1' || pin === 'V13') return ' A';
            if (pin === 'V9') return ' Ah'; // Tambahkan V9
            if (pin === 'V2' || pin === 'V14' || pin === 'V6' || pin === 'V20') return ' W';
            if (pin === 'V3' || pin === 'V10' || pin === 'V11' || pin === 'V15' || pin === 'V21') return ' kWh';
            if (pin === 'V4') return ' jam';
            if (pin === 'V5') return ' %';
            if (pin === 'V16') return ' Hz';
            return '';
        }

        const processDiagramPins = (pin, rawValue) => {
            const mapping = DIAGRAM_BLYNK_MAPPING[pin];
            if (!mapping) return;
            const pValue = getCorrectedNumericValue(pin, rawValue);
            if (isNaN(pValue)) return;

            if (mapping.isGlobal) {
                if(mapping.key === 'vpack') vpack = pValue;
                if(mapping.key === 'current') current = pValue;
            } else if (mapping.isPower) {
                latestDiagramData[mapping.key] = parseFloat(Math.abs(pValue).toFixed(1));
            } else if (mapping.isDailyEnergy) {
                const numericValue = tryParseFloat(formatValue(pin, rawValue));
                latestDiagramData[mapping.key] = numericValue.toFixed(2);
            } else if (mapping.isTotalEnergy) {
                latestDiagramData[mapping.key] = pValue / 1000;
            } else if (mapping.isVoltage) {
                latestDiagramData[mapping.key] = `${pValue.toFixed(1)} V`;
            } else if (mapping.isCurrent) {
                latestDiagramData[mapping.key] = `${pValue.toFixed(1)} A`;
            } else if (mapping.isFrequency) {
                latestDiagramData[mapping.key] = `${pValue.toFixed(1)} Hz`;
            } else if (mapping.isStatic) {
                latestDiagramData[mapping.key] = pValue;
            }
        };

        function getFlowDuration(power) {
            const minDuration = 0.5, maxDuration = 10, maxPower = 5000;
            let duration = maxDuration - (power / maxPower) * (maxDuration - minDuration);
            if (power < 10) duration = maxDuration;
            if (power > maxPower) duration = minDuration;
            return `${duration.toFixed(1)}s`;
        }

        function controlFlow(animIds, powerValue, absPower) { 
            const flowSpeed = getFlowDuration(absPower);
            const isFlowing = absPower > 10;
            let keyPoints = powerValue > 0 ? "0;1" : "1;0";
            
            animIds.forEach(id => {
                const animElement = document.getElementById(id);
                if (!animElement) return;

                if (!isFlowing) {
                    animElement.parentNode.style.opacity = 0;
                    animElement.setAttribute('dur', '10.0s');
                    animElement.setAttribute('repeatCount', '1');
                } else {
                    animElement.parentNode.style.opacity = 1;
                    animElement.setAttribute('repeatCount', 'indefinite');
                    animElement.setAttribute('keyTimes', '0;1'); 
                    animElement.setAttribute('dur', flowSpeed);
                    animElement.setAttribute('keyPoints', keyPoints);
                }
            });
        }
        
        function updateBatteryLevel(soc, batPower) {
            const batteryInner = document.getElementById('bat_inner');
            const svgDefs = document.querySelector('.svg-content defs');
            if (!batteryInner || !svgDefs) return;
            batteryInner.querySelectorAll('rect').forEach(rect => rect.remove());

            const totalBars = 8;
            const socPerBar = 120 / totalBars;
            const barWidth = 7, barHeight = 1.5, startX = 5, startYVisual = 6;
            let numericSoc = parseInt(soc);
            if (isNaN(numericSoc) || numericSoc < 0) numericSoc = 0;
            if (numericSoc > 100) numericSoc = 100;
            soc = numericSoc;

            let overallColorStop = soc >= 100 ? 'var(--color-bar-green)' : (soc >= 60 ? 'var(--color-bar-green-light)' : (soc >= 30 ? 'var(--color-bar-yellow)' : 'var(--color-bar-red)'));
            const emptyColor = 'var(--color-bar-empty)';
            svgDefs.innerHTML = '';
            const gradientId = `socFlowGradient`;
            const gradient = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
            gradient.setAttribute('id', gradientId);
            gradient.setAttribute('x1', '0%'); gradient.setAttribute('y1', '0%');
            gradient.setAttribute('x2', '0%'); gradient.setAttribute('y2', '30%');
            gradient.setAttribute('spreadMethod', 'repeat'); gradient.setAttribute('gradientUnits', 'userSpaceOnUse');

            const absPower = Math.abs(batPower);
            const isFlowing = absPower > 10;
            let flowBaseColor = overallColorStop;
            let flowHighlightColor = overallColorStop;

            if (isFlowing) {
                flowBaseColor = batPower > 0 ? '#388E3C' : '#8D0000';
            }

            let stop1 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop1.setAttribute('offset', '0%'); stop1.setAttribute('stop-color', flowBaseColor); stop1.setAttribute('stop-opacity', '1.0');
            gradient.appendChild(stop1);

            if(isFlowing) {
                let stop2 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
                stop2.setAttribute('offset', '10%'); stop2.setAttribute('stop-color', flowHighlightColor); stop2.setAttribute('stop-opacity', '1.0');
                gradient.appendChild(stop2);
                let stop3 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
                stop3.setAttribute('offset', '20%'); stop3.setAttribute('stop-color', flowBaseColor); stop3.setAttribute('stop-opacity', '1.0');
                gradient.appendChild(stop3);
            } else {
                 let stop4 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
                 stop4.setAttribute('offset', '100%'); stop4.setAttribute('stop-color', overallColorStop); stop4.setAttribute('stop-opacity', '1.0');
                 gradient.appendChild(stop4);
            }

            let animMotion = document.createElementNS("http://www.w3.org/2000/svg", "animateTransform");
            animMotion.setAttribute('attributeName', 'gradientTransform'); animMotion.setAttribute('type', 'translate');
            const animDuration = getFlowDuration(absPower);

            if (isFlowing) {
                 animMotion.setAttribute('from', '0 0');
                 animMotion.setAttribute('to', batPower > 0 ? '0 -20' : '0 20');
                 animMotion.setAttribute('dur', animDuration);
                 animMotion.setAttribute('repeatCount', 'indefinite');
                 gradient.appendChild(animMotion);
            }

            svgDefs.appendChild(gradient);
            const fillUrl = `url(#${gradientId})`;

            for (let i = 0; i < totalBars; i++) {
                const isFilled = soc > ((totalBars - i) * socPerBar - socPerBar);
                const finalBarFill = isFilled ? fillUrl : emptyColor;
                const yPosition = startYVisual + (i * (barHeight + 0.5));
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute('x', startX); rect.setAttribute('y', yPosition);
                rect.setAttribute('width', barWidth); rect.setAttribute('height', barHeight);
                rect.setAttribute('rx', 0.5); rect.setAttribute('ry', 0.5);
                rect.setAttribute('fill', finalBarFill);
                batteryInner.appendChild(rect);
            }
        }

        function updateTextValues(data, batteryV, rawBatteryI) {
            const setText = (id, content) => { const el = document.getElementById(id); if (el) { el.textContent = content; } };

            const solarP = data.solarPower > 0.1 ? data.solarPower.toFixed(0) : DEFAULT_DISPLAY.toFixed(0);
            const loadP = data.loadPower > 0.1 ? data.loadPower.toFixed(0) : DEFAULT_DISPLAY.toFixed(0);
            const rawBmsP = data.rawBmsPower;
            const powerThreshold = 10;
            let batPDisplay = Math.abs(rawBmsP) > powerThreshold ? Math.abs(rawBmsP).toFixed(0) : DEFAULT_DISPLAY_STR;

            const remAh = tryParseFloat(data.batteryRemainingEnergy);
            const remainingAhValue = remAh > 0.01 ? remAh.toFixed(1) : DEFAULT_DISPLAY_STR;
            setText('battery_remaining_energy', `${remainingAhValue} Ah`);

            setText('pv1_power_186', `${solarP} W`);
            setText('ess_power', `${loadP} W`);
            setText('data.batteryPower_190', `${batPDisplay} W`); 

            const pvV = data.pvVoltage.replace(' V', '');
            const pvI = data.pvCurrent.replace(' A', '');
            setText('pv2_voltage_label', `${pvV} V`);
            setText('pv2_current_label', `${pvI} A`);

            setText('pv_peak_label', `${data.pvPeakPower.toFixed(0)} W`);
            setText('effective_sun_hours', `${data.effectiveSunHours.toFixed(1)} Hrs`);
            setText('pv_efficiency_value', `${data.pvEfficiency.toFixed(1)}%`);
            setText('pv_placeholder', `${data.batterySOC}%`); 
            
            setText('inverter_voltage_154', data.inverterVoltage);
            setText('inverter_current_164', data.inverterCurrent);
            setText('load_frequency_192', data.loadFrequency);

            const autarkyValue = data.autarkyPercentage;
            const ratioValue = data.ratioPercentage;
            const threshold = 0.1;
            setText('autarkyp_value', Math.abs(autarkyValue) < threshold ? DEFAULT_DISPLAY_STR : `${autarkyValue.toFixed(1)}%`); 
            setText('ratiop_value', Math.abs(ratioValue) < threshold ? DEFAULT_DISPLAY_STR : `${ratioValue.toFixed(1)}%`);
            
            const dailySolarRounded = Math.round(tryParseFloat(data.dailySolar));
            const totalSolarRounded = Math.round(tryParseFloat(data.totalSolarMWh));
            setText('total_solar_value', `${dailySolarRounded} kWh / ${totalSolarRounded} kWh`);
            setText('daily_load_value', `${tryParseFloat(data.dailyLoad).toFixed(2)} kWh`);

            const dischargeValue = tryParseFloat(document.getElementById('daily_bat_dischcharge_value')?.textContent);
            const dischargeTextEl = document.getElementById('daily_bat_dischcharge_value');
            if (dischargeTextEl) {
                dischargeTextEl.setAttribute('fill', dischargeValue > 0.01 ? 'var(--color-battery)' : '#C0C0C0');
            }

            const gridPowerText = document.getElementById('grid_total_power');
            if (gridPowerText) {
                gridPowerText.textContent = `${DEFAULT_DISPLAY_STR} W`;
                gridPowerText.setAttribute('fill', 'var(--color-grid)'); 
            }
            setText('daily_grid_buy_value', `${DEFAULT_DISPLAY_STR} kWh`);
            document.getElementById('daily_grid_buy_value').setAttribute('fill', '#C0C0C0'); 

            const parsedSOH = typeof data.batterySOH === 'number' ? data.batterySOH : 0; 
            const socElement = document.getElementById('battery_soc_184');
            if(socElement) {
                socElement.textContent = `${data.batterySOC}%`;
                const sohTspan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
                sohTspan.textContent = ` | ${parsedSOH}% `;
                sohTspan.setAttribute('class', 'soh-default');
                sohTspan.setAttribute('fill', '#C0C0C0');
                Array.from(socElement.childNodes).forEach(node => { if (node.nodeType === 1 && node.tagName === 'TSPAN') { node.remove(); } });
                socElement.appendChild(sohTspan);
            }

            const batteryVDisplay = batteryV !== undefined ? batteryV.toFixed(2) : DEFAULT_DISPLAY_STR;
            setText('duration', `${batteryVDisplay} V`);

            const rawCurrent = rawBatteryI;
            const absCurrent = Math.abs(rawCurrent);
            const durationTextElement = document.getElementById('duration_text');

            if (durationTextElement) {
                durationTextElement.classList.remove('battery-current-disch', 'battery-current-charge');
                durationTextElement.className = 'st3 left-align';
                
                const displayCurrentI = absCurrent.toFixed(1); 
                
                if (absCurrent > CURRENT_THRESHOLD_A) {
                    if (rawCurrent < -CURRENT_THRESHOLD_A) {
                        durationTextElement.classList.add('battery-current-disch');
                        durationTextElement.textContent = `${displayCurrentI} A (Discharge)`;
                    } else {
                        durationTextElement.classList.add('battery-current-charge');
                        durationTextElement.textContent = `${displayCurrentI} A (Charge)`;
                    }
                } else {
                    durationTextElement.textContent = `${absCurrent.toFixed(1)} A (Idle)`; 
                }
            }
        }

        function calculateAndRenderDiagram(bmsData) {
            const solarP = latestDiagramData.solarPower;
            const loadP = latestDiagramData.loadPower;
            const minimumPowerThreshold = 10;
            const rawBatP_DC = bmsData.totalPower;
            const rawCurrent = bmsData.current;

            latestDiagramData.rawBmsPower = Math.abs(rawBatP_DC); 
            let calculatedBatP;

            if (rawCurrent < -minimumPowerThreshold) {
                let deficitAC = loadP - solarP; 
                calculatedBatP = deficitAC > 0 ? -(deficitAC / INVERTER_DISCHARGE_EFFICIENCY) : rawBatP_DC;
            } else {
                calculatedBatP = rawBatP_DC;
            }
            if (calculatedBatP === undefined || isNaN(calculatedBatP) || calculatedBatP === Infinity) { calculatedBatP = rawBatP_DC; }

            latestDiagramData.batteryPower = calculatedBatP; 
            
            // Logika untuk efisiensi PV dan rasio autarky/ratio
            let eff = 0;
            const pvPeak = latestDiagramData.pvPeakPower > 0.1 ? latestDiagramData.pvPeakPower : CONFIG_PV_PEAK_WATT_DEFAULT;
            if (pvPeak > 0) { eff = (solarP / pvPeak) * 100; }
            latestDiagramData.pvEfficiency = Math.min(100, eff);

            const batP_for_visual = Math.abs(calculatedBatP); 
            const totalEnergyToLoad = loadP > 0 ? loadP : 0;
            const providedBySolar = solarP > 0 ? solarP : 0;
            const providedByBat_AC_Equivalent = rawBatP_DC < 0 ? Math.abs(rawBatP_DC) * INVERTER_DISCHARGE_EFFICIENCY : 0;
            let ratio = 0.0, autarky_ssr = 0.0;
            const isSystemActive = totalEnergyToLoad > minimumPowerThreshold || providedBySolar > minimumPowerThreshold || providedByBat_AC_Equivalent > minimumPowerThreshold;

            if (isSystemActive) {
                const selfSupply = providedBySolar + providedByBat_AC_Equivalent;
                const usedSelfGeneratedPower = Math.min(selfSupply, totalEnergyToLoad);
                if (totalEnergyToLoad > 0.1) { autarky_ssr = (usedSelfGeneratedPower / totalEnergyToLoad) * 100; } else { autarky_ssr = 100.0; }
                const totalProduction = providedBySolar + providedByBat_AC_Equivalent;
                ratio = totalProduction > 0.1 ? (usedSelfGeneratedPower / totalProduction) * 100 : 0.0;
            } else { autarky_ssr = 0.0; ratio = 0.0; }

            latestDiagramData.ratioPercentage = Math.min(100, ratio);
            latestDiagramData.autarkyPercentage = Math.min(100, autarky_ssr);
            latestDiagramData.batterySOC = bmsData.soc;
            latestDiagramData.batterySOH = bmsData.soh;
            latestDiagramData.batteryRemainingEnergy = bmsData.remainingAh;

            updateTextValues(latestDiagramData, bmsData.voltage, rawCurrent);
            updateBatteryLevel(bmsData.soc, calculatedBatP);

            controlFlow(['solar_flow_anim_1'], solarP, Math.abs(solarP));
            controlFlow(['load_flow_anim_1', 'load_flow_anim_2'], loadP, Math.abs(loadP));
            if (Math.abs(rawCurrent) > CURRENT_THRESHOLD_A) {
                controlFlow(['bat_flow_anim_1', 'bat_flow_anim_2'], rawCurrent > 0 ? 1 : -1, batP_for_visual);
            } else {
                controlFlow(['bat_flow_anim_1', 'bat_flow_anim_2'], 0, 0);
            }
            controlFlow(['grid_flow_anim_1', 'grid_flow_anim_2'], 0, 0);
            showDiagramStatus('Diagram diperbarui dari Blynk API dan BMS MQTT.', 'success');
        }

        async function updateDashboard() {
            if (!authToken) {
                updateRealtimeChartData(null, null);
                return;
            }
            
            resetDailyEnergy(); 

            const pins = Object.keys(PIN_MAPPINGS);
            const results = await Promise.allSettled(pins.map(pin => fetchPinValue(pin)));
            let currentPvPower = null; // Setel ke null secara default
            let currentAcLoad = null; // Setel ke null secara default
            let allSuccessful = true;
            const colorsToRemove = ['text-dc-color', 'text-blue-bat', 'text-ac-color', 'text-white', 'text-green-400', 'text-pink-med', 'text-purple-med', 'text-orange-red', 'text-warning-red', 'text-white-nominal', 'text-chart-self-consumption', 'text-chart-surplus', 'text-red-500', 'text-yellow-500', 'text-purple-400', 'text-pink-400'];

            results.forEach((result, index) => {
                const pin = pins[index];
                const elementId = PIN_MAPPINGS[pin];
                const element = document.getElementById(elementId);
                const unitElement = document.getElementById(`${elementId}-unit`);

                if (!element) return;
                element.classList.remove('loading-animation', 'text-red-500');

                if (result.status === 'fulfilled') {
                    const rawValue = result.value || '0';
                    const numericValue = getCorrectedNumericValue(pin, rawValue);
                    
                    if (pin === 'V2') { 
                        currentPvPower = numericValue; 
                    } else if (pin === 'V14') { 
                        currentAcLoad = numericValue; 
                    }
                    
                    processDiagramPins(pin, rawValue);
                    const formattedValue = formatValue(pin, rawValue);
                    const unit = getUnit(pin);

                    element.textContent = (pin === 'V18' || pin === 'V19') ? formattedValue : formattedValue;
                    
                    if (unitElement) unitElement.textContent = (pin === 'V18' || pin === 'V19') ? '' : unit;

                    element.style.transform = 'scale(1.05)';
                    setTimeout(() => { element.style.transform = 'scale(1)'; }, 100);

                    // LOGIC PENYESUAIAN WARNA (dibiarkan sama)
                    let nominalColorClass = 'text-white';
                    let iconColorClass = 'text-white';

                    // Logika warna untuk Ringkasan Harian/Bulan (di atas grafik)
                    if (pin === 'V10') { nominalColorClass = 'text-dc-color'; iconColorClass = 'text-dc-color'; } // Energi Hari Ini (DC)
                    else if (pin === 'V21') { nominalColorClass = 'text-ac-color'; iconColorClass = 'text-ac-color'; } // Beban Hari Ini (AC)
                    else if (pin === 'V19') { nominalColorClass = 'text-green-400'; iconColorClass = 'text-green-400'; } // Penghematan Hari Ini
                    else if (pin === 'V18') { nominalColorClass = 'text-pink-med'; iconColorClass = 'text-pink-med'; } // Penghematan Bulan Ini

                    // Logika warna untuk Detail Sistem: Panel Surya
                    else if (pin === 'V1') { nominalColorClass = 'text-dc-color'; iconColorClass = 'text-dc-color'; } // Arus PV (DC Color)
                    else if (pin === 'V6') { nominalColorClass = 'text-pink-med'; iconColorClass = 'text-pink-med'; } // PV Peak (Pink Med)
                    else if (pin === 'V5') { nominalColorClass = 'text-chart-self-consumption'; iconColorClass = 'text-chart-self-consumption'; } // Eefisiensi PV (Cyan)
                    else if (pin === 'V4') { nominalColorClass = 'text-purple-400'; iconColorClass = 'text-purple-400'; } // Matahari Efektif (Purple)
                    else if (pin === 'V11') { nominalColorClass = 'text-green-400'; iconColorClass = 'text-green-400'; } // Max Energi PV (Green)

                    // Logika warna untuk Detail Sistem: Baterai & Energi (V0, V7, V8, V9, V3)
                    else if (pin === 'V0') { nominalColorClass = 'text-pink-med'; iconColorClass = 'text-pink-med'; } // Bus Voltase (Pink Med)
                    else if (pin === 'V7') { nominalColorClass = 'text-blue-bat'; iconColorClass = 'text-blue-bat'; } // Baterai Max (Blue Bat)
                    else if (pin === 'V8') { nominalColorClass = 'text-warning-red'; iconColorClass = 'text-warning-red'; } // Baterai Low (Warning Red)
                    else if (pin === 'V9') { nominalColorClass = 'text-blue-bat'; iconColorClass = 'text-blue-bat'; } // Kapasitas Baterai (Blue Bat)
                    else if (pin === 'V3') { nominalColorClass = 'text-dc-color'; iconColorClass = 'text-dc-color'; } // Total Energi DC (DC Color)
                    
                    // Logika warna untuk Detail Sistem: Inverter & Beban (AC)
                    else if (pin === 'V12') { nominalColorClass = 'text-ac-color'; iconColorClass = 'text-ac-color'; } // Tegangan AC (AC Color)
                    else if (pin === 'V13') { nominalColorClass = 'text-ac-color'; iconColorClass = 'text-ac-color'; } // Arus AC (AC Color)
                    else if (pin === 'V16') { nominalColorClass = 'text-pink-med'; iconColorClass = 'text-pink-med'; } // Frequensi (Pink Med)
                    else if (pin === 'V20') { nominalColorClass = 'text-warning-red'; iconColorClass = 'text-warning-red'; } // Inverter Peak (Warning Red)
                    else if (pin === 'V15') { nominalColorClass = 'text-ac-color'; iconColorClass = 'text-ac-color'; } // Total Energi AC (AC Color)
                    
                    // Logika warna untuk Ringkasan Daya (di bawah judul Grafik)
                    else if (pin === 'V2') { nominalColorClass = 'text-dc-color'; } // Daya PV (DC Color)
                    else if (pin === 'V14') { nominalColorClass = 'text-ac-color'; } // Beban AC (AC Color)
                    
                    // Penerapan kelas warna
                    if (element.closest('.solar-card') || element.closest('.power-summary-card')) {
                        [element, unitElement].forEach(el => { if(el) { el.classList.remove(...colorsToRemove); el.classList.add(nominalColorClass); }});
                        let summaryIcon = element.closest('.solar-card')?.querySelector(`[data-lucide]`);
                        if (summaryIcon) { summaryIcon.classList.remove(...colorsToRemove); summaryIcon.classList.add(iconColorClass); }
                    } else if (element.closest('.detail-item')) {
                        element.classList.remove(...colorsToRemove); element.classList.add(nominalColorClass);
                        let nominalDisplay = element.closest('.nominal-color');
                        let unitDisplay = nominalDisplay ? nominalDisplay.querySelector('.text-sm') : null;
                        if(nominalDisplay) { nominalDisplay.classList.remove(...colorsToRemove); nominalDisplay.classList.add(nominalColorClass); if (unitDisplay) { unitDisplay.classList.remove(...colorsToRemove); unitDisplay.classList.add(nominalColorClass); } }
                        let detailIconElement = element.closest('.detail-item').querySelector('.metric-title [data-lucide]');
                        if (detailIconElement) { detailIconElement.classList.remove(...colorsToRemove); detailIconElement.classList.add(iconColorClass); }
                    }

                } else {
                    allSuccessful = false;
                    element.textContent = 'N/A';
                    element.classList.add('loading-animation', 'text-red-500');
                    if (unitElement) unitElement.textContent = '';
                }
            });


            // Perlu memperbarui warna Self-Consumption dan Potensi Surplus secara manual di sini
            const selfConsumptionEl = document.getElementById('self-consumption-calc');
            const selfConsumptionUnitEl = document.getElementById('self-consumption-calc-unit');
            const potensiSurplusEl = document.getElementById('potensi-surplus-calc');
            const potensiSurplusUnitEl = document.getElementById('potensi-surplus-calc-unit');

            if (selfConsumptionEl && potensiSurplusEl) {
                let scValue = (currentPvPower !== null && currentPvPower > 0) ? (Math.min(currentPvPower, currentAcLoad || 0) / currentPvPower) * 100 : 0;
                selfConsumptionEl.textContent = scValue.toFixed(0);
                selfConsumptionEl.classList.remove('loading-animation');
                let surplusValue = (currentPvPower !== null && currentAcLoad !== null) ? Math.max(0, currentPvPower - currentAcLoad) : 0;
                potensiSurplusEl.textContent = surplusValue.toFixed(0);
                potensiSurplusEl.classList.remove('loading-animation');

                // Pastikan elemen tetap menggunakan warna yang benar
                [selfConsumptionEl, selfConsumptionUnitEl].forEach(el => { 
                    if(el) { el.classList.remove(...colorsToRemove); el.classList.add('text-chart-self-consumption'); } 
                });
                [potensiSurplusEl, potensiSurplusUnitEl].forEach(el => { 
                    if(el) { el.classList.remove(...colorsToRemove); el.classList.add('text-chart-surplus'); } 
                });
            }


            if (!energyChartInstance) { renderRealtimeChart(); }
            
            // Logika untuk mengirim data ke fungsi updateRealtimeChartData
            // Jika ada kegagalan fetch, kirim null
            const pvData = results.find(r => pins[results.indexOf(r)] === 'V2')?.status === 'fulfilled' ? currentPvPower : null;
            const acData = results.find(r => pins[results.indexOf(r)] === 'V14')?.status === 'fulfilled' ? currentAcLoad : null;
            
            updateRealtimeChartData(pvData, acData); 

            const bmsAggregatedData = getAggregatedBmsData();
            calculateAndRenderDiagram(bmsAggregatedData);

            if (allSuccessful) { showMessage(`Data PLTS berhasil diperbarui pada ${new Date().toLocaleTimeString('id-ID')}`, 'success'); }
            else { showMessage('Beberapa data PLTS gagal dimuat. Periksa Auth Token dan pastikan server Blynk Anda dapat diakses (CORS/HTTPS).', 'error'); }
            
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        }

        function startInstantMonitoring() {
            const dashboard = document.getElementById('monitoring-dashboard');
            if (fetchInterval) { clearInterval(fetchInterval); fetchInterval = null; }

            loadHistoricalData();
            loadDailyEnergy();
            dashboard.classList.remove('hidden');
            lastUpdateTime = Date.now();
            
            document.getElementById("daily_bat_charge_value").textContent = (dailyChargeWh / 1000).toFixed(2) + " kWh";
            document.getElementById("daily_bat_dischcharge_value").textContent = (dailyDischargeWh / 1000).toFixed(2) + " kWh";
            
            // Set waktu titik data berikutnya 24 jam yang lalu untuk memulai array 24 jam yang benar.
            nextDataPointTime = Date.now() - (MAX_DATA_POINTS * UPDATE_INTERVAL_MS);

            updateDashboard();
            fetchInterval = setInterval(updateDashboard, UPDATE_INTERVAL);
            startMQTT();

            showDiagramStatus('Diagram siap. Menunggu data Blynk API pertama.', 'warning');
        }

        // ==========================================================
        // INISIALISASI UTAMA
        // ==========================================================

        function initApp() {
            const closeBatteryModalButton = document.getElementById('closeModalButton');
            if (closeBatteryModalButton) { closeBatteryModalButton.onclick = closeModal; }
            const batteryModal = document.getElementById("batteryModal");
            if (batteryModal) { batteryModal.addEventListener('click', (e) => { if (e.target === batteryModal) { closeModal(); } }); }

            updateTime();
            setInterval(updateTime, 1000);

            if (typeof lucide !== 'undefined') {
                try { lucide.createIcons(); } 
                catch (e) { console.error("Error creating Lucide icons during init:", e); }
            }

            safeUpdate("bms-logger-ip-header-desktop", 'N/A');
            safeUpdate("bms-logger-ip-footer", 'N/A');

            startInstantMonitoring();
        }

        window.onload = initApp;
    </script>
</body>
</html>
