<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BMS MONITORING</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Memuat ikon Lucide untuk Navigasi -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* Menggunakan skema warna Dark dari Dasbor PLTS */
    :root {
      --primary: #4B87FF; 
      --secondary: #10B981;
      --danger: #F87171;
      --warning: #FACC15;
      --solar-dark: #0F172A;
      --solar-card: #1E293B;
      --blue-bat: #60A5FA; /* Biru muda Baterai */
    }
     .led {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 6px;
      background: #ccc;
      transition: background-color 0.3s ease;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    
    .led.active {
      background: var(--secondary);
      box-shadow: 0 0 8px var(--secondary);
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--solar-dark);
      color: #F8FAFC; /* Light text on dark background */
    }
    
    .battery-card {
      background-color: var(--solar-card);
      color: #F8FAFC;
      border-left: 5px solid var(--primary); /* Memberi aksen biru */
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background-color: #334155; /* Slate-700 */
    }
    
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .cell-voltage {
      position: relative;
    }
    
    .cell-voltage::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 70%;
      width: 4px;
      border-radius: 2px;
    }
    
    .cell-normal::before { background-color: #34D399; } /* Green */
    .cell-warning::before { background-color: #FACC15; } /* Yellow */
    .cell-danger::before { background-color: #F87171; } /* Red */
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Styling Modal agar konsisten */
    #batteryModal {
        background-color: rgba(0, 0, 0, 0.7);
    }
    #batteryModal > div {
        background-color: var(--solar-card);
        color: #F8FAFC;
    }
    
    /* Styling khusus untuk modal header (mirip screenshot) */
    .modal-summary-card {
        padding: 1rem;
        border-radius: 0.5rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 120px;
    }

    .modal-soc {
        background-color: #1e3a8a; /* Blue-900 */
        border-bottom: 5px solid #3b82f6; /* Blue-500 */
    }
    .modal-soh {
        background-color: #14532d; /* Green-900 */
        border-bottom: 5px solid #22c55e; /* Green-500 */
    }
    .modal-cycles {
        background-color: #581c87; /* Purple-900 */
        border-bottom: 5px solid #a855f7; /* Purple-500 */
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
<!-- Header (Disesuaikan agar lebih simple dan fokus) -->
<header id="mainHeader" class="text-white w-full p-4 sm:p-6 mb-4">
  <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center">
    
    <!-- Tombol Kembali (Biru dan Elegan) -->
    <button onclick="window.location.href='./blynk_solar_dashboard.html'" 
            class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center mb-4 md:mb-0 text-sm">
        <i data-lucide="arrow-left" class="lucide w-4 h-4 mr-2"></i>
        Kembali ke Dasbor PLTS
    </button>

    <!-- Judul dan Deskripsi -->
    <div class="flex items-center w-full justify-between md:w-auto mt-2 md:mt-0">
      <div class="flex items-center">
         <div class="p-2 rounded-lg mr-3">
            <i data-lucide="battery-full" class="lucide w-7 h-7 text-blue-bat"></i>
         </div>
         <div>
            <h1 class="text-2xl sm:text-3xl font-extrabold text-blue-bat tracking-tight">
                BMS MONITORING
            </h1>
            <p class="text-gray-400 mt-0.5 text-sm hidden sm:block">Detail Tegangan Sel dan Kesehatan Baterai.</p>
         </div>
      </div>
      
      <!-- Bagian Kanan: Jam & ID Logger (Desktop & Mobile) -->
      <div class="flex flex-col items-end">
        <div id="time-display">
          <p id="current-date" class="text-sm text-gray-400"></p>
          <p id="current-time" class="text-2xl font-bold text-white"></p>
        </div>
        <div class="mt-1 text-xs text-gray-400">
          ID: <span class="font-bold text-white" id="bms-logger-id-header"></span>
        </div>
      </div>
    </div>
  </div>
</header>

  <!-- Main content -->
  <main class="flex-1 p-4 sm:p-6 w-full">
    <div class="max-w-7xl mx-auto">
      
      <!-- RINGKASAN SOH/SOC (Lebih Sederhana) -->
      <h2 class="text-xl font-semibold text-gray-300 mb-4">Ringkasan Baterai</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          
        <!-- SOC (State of Charge) -->
        <div class="solar-card p-4 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <i data-lucide="battery-charging" class="lucide w-7 h-7 text-blue-bat"></i>
                <span class="text-3xl font-extrabold text-blue-bat" id="summary-soc">N/A</span>
            </div>
            <p class="text-sm font-medium text-gray-400">SOC</p>
            <div class="progress-bar mt-2">
                <div id="soc-progress-summary" class="progress-fill bg-blue-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- SOH (State of Health) -->
        <div class="solar-card p-4 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <i data-lucide="heart-pulse" class="lucide w-7 h-7 text-green-400"></i>
                <span class="text-3xl font-extrabold text-green-400" id="summary-soh">N/A</span>
            </div>
            <p class="text-sm font-medium text-gray-400">SOH</p>
            <div class="progress-bar mt-2">
                <div id="soh-progress-summary" class="progress-fill bg-green-500" style="width: 0%"></div>
            </div>
        </div>
          
        <!-- Arus Baterai -->
        <div class="solar-card p-4 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <i data-lucide="activity" class="lucide w-7 h-7 text-dc-color"></i>
                <div class="flex items-baseline">
                    <span class="text-3xl font-extrabold text-dc-color" id="summary-current">N/A</span>
                    <span class="text-sm ml-1 text-dc-color">A</span>
                </div>
            </div>
            <p class="text-sm font-medium text-gray-400">Arus Baterai</p>
            <p class="text-xs text-gray-500 mt-1">Status Charging/Discharging</p>
        </div>
          
        <!-- Tegangan Pack -->
        <div class="solar-card p-4 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <i data-lucide="bolt" class="lucide w-7 h-7 text-yellow-500"></i>
                <div class="flex items-baseline">
                    <span class="text-3xl font-extrabold text-yellow-500" id="summary-voltage">N/A</span>
                    <span class="text-sm ml-1 text-yellow-500">V</span>
                </div>
            </div>
            <p class="text-sm font-medium text-gray-400">Tegangan Pack</p>
            <p class="text-xs text-gray-500 mt-1">Total Tegangan Baterai</p>
        </div>

      </div>
      
      <!-- LIST KARTU BATERAI (Grid Baterai yang Terhubung) -->
      <h2 class="text-xl font-semibold text-gray-300 mb-4 mt-8">Baterai Terhubung (<span id="total-batteries">0</span>)</h2>
      
      <div id="batteryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
      
      <div id="empty-state" class="hidden text-center py-12 bg-solar-card rounded-xl shadow-sm">
        <div class="text-blue-500 mb-4">
          <i class="fas fa-car-battery text-5xl opacity-50"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-300 mb-2">Tidak ada baterai terhubung</h3>
        <p class="text-gray-400 max-w-md mx-auto">Data baterai akan muncul di sini setelah sistem BMS Anda terhubung dan mengirim data.</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
<footer class="bg-solar-dark text-gray-500 py-4 w-full">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 flex flex-col items-center text-center">
    <div class="text-sm">
      Â© 2025 BMS Monitor System | ID Logger: <span class="font-bold text-white" id="bms-logger-id-footer"></span>
    </div>
  </div>
</footer>

  <!-- Modal Detail Baterai (Disesuaikan agar mirip Screenshot) -->
  <div id="batteryModal" class="fixed inset-0 hidden bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-solar-card rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header Modal (Sesuai Screenshot: Judul Baterai & Tombol Tutup) -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-700">
        <div class="flex items-center">
          <h2 id="modalTitle" class="text-xl font-semibold text-white">Baterai #<span id="modalAddr">N/A</span></h2>
          <div id="led-modal" class="led ml-4"></div>
        </div>
        <button id="closeModal" class="text-gray-400 hover:text-white">
          <i data-lucide="x" class="lucide w-6 h-6"></i>
        </button>
      </div>

      <div class="overflow-y-auto flex-1 p-6">
        <!-- BARIS KARTU RINGKASAN DI MODAL (SOC, SOH, CYCLE) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          
          <!-- State of Charge (SOC) -->
          <div class="modal-summary-card modal-soc text-white">
            <h3 class="text-sm font-medium">State of Charge</h3>
            <div class="text-4xl font-extrabold"><span id="modalSOCPercent">N/A</span>%</div>
            <div class="text-xs text-blue-300 mt-2">Sisa Kapasitas: <span id="modalRemaining">N/A</span> Ah</div>
          </div>

          <!-- State of Health (SOH) -->
          <div class="modal-summary-card modal-soh text-white">
            <h3 class="text-sm font-medium">State of Health</h3>
            <div class="text-4xl font-extrabold"><span id="modalSOHPercent">N/A</span>%</div>
            <div class="text-xs text-green-300 mt-2">Kapasitas Penuh: <span id="modalCapacity">N/A</span> Ah</div>
          </div>

          <!-- Cycle Count -->
          <div class="modal-summary-card modal-cycles text-white">
            <h3 class="text-sm font-medium">Cycle Count</h3>
            <div class="text-4xl font-extrabold"><span id="modalCycles">N/A</span></div>
            <div class="text-xs text-purple-300 mt-2">Terakhir diperbarui: <span id="modalLastUpdate">N/A</span></div>
          </div>
        </div>
        
        <!-- 2 Kolom Detail -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <!-- Left: Voltage Metrics -->
          <div class="space-y-4">
            <div class="bg-gray-800 p-4 rounded-lg">
              <h3 class="font-medium text-gray-300 mb-3 flex items-center">
                <i data-lucide="zap" class="lucide w-4 h-4 text-yellow-500 mr-2"></i> Metrik Tegangan
              </h3>
              <div class="space-y-3 text-sm">
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Tegangan Pack</span>
                  <span class="font-semibold text-white" id="modalVoltage">N/A</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Tegangan Bus</span>
                  <span class="font-semibold text-white" id="modalBusVoltage">N/A</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Tegangan Sel Min</span>
                  <span class="font-semibold text-white" id="modalcellmin">N/A</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Tegangan Sel Max</span>
                  <span class="font-semibold text-white" id="modalcellmax">N/A</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Perbedaan Tegangan</span>
                  <span class="font-semibold text-white" id="modalcelldif">N/A</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Current & Power Metrics --> 
          <div class="space-y-4">
            <div class="bg-gray-800 p-4 rounded-lg">
              <h3 class="font-medium text-gray-300 mb-3 flex items-center">
                <i data-lucide="activity" class="lucide w-4 h-4 text-blue-500 mr-2"></i> Metrik Arus & Daya
              </h3>
              <div class="space-y-3 text-sm">
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Arus Pack</span>
                  <span class="font-semibold text-white" id="modalCurrent">N/A</span>
                </div>
                 <div class="flex justify-between items-center">
                  <span class="text-gray-400">Daya (Power)</span>
                  <span class="font-semibold text-white" id="modalPower">N/A</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Status Temp</span>
                  <span class="font-semibold text-white" id="modalTemp">N/A</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cell Voltages (Sesuai Screenshot - Kotak Kuning Vertikal) -->
        <div class="bg-solar-card p-4 rounded-lg mt-6">
          <h3 class="font-medium text-gray-300 mb-4 flex items-center">
            <i data-lucide="layout-grid" class="lucide w-4 h-4 text-green-500 mr-2"></i> Tegangan Sel (Cell Voltages)
          </h3>
          <!-- Responsive grid 3, 4, 5 kolom -->
          <div id="modalCells" class="grid grid-cols-3 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-7 gap-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Patenkan ID Logger
    const BMS_LOGGER_ID = "316506218";
    
    let client;
    let batteries = [];
    
    // Fungsi pembantu untuk memperbarui elemen DOM dengan aman
    function safeUpdate(id, content, isHtml = false) {
        const el = document.getElementById(id);
        if (el) {
            if (isHtml) {
                el.innerHTML = content;
            } else {
                el.textContent = content;
            }
        } else {
            // console.warn(`Element ID not found: ${id}`);
        }
    }

    // Set ID Logger di header dan footer
    safeUpdate("bms-logger-id-header", BMS_LOGGER_ID);
    safeUpdate("bms-logger-id-footer", BMS_LOGGER_ID);
    
    // Fungsi untuk menampilkan Jam dan Tanggal (diambil dari Dasbor PLTS)
    function updateTime() {
      const now = new Date();
      const dateOptions = { day: 'numeric', month: 'short', year: 'numeric' };
      const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
      
      const dateStr = now.toLocaleDateString('id-ID', dateOptions);
      const timeStr = now.toLocaleTimeString('id-ID', timeOptions);

      safeUpdate('current-date', dateStr);
      safeUpdate('current-time', timeStr);
    }

    function startMQTT(){
      client = mqtt.connect("wss://public.cloud.shiftr.io", {
        username: "public",
        password: "public"
      });
      
      client.on("connect", () => {
        console.log("Connected to MQTT");
        client.subscribe("sysMon/"+BMS_LOGGER_ID+"/AutoPoll/#");
        client.subscribe("sysMon/"+BMS_LOGGER_ID+"/info/#");
        
        // Update connection status
        updateConnectionStatus(true);
      });

      client.on("message", (topic, message) => {
        if(topic == "sysMon/"+BMS_LOGGER_ID+"/info" ){
          let a = message.toString().split(",");
          
          let batteryLink = document.getElementById("batteryConfigLink");
          if (batteryLink) {
            batteryLink.href = "http://" + a[0] + "/";
          }
          let timerLink = document.getElementById("timerLink");
          if (timerLink) {
            timerLink.href = "http://" + a[0] + "/timer";
          }
        } else {
          try {
            const raw = JSON.parse(message.toString());
            const batt = normalizeFromMqtt(raw);

            const idx = batteries.findIndex(b => (b.addr === batt.addr)&&(b.typeBattery === batt.typeBattery));
            if (idx >= 0) {
              batteries[idx] = batt; // update
            } else {
              batt.elementId = `battery-${batt.typeBattery}-${batt.addr}`;
              batteries.push(batt); // kalau address baru
            }

            renderCards(batt);
            updateModal(); // Panggil updateModal di sini
          } catch (e) {
            console.error("Invalid JSON Error: ", e, e.stack); 
          }
        }
      });
      
      client.on("close", () => {
        updateConnectionStatus(false);
      });
      
      client.on("error", (error) => {
        console.error("MQTT Error:", error);
        updateConnectionStatus(false);
      });
    }

    function updateConnectionStatus(connected) {
      // Logic for connection status LED (not implemented in this simplified version)
    }

    function getCurrentTimeHHMMSS() {
      const now = new Date();
      let hours = now.getHours().toString().padStart(2, '0');
      let minutes = now.getMinutes().toString().padStart(2, '0');
      let seconds = now.getSeconds().toString().padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    function normalizeFromMqtt(data) {
      // Pastikan data.cell_voltages adalah array sebelum diproses
      const cellVoltages = Array.isArray(data.cell_voltages) ? data.cell_voltages : [];
      
      const cells = cellVoltages.map(v => (v/1000).toFixed(3));
      
      // Menggunakan spread operator hanya jika array tidak kosong
      const cell_vmax = cellVoltages.length > 0 ? Math.max(...cellVoltages) / 1000 : 0;
      const cell_vmin = cellVoltages.length > 0 ? Math.min(...cellVoltages) / 1000 : 0;
      const cell_vdiff = (cell_vmax - cell_vmin) * 1000;
      
      // Hitung Daya/Power
      const voltage = (data.bat_voltage !== undefined) ? data.bat_voltage : 0;
      const current = (data.bat_current !== undefined) ? data.bat_current : 0;
      const power = voltage * current;
      
      return {
        typeBattery: data.typeBattery || 'Baterai',
        addr: data.AddrBattery || 'N/A',
        soc: (data.SOC !== undefined) ? data.SOC.toFixed(0) : 'N/A',
        soh: (data.SOH !== undefined) ? data.SOH.toFixed(0) : 'N/A',
        voltage: voltage.toFixed(2), // Tegangan Pack
        busVoltage: (data.bus_voltage !== undefined) ? data.bus_voltage.toFixed(2) : 'N/A',
        current: current.toFixed(2), // Arus Pack
        capacity: (data.full_capacity !== undefined) ? data.full_capacity.toFixed(2) : 'N/A', // Kapasitas Penuh (Ah)
        remaining: (data.rem_capacity !== undefined) ? data.rem_capacity.toFixed(2) : 'N/A', // Sisa Kapasitas (Ah)
        cycles: data.cycle_count || 0,
        cell_vmax: cell_vmax.toFixed(3),
        cell_vmin: cell_vmin.toFixed(3),
        cell_vdif: cell_vdiff.toFixed(0),
        tempStatus: data.temp_status || 'Normal', // Status Suhu (Placeholder)
        time: getCurrentTimeHHMMSS(),
        cells: cells, // Tambahkan data cell voltages
        power: power.toFixed(2) // Daya 2 desimal
      };
    }

    const grid = document.getElementById("batteryGrid");
    const modal = document.getElementById("batteryModal");
    const emptyState = document.getElementById("empty-state");
    let currentAddr = null;

    const cardTimers = {};

    function renderCards(datane) {
        // --- Update elemen summary menggunakan safeUpdate ---
        const socContent = datane.soc !== 'N/A' ? `${datane.soc}%` : 'N/A';
        safeUpdate('summary-soc', socContent);
        
        if (datane.soc !== 'N/A' && datane.soc !== 0) {
            const socValue = parseInt(datane.soc);
            const socProgress = document.getElementById("soc-progress-summary");
            if(socProgress){
                socProgress.style.width = `${socValue}%`;
                if (socValue > 70) socProgress.className = "progress-fill bg-blue-500";
                else if (socValue > 30) socProgress.className = "progress-fill bg-yellow-500";
                else socProgress.className = "progress-fill bg-red-500";
            }
        }

        const sohContent = datane.soh !== 'N/A' ? `${datane.soh}%` : 'N/A';
        safeUpdate('summary-soh', sohContent);
        
        if (datane.soh !== 'N/A' && datane.soh !== 0) {
            const sohValue = parseInt(datane.soh);
            const sohProgress = document.getElementById("soh-progress-summary");
            if(sohProgress){
                sohProgress.style.width = `${sohValue}%`;
                if (sohValue > 80) sohProgress.className = "progress-fill bg-green-500";
                else if (sohValue > 60) sohProgress.className = "progress-fill bg-yellow-500";
                else sohProgress.className = "progress-fill bg-red-500";
            }
        }

        safeUpdate('summary-current', datane.current);
        safeUpdate('summary-voltage', datane.voltage);
        // --- END Update elemen summary ---


        if (batteries.length === 0) {
          if (grid) grid.classList.add('hidden');
          if (emptyState) emptyState.classList.remove('hidden');
          safeUpdate('total-batteries', '0');
          return;
        }

        if (grid) grid.classList.remove('hidden');
        if (emptyState) emptyState.classList.add('hidden');
        safeUpdate('total-batteries', batteries.length.toString());

        const fragment = document.createDocumentFragment();

        batteries.forEach(batt => {
          let cardId = `card-${batt.typeBattery}-${batt.addr}`;
          let card = document.getElementById(cardId);

          if (!card) {
            card = document.createElement("div");
            card.id = cardId;
            // Gunakan bg-gray-800 untuk kartu agar berbeda dari background solar-card
            card.className = "bg-gray-800 rounded-xl shadow-md p-5 cursor-pointer hover:shadow-lg transition fade-in";
            card.dataset.addr = String(batt.addr);
            card.innerHTML = `
              <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">${batt.typeBattery} <span class="text-blue-400 font-semibold">#${batt.addr}</span></h3>
                <div class="led" id="led-card-${batt.typeBattery}-${batt.addr}"></div>
              </div>
              <div class="mb-4">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm text-gray-400">SOC / SOH</span>
                  <span class="font-bold text-blue-bat">${batt.soc}% / <span class="text-green-400">${batt.soh}%</span></span>
                </div>
                <div class="progress-bar mt-1">
                    <div id="soc-bar-${batt.typeBattery}-${batt.addr}" class="progress-fill bg-blue-500" style="width: ${batt.soc}%"></div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="space-y-2">
                  <div class="flex justify-between items-center">
                    <i data-lucide="bolt" class="lucide w-4 h-4 text-yellow-500 mr-2"></i>
                    <div class="text-gray-500">Tegangan</div>
                    <div id="voltage-${batt.typeBattery}-${batt.addr}" class="font-semibold text-white">${batt.voltage} V</div>
                  </div>
                   <div class="flex justify-between items-center">
                    <i data-lucide="minus-circle" class="lucide w-4 h-4 text-red-500 mr-2"></i>
                    <div class="text-gray-500">Sel Min</div>
                    <div id="cellmin-${batt.typeBattery}-${batt.addr}" class="font-semibold text-red-400">${batt.cell_vmin} V</div>
                  </div>
                </div>
                <div class="space-y-2">
                  <div class="flex justify-between items-center">
                    <i data-lucide="activity" class="lucide w-4 h-4 text-blue-500 mr-2"></i>
                    <div class="text-gray-500">Arus</div>
                    <div id="current-${batt.typeBattery}-${batt.addr}" class="font-semibold text-white">${batt.current} A</div>
                  </div>
                  <div class="flex justify-between items-center">
                    <i data-lucide="divide" class="lucide w-4 h-4 text-blue-500 mr-2"></i>
                    <div class="text-gray-500">Selisih Sel</div>
                    <div id="voltagedif-${batt.typeBattery}-${batt.addr}" class="font-semibold text-blue-400">${batt.cell_vdif} mV</div>
                  </div>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-gray-700 text-xs text-gray-400 flex justify-between">
                <span>Siklus: ${batt.cycles}</span>
                <span class="last-update"><i data-lucide="clock" class="lucide w-3 h-3 inline mr-1"></i>${batt.time}</span>
              </div>
            `;
            card.onclick = () => openModal(batt.addr);
            fragment.appendChild(card);
          } else {
            if (datane.typeBattery === batt.typeBattery && datane.addr === batt.addr) {
              // Update ringkasan SOH/SOC di kartu utama
              safeUpdate('summary-soc', batt.soc !== 'N/A' ? `${batt.soc}%` : 'N/A');
              safeUpdate('summary-soh', batt.soh !== 'N/A' ? `${batt.soh}%` : 'N/A');
              safeUpdate('summary-current', batt.current);
              safeUpdate('summary-voltage', batt.voltage);
              
              const socProgress = document.getElementById("soc-progress-summary");
              if (socProgress) {
                  socProgress.style.width = `${batt.soc}%`;
              }
              const sohProgress = document.getElementById("soh-progress-summary");
              if (sohProgress) {
                  sohProgress.style.width = `${batt.soh}%`;
              }

              // Update kartu individu
              const socBar = document.getElementById(`soc-bar-${batt.typeBattery}-${batt.addr}`);
              if(socBar){
                socBar.style.width = `${batt.soc}%`;
                if (batt.soc > 70) socBar.className = 'progress-fill bg-blue-500';
                else if (batt.soc > 30) socBar.className = 'progress-fill bg-yellow-500';
                else socBar.className = 'progress-fill bg-red-500';
              }
              
              safeUpdate(`voltage-${batt.typeBattery}-${batt.addr}`, `${batt.voltage} V`, true);
              safeUpdate(`current-${batt.typeBattery}-${batt.addr}`, `${batt.current} A`, true);
              safeUpdate(`cellmin-${batt.typeBattery}-${batt.addr}`, `${batt.cell_vmin} V`, true);
              safeUpdate(`voltagedif-${batt.typeBattery}-${batt.addr}`, `${batt.cell_vdif} mV`, true);
              
              const lastUpdateEl = card.querySelector(".last-update");
              if (lastUpdateEl) {
                  lastUpdateEl.innerHTML = `<i data-lucide="clock" class="lucide w-3 h-3 inline mr-1"></i>${batt.time}`;
              }

              const led = document.getElementById(`led-card-${batt.typeBattery}-${batt.addr}`);
              if (led) {
                led.classList.add("active");
                setTimeout(() => led.classList.remove("active"), 250);
              }
            }
          }

          // ðŸ”¹ RESET / SET timeout tiap update
          if (cardTimers[cardId]) {
            clearTimeout(cardTimers[cardId]);
          }
          cardTimers[cardId] = setTimeout(() => {
            let c = document.getElementById(cardId);
            if (c) c.remove();
            delete cardTimers[cardId];
          }, 30000); // 30 detik timeout jika tidak ada data masuk

        });

        if (fragment.childNodes.length > 0) {
          if (grid) grid.appendChild(fragment);
        }
        
        // Render Lucide icons for new cards
        lucide.createIcons();
      }

    // Open modal
    function openModal(addr) {
      currentAddr = addr;
      updateModal();
      if (modal) modal.classList.remove("hidden");
      document.body.style.overflow = 'hidden';
    }

    // Update modal content
    function updateModal() {
      if (currentAddr === null) return;
      const batt = batteries.find(b => b.addr === currentAddr);
      
      // --- PERBAIKAN KRITIS: Hanya update jika data baterai ditemukan DAN modal sedang TERBUKA ---
      if (!batt || (modal && modal.classList.contains("hidden"))) return;

      safeUpdate("modalAddr", batt.addr);
      
      // 1. Update Kartu Header (Sesuai Screenshot)
      safeUpdate("modalSOCPercent", batt.soc);
      safeUpdate("modalRemaining", batt.remaining !== 'N/A' ? `${batt.remaining}` : 'N/A');
      
      safeUpdate("modalSOHPercent", batt.soh);
      safeUpdate("modalCapacity", batt.capacity !== 'N/A' ? `${batt.capacity}` : 'N/A');
      
      safeUpdate("modalCycles", batt.cycles);
      safeUpdate("modalLastUpdate", batt.time);
      
      // 2. Update Metrik Tegangan
      safeUpdate("modalVoltage", batt.voltage !== 'N/A' ? `${batt.voltage} V` : 'N/A');
      safeUpdate("modalBusVoltage", batt.busVoltage !== 'N/A' ? `${batt.busVoltage} V` : 'N/A');
      safeUpdate("modalcellmin", batt.cell_vmin !== 'N/A' ? `${batt.cell_vmin} V` : 'N/A');
      safeUpdate("modalcellmax", batt.cell_vmax !== 'N/A' ? `${batt.cell_vmax} V` : 'N/A');
      safeUpdate("modalcelldif", batt.cell_vdif !== 'N/A' ? `${batt.cell_vdif} mV` : 'N/A');
      
      // 3. Update Metrik Arus & Daya
      safeUpdate("modalCurrent", batt.current !== 'N/A' ? `${batt.current} A` : 'N/A');
      safeUpdate("modalPower", batt.power !== 'N/A' ? `${batt.power} W` : 'N/A');
      safeUpdate("modalTemp", batt.tempStatus); // Placeholder
      
      // 4. Render Cell Voltages
      const cellsDiv = document.getElementById("modalCells");
      if (cellsDiv) {
          cellsDiv.innerHTML = "";
          
          batt.cells.forEach((v, i) => {
            const cellValue = parseFloat(v);
            let statusClass = "cell-normal";
            if (cellValue < 3.2) statusClass = "cell-danger";
            else if (cellValue < 3.4) statusClass = "cell-warning";
            
            const cellBox = document.createElement("div");
            // Menggunakan grid yang lebih besar untuk tampilan yang lebih lega di modal
            cellBox.className = `cell-voltage ${statusClass} bg-gray-800 rounded-lg shadow-sm p-2 flex flex-col items-center justify-center text-center h-20`;
            
            const label = document.createElement("div");
            label.className = "text-xs font-medium text-gray-400 mb-0.5";
            label.textContent = `Sel ${i + 1}`;

            const value = document.createElement("div");
            value.className = "text-sm font-bold";
            value.textContent = `${v} V`;
            
            if (statusClass === "cell-danger") value.classList.add("text-red-400");
            else if (statusClass === "cell-warning") value.classList.add("text-yellow-400");
            else value.classList.add("text-green-400");
            
            // Menggunakan Flexbox untuk vertikal sejajar di dalam kotak
            cellBox.className = `cell-voltage ${statusClass} bg-gray-800 rounded-lg shadow-sm p-3 flex flex-col items-start justify-center`; // Ubah ke items-start agar teks rata kiri/kiri
            cellBox.style.borderLeft = '4px solid'; // Aksen Kiri
            if (statusClass === "cell-danger") cellBox.style.borderColor = '#F87171';
            else if (statusClass === "cell-warning") cellBox.style.borderColor = '#FACC15';
            else cellBox.style.borderColor = '#34D399'; 

            cellBox.innerHTML = `
              <div class="text-xs font-medium text-gray-400 mb-1">Sel ${i + 1}</div>
              <div class="text-sm font-bold ${statusClass === "cell-danger" ? 'text-red-400' : statusClass === "cell-warning" ? 'text-yellow-400' : 'text-green-400'}">${v} V</div>
            `;


            cellsDiv.appendChild(cellBox);
          });
      }
      
      blinkLed("led-modal");
      lucide.createIcons(); // Re-render icons inside modal
    }

    // Close modal
    const closeModalEl = document.getElementById("closeModal");
    if (closeModalEl) {
        closeModalEl.onclick = () => {
            if (modal) modal.classList.add("hidden");
            document.body.style.overflow = 'auto';
            currentAddr = null;
        };
    }
    
    if (modal) {
        modal.onclick = e => {
          if (e.target === modal) {
            modal.classList.add("hidden");
            document.body.style.overflow = 'auto';
            currentAddr = null;
          }
        };
    }

    function blinkLed(id) {
      const el = document.getElementById(id);
      if (!el) return;
      
      el.classList.remove("bg-gray-300");
      el.classList.add("active");
      
      setTimeout(() => {
        el.classList.remove("active");
        el.classList.add("bg-gray-300");
      }, 250);
    }

    // Initialize on load
    window.onload = function() {
      // Patenkan ID ditampilkan
      safeUpdate("bms-logger-id-header", BMS_LOGGER_ID);
      safeUpdate("bms-logger-id-footer", BMS_LOGGER_ID);

      startMQTT();
      
      // Atur jam
      updateTime();
      setInterval(updateTime, 1000); // Perbarui jam setiap detik
      
      // Gunakan Lucide icons
      lucide.createIcons(); 
    };
  </script>
</body>
</html>
