<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BMS MONITORING</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Memuat ikon Lucide untuk Navigasi -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* Menggunakan skema warna Dark dari Dasbor PLTS (Hitam Pekat & Transparan) */
    :root {
      --primary: #4B87FF; 
      --secondary: #10B981;
      --danger: #F87171;
      --warning: #FACC15; /* Kuning */
      --solar-dark: #05050D; /* Hitam Paling Gelap */
      --solar-card-bg: rgba(20, 20, 48, 0.4); /* Hitam Transparan */
      --blue-bat: #00FFFF; /* Cyan Cerah (Baterai) */
      --dc-color: #BFFF00; /* Hijau Lime */
      --green-400: #00C853; /* Hijau Cerah */
      --warning-red: #EF4444; /* Merah Peringatan */
      
      --red-cell: #F87171;
      --green-cell: #34D399;
    }
     .led {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 6px;
      background: #ccc;
      transition: background-color 0.3s ease;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    
    .led.active {
      background: var(--secondary);
      box-shadow: 0 0 8px var(--secondary);
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--solar-dark);
      color: #F8FAFC; 
    }
    
    /* GAYA KARTU UTAMA (Transparan & Ramping) */
    .solar-card {
        background-color: var(--solar-card-bg); 
        color: #F8FAFC;
        border-radius: 16px; 
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3); 
        border: 1px solid rgba(71, 85, 105, 0.2); 
        transition: all 0.3s ease;
    }
    .solar-card:hover {
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.5);
        transform: translateY(-2px); 
        background-color: rgba(20, 20, 48, 0.6); 
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background-color: rgba(51, 65, 85, 0.5); /* Slate-700 Transparan */
    }
    
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    /* Kelas warna khusus untuk progres bar SOC */
    .bg-soc-red { background-color: var(--warning-red); }
    .bg-soc-yellow { background-color: var(--warning); }
    .bg-soc-green { background-color: var(--green-400); }

    /* Kelas warna khusus untuk teks SOC */
    .text-soc-red { color: var(--warning-red); }
    .text-soc-yellow { color: var(--warning); }
    .text-soc-green { color: var(--green-400); }

    /* Kelas warna Arus Baterai */
    .text-charging { color: var(--green-400); } /* Hijau */
    .text-discharging { color: var(--warning-red); } /* Merah */
    .text-standby { color: #F8FAFC; } /* Putih/Default */
    
    .cell-voltage {
      position: relative;
    }
    
    /* Warna Aksen Kiri di Detail Sel */
    .cell-normal::before { background-color: var(--green-cell); } 
    .cell-warning::before { background-color: var(--warning); } 
    .cell-danger::before { background-color: var(--red-cell); } 
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Styling Modal agar konsisten */
    #batteryModal {
        background-color: rgba(0, 0, 0, 0.85);
    }
    #batteryModal > div {
        background-color: rgba(20, 20, 48, 0.9);
        color: #F8FAFC;
    }
    
    /* Styling khusus untuk modal header (ringkasan) */
    .modal-summary-card {
        padding: 1rem;
        border-radius: 0.75rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 120px;
        background-color: rgba(20, 20, 48, 0.8); /* Latar belakang card di dalam modal */
        border-bottom: 5px solid;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    .modal-soc { border-bottom-color: #3b82f6; /* Blue-500 */ }
    .modal-soh { border-bottom-color: #22c55e; /* Green-500 */ }
    .modal-cycles { border-bottom-color: #a855f7; /* Purple-500 */ }


    /* Gaya Card Detail Sesuai Screenshot */
    .detail-metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(51, 65, 85, 0.5); /* Abu-abu gelap transparan */
    }
    .detail-metric:last-child {
        border-bottom: none;
    }
    
    /* Cell Voltage Container */
    #modalCells {
        /* Mengatur ulang grid responsif agar tetap 2 kolom di HP */
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    @media (min-width: 640px) { /* sm */
        #modalCells { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (min-width: 768px) { /* md */
        #modalCells { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    @media (min-width: 1024px) { /* lg */
        #modalCells { grid-template-columns: repeat(7, minmax(0, 1fr)); }
    }

    /* Card di Modal (Untuk Cell Voltages & Metrik) */
    .bg-gray-800 { 
      background-color: rgba(30, 41, 59, 0.6); /* Lebih transparan */
    }

    /* Gaya Card Ringkasan di grid utama (3x2) */
    .metric-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }
    /* Di desktop (>lg), paksa 3 kolom */
    @media (min-width: 1024px) {
        .metric-group {
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
    }
    .metric-item {
        display: flex;
        align-items: center;
        font-size: 0.875rem; 
    }
    .metric-value {
        font-weight: 600; 
        margin-left: auto;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
<!-- Header -->
<header id="mainHeader" class="text-white w-full p-4 sm:p-6 mb-4">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <!-- Struktur Desktop (Grid 3 Kolom) -->
    <div class="hidden md:grid md:grid-cols-3 md:items-center">
        <!-- 1. Tombol Kembali (Kiri) -->
        <div class="flex justify-start">
             <!-- PERBAIKAN: Menggunakan history.back() agar sekali klik -->
             <button onclick="window.history.back()" 
                    class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center text-sm">
                <i data-lucide="arrow-left" class="lucide w-4 h-4 mr-2"></i>
                KEMBALI
            </button>
        </div>

        <!-- 2. Judul dan Deskripsi (Tengah, Rata Tengah) -->
        <div class="flex flex-col items-center text-center">
            <div class="flex items-center justify-center">
                <div class="p-2 rounded-lg mr-2">
                    <i data-lucide="battery-full" class="lucide w-7 h-7 text-blue-bat"></i>
                </div>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-extrabold text-blue-bat tracking-tight">
                        BMS MONITORING
                    </h1>
                </div>
            </div>
            <p class="text-gray-400 mt-0.5 text-sm">Detail Tegangan Sel dan Kesehatan Baterai.</p>
        </div>

        <!-- 3. Jam & IP Logger (Kanan) -->
        <div class="flex flex-col items-end">
            <div id="time-display-desktop">
                <p id="current-date-desktop" class="text-sm text-gray-400"></p>
                <p id="current-time-desktop" class="text-2xl font-bold text-white"></p>
            </div>
            <div class="mt-1 text-xs text-gray-400">
                IP: <span class="font-bold text-white" id="bms-logger-ip-header-desktop">N/A</span>
            </div>
        </div>
    </div>
    
    <!-- Struktur Mobile (STACKING/TENGAH) -->
    <div class="md:hidden flex flex-col items-center text-center w-full">
        
        <!-- ROW 1: Judul & Deskripsi (Tengah) -->
        <div class="flex flex-col items-center justify-center mb-4">
            <div class="flex items-center">
                <div class="p-2 rounded-lg mr-2">
                    <i data-lucide="battery-full" class="lucide w-7 h-7 text-blue-bat"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold text-blue-bat tracking-tight">
                        BMS MONITORING
                    </h1>
                </div>
            </div>
            <p class="text-gray-400 mt-0.5 text-sm">Detail Tegangan Sel dan Kesehatan Baterai.</p>
        </div>

        <!-- ROW 2: Tombol Kembali, Jam & ID (Di bawah Judul, Rata Samping) -->
        <div class="flex justify-between items-center w-full px-2">
            <!-- Tombol Kembali (Kiri) -->
             <!-- PERBAIKAN: Menggunakan history.back() agar sekali klik -->
            <button onclick="window.history.back()" 
                    class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center text-xs">
                <i data-lucide="arrow-left" class="lucide w-3 h-3 mr-1"></i>
                KEMBALI
            </button>
            
            <!-- Jam & IP Logger (Kanan) -->
            <div class="flex flex-col items-end text-right">
                <div id="time-display-mobile">
                    <p id="current-date-mobile" class="text-xs text-gray-400"></p>
                    <p id="current-time-mobile" class="text-lg font-bold text-white"></p>
                </div>
                <div class="mt-0.5 text-xs text-gray-400">
                    IP: <span class="font-bold text-white" id="bms-logger-ip-header-mobile">N/A</span>
                </div>
            </div>
        </div>
    </div>
  </div>
</header>

  <!-- Main content -->
  <main class="flex-1 p-4 sm:p-8 w-full">
    <div class="max-w-12xl mx-auto">
      
      <!-- RINGKASAN SOH/SOC -->
      <h2 class="text-xl font-semibold text-gray-300 mb-4">Ringkasan Baterai</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          
        <!-- SOC (State of Charge) -->
        <div class="solar-card p-4 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <!-- ID: icon-soc-summary (Untuk pewarnaan dinamis) -->
                <i data-lucide="battery-charging" class="lucide w-7 h-7 text-blue-bat" id="icon-soc-summary"></i>
                <!-- ID: summary-soc (Untuk pewarnaan dinamis) -->
                <span class="text-3xl font-extrabold text-blue-bat" id="summary-soc">N/A</span>
            </div>
            <!-- Ganti teks dari SOC/SOH menjadi hanya SOC -->
            <p class="text-sm font-medium text-gray-400">SOC</p>
            <div class="progress-bar mt-2">
                <!-- ID: soc-progress-summary (Untuk pewarnaan dinamis) -->
                <div id="soc-progress-summary" class="progress-fill bg-blue-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- SOH (State of Health) -->
        <div class="solar-card p-4 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <i data-lucide="heart-pulse" class="lucide w-7 h-7 text-green-400"></i>
                <span class="text-3xl font-extrabold text-green-400" id="summary-soh">N/A</span>
            </div>
            <p class="text-sm font-medium text-gray-400">SOH</p>
            <div class="progress-bar mt-2">
                <div id="soh-progress-summary" class="progress-fill bg-green-500" style="width: 0%"></div>
            </div>
        </div>
          
        <!-- Arus Baterai (Tambahkan ID untuk warna) -->
        <div class="solar-card p-4 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <i data-lucide="activity" class="lucide w-7 h-7 text-dc-color" id="icon-current-summary"></i>
                <div class="flex items-baseline">
                    <span class="text-3xl font-extrabold text-dc-color" id="summary-current">N/A</span>
                    <span class="text-sm ml-1 text-dc-color" id="summary-current-unit">A</span>
                </div>
            </div>
            <p class="text-sm font-medium text-gray-400">Arus Baterai</p>
            <!-- Tambahkan status Charging/Discharging -->
            <p class="text-xs text-gray-500 mt-1" id="current-status-text">Standby</p>
        </div>
          
        <!-- Tegangan Pack -->
        <div class="solar-card p-4 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <i data-lucide="bolt" class="lucide w-7 h-7 text-yellow-500"></i>
                <div class="flex items-baseline">
                    <span class="text-3xl font-extrabold text-yellow-500" id="summary-voltage">N/A</span>
                    <span class="text-sm ml-1 text-yellow-500">V</span>
                </div>
            </div>
            <p class="text-sm font-medium text-gray-400">Tegangan Pack</p>
            <p class="text-xs text-gray-500 mt-1">Total Tegangan Baterai</p>
        </div>

      </div>
      
      <!-- LIST KARTU BATERAI (Grid Baterai yang Terhubung) -->
      <h2 class="text-xl font-semibold text-gray-300 mb-4 mt-8">Baterai Terhubung (<span id="total-batteries">0</span>)</h2>
      
      <div id="batteryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
      
      <div id="empty-state" class="hidden text-center py-12 solar-card rounded-xl shadow-sm">
        <div class="text-blue-500 mb-4">
          <i class="fas fa-car-battery text-5xl opacity-50"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-300 mb-2">Tidak ada baterai terhubung</h3>
        <p class="text-gray-400 max-w-md mx-auto">Data baterai akan muncul di sini setelah sistem BMS Anda terhubung dan mengirim data.</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
<footer class="bg-solar-dark text-gray-500 py-4 w-full">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 flex flex-col items-center text-center">
    <div class="text-sm">
      Â© 2025 BMS Monitor System | IP: <span class="font-bold text-white" id="bms-logger-ip-footer">N/A</span>
    </div>
  </div>
</footer>

  <!-- Modal Detail Baterai (Disesuaikan agar mirip Screenshot) -->
  <div id="batteryModal" class="fixed inset-0 hidden bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-gray-900 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header Modal (Sesuai Screenshot: Judul Baterai & Tombol Tutup) -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-700">
        <div class="flex items-center">
          <h2 id="modalTitle" class="text-xl font-semibold text-white">Baterai #<span id="modalAddr">N/A</span></h2>
          <div id="led-modal" class="led ml-4"></div>
        </div>
        <button id="closeModal" class="text-gray-400 hover:text-white">
          <i data-lucide="x" class="lucide w-6 h-6"></i>
        </button>
      </div>

      <div class="overflow-y-auto flex-1 p-6">
        <!-- BARIS KARTU RINGKASAN DI MODAL (SOC, SOH, CYCLE) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          
          <!-- State of Charge (SOC) -->
          <div class="modal-summary-card modal-soc text-white">
            <h3 class="text-sm font-medium">State of Charge</h3>
            <div class="text-4xl font-extrabold"><span id="modalSOCPercent">N/A</span>%</div>
            <div class="text-xs text-blue-300 mt-2">Sisa Kapasitas: <span id="modalRemaining">N/A</span> Ah</div>
          </div>

          <!-- State of Health (SOH) -->
          <div class="modal-summary-card modal-soh text-white">
            <h3 class="text-sm font-medium">State of Health</h3>
            <div class="text-4xl font-extrabold"><span id="modalSOHPercent">N/A</span>%</div>
            <div class="text-xs text-green-300 mt-2">Kapasitas Penuh: <span id="modalCapacity">N/A</span> Ah</div>
          </div>

          <!-- Cycle Count -->
          <div class="modal-summary-card modal-cycles text-white">
            <h3 class="text-sm font-medium">Cycle Count</h3>
            <div class="text-4xl font-extrabold"><span id="modalCycles">N/A</span></div>
            <div class="text-xs text-purple-300 mt-2">Terakhir diperbarui: <span id="modalLastUpdate">N/A</span></div>
          </div>
        </div>
        
        <!-- 2 Kolom Detail (Mengikuti gaya card yang di-upload) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <!-- Left: Voltage Metrics -->
          <div class="bg-gray-800 p-4 rounded-lg">
            <h3 class="font-medium text-gray-300 mb-3 flex items-center">
                <i data-lucide="zap" class="lucide w-4 h-4 text-yellow-500 mr-2"></i> Metrik Tegangan
            </h3>
            <div class="space-y-3 text-sm">
                <div class="detail-metric">
                    <span class="text-gray-400">Tegangan Pack</span>
                    <span class="font-semibold text-white" id="modalVoltage">N/A</span>
                </div>
                <div class="detail-metric">
                    <span class="text-gray-400">Tegangan Bus</span>
                    <span class="font-semibold text-white" id="modalBusVoltage">N/A</span>
                </div>
                <div class="detail-metric">
                    <span class="text-gray-400">Tegangan Sel Min</span>
                    <span class="font-semibold text-white" id="modalcellmin">N/A</span>
                </div>
                <div class="detail-metric">
                    <span class="text-gray-400">Tegangan Sel Max</span>
                    <span class="font-semibold text-white" id="modalcellmax">N/A</span>
                </div>
                <div class="detail-metric">
                    <span class="text-gray-400">Perbedaan Tegangan</span>
                    <span class="font-semibold text-white" id="modalcelldif">N/A</span>
                </div>
            </div>
          </div>

          <!-- Right: Current & Power Metrics --> 
          <div class="bg-gray-800 p-4 rounded-lg">
            <h3 class="font-medium text-gray-300 mb-3 flex items-center">
                <i data-lucide="activity" class="lucide w-4 h-4 text-blue-500 mr-2"></i> Metrik Arus & Daya
            </h3>
            <div class="space-y-3 text-sm">
                <div class="detail-metric">
                    <span class="text-gray-400">Arus Pack</span>
                    <span class="font-semibold text-white" id="modalCurrent">N/A</span>
                </div>
                <div class="detail-metric">
                    <span class="text-gray-400">Daya (Power)</span>
                    <span class="font-semibold text-white" id="modalPower">N/A</span>
                </div>
                <div class="detail-metric">
                    <span class="text-gray-400">Status Temp</span>
                    <span class="font-semibold text-white" id="modalTemp">N/A</span>
                </div>
                <!-- Tambahan agar sejajar -->
                 <div class="detail-metric opacity-0">
                    <span class="text-gray-400">_</span>
                    <span class="font-semibold text-white">_</span>
                </div>
                 <div class="detail-metric opacity-0">
                    <span class="text-gray-400">_</span>
                    <span class="font-semibold text-white">_</span>
                </div>
            </div>
          </div>
        </div>

        <!-- Cell Voltages (Sesuai Screenshot - Kotak Kuning Vertikal) -->
        <div class="solar-card p-4 rounded-lg mt-6">
          <h3 class="font-medium text-gray-300 mb-4 flex items-center">
            <i data-lucide="layout-grid" class="lucide w-4 h-4 text-green-500 mr-2"></i> Tegangan Sel (Cell Voltages)
          </h3>
          <!-- Responsive grid 3, 4, 5 kolom -->
          <div id="modalCells" class="grid gap-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Konstan untuk BMS ID/Key (Digunakan untuk langganan topik MQTT)
    const BMS_MQTT_TOPIC_KEY = "316506218"; 

    let client;
    let batteries = [];
    
    // Fungsi pembantu untuk memperbarui elemen DOM dengan aman
    function safeUpdate(id, content, isHtml = false) {
        const el = document.getElementById(id);
        if (el) {
            if (isHtml) {
                el.innerHTML = content;
            } else {
                el.textContent = content;
            }
        } 
    }
    
    // Fungsi untuk menampilkan Jam dan Tanggal (diambil dari Dasbor PLTS)
    function updateTime() {
      const now = new Date();
      const dateOptions = { day: 'numeric', month: 'short', year: 'numeric' };
      const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
      
      const dateStr = now.toLocaleDateString('id-ID', dateOptions);
      const timeStr = now.toLocaleTimeString('id-ID', timeOptions);

      // Desktop
      safeUpdate('current-date-desktop', dateStr);
      safeUpdate('current-time-desktop', timeStr);
      // Mobile
      safeUpdate('current-date-mobile', dateStr);
      safeUpdate('current-time-mobile', timeStr);
    }

    function startMQTT(){
      client = mqtt.connect("wss://public.cloud.shiftr.io", {
        username: "public",
        password: "public"
      });
      
      client.on("connect", () => {
        console.log("Connected to MQTT");
        client.subscribe("sysMon/"+BMS_MQTT_TOPIC_KEY+"/AutoPoll/#");
        client.subscribe("sysMon/"+BMS_MQTT_TOPIC_KEY+"/info/#");
        
        // Update connection status
        updateConnectionStatus(true);
      });

      client.on("message", (topic, message) => {
        
        // --- LOGIC PERBAIKAN IP LOKAL ---
        if(topic == "sysMon/"+BMS_MQTT_TOPIC_KEY+"/info" ){
          // Pesan info (Contoh: "192.168.1.100,218")
          let ip_address = message.toString().split(",")[0];
          
          if (ip_address && ip_address !== 'N/A') {
              safeUpdate("bms-logger-ip-header-desktop", ip_address);
              safeUpdate("bms-logger-ip-header-mobile", ip_address);
              safeUpdate("bms-logger-ip-footer", ip_address);
              console.log(`[IP Update] IP Local Diterima: ${ip_address}`);
          }

        } else {
          try {
            const raw = JSON.parse(message.toString());
            const batt = normalizeFromMqtt(raw);

            const idx = batteries.findIndex(b => (b.addr === batt.addr)&&(b.typeBattery === batt.typeBattery));
            if (idx >= 0) {
              batteries[idx] = batt; // update
            } else {
              batt.elementId = `battery-${batt.typeBattery}-${batt.addr}`;
              batteries.push(batt); // kalau address baru
            }

            renderCards(batt);
            updateModal(); // Panggil updateModal di sini
          } catch (e) {
            console.error("Invalid JSON Error: ", e, e.stack); 
          }
        }
      });
      
      client.on("close", () => {
        updateConnectionStatus(false);
      });
      
      client.on("error", (error) => {
        console.error("MQTT Error:", error);
        updateConnectionStatus(false);
      });
    }

    function updateConnectionStatus(connected) {
      // Logic for connection status LED (not implemented in this simplified version)
    }

    function getCurrentTimeHHMMSS() {
      const now = new Date();
      let hours = now.getHours().toString().padStart(2, '0');
      let minutes = now.getMinutes().toString().padStart(2, '0');
      let seconds = now.getSeconds().toString().padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    function normalizeFromMqtt(data) {
      // Pastikan data.cell_voltages adalah array sebelum diproses
      const cellVoltages = Array.isArray(data.cell_voltages) ? data.cell_voltages : [];
      
      const cells = cellVoltages.map(v => (v/1000).toFixed(3));
      
      // Menggunakan spread operator hanya jika array tidak kosong
      const cell_vmax_val = cellVoltages.length > 0 ? Math.max(...cellVoltages) / 1000 : 'N/A';
      const cell_vmin_val = cellVoltages.length > 0 ? Math.min(...cellVoltages) / 1000 : 'N/A';
      
      let cell_vdiff_val = 'N/A';
      if (typeof cell_vmax_val === 'number' && typeof cell_vmin_val === 'number') {
          cell_vdiff_val = (cell_vmax_val - cell_vmin_val) * 1000;
      }
      
      // Hitung Daya/Power
      const voltage = (data.bat_voltage !== undefined) ? data.bat_voltage : 'N/A';
      const current = (data.bat_current !== undefined) ? data.bat_current : 'N/A';

      let power = 'N/A';
      if (typeof voltage === 'number' && typeof current === 'number') {
        power = (voltage * current).toFixed(2);
      }
      
      return {
        typeBattery: data.typeBattery || 'Baterai',
        addr: data.AddrBattery || 'N/A',
        soc: (data.SOC !== undefined) ? data.SOC.toFixed(0) : 'N/A',
        soh: (data.SOH !== undefined) ? data.SOH.toFixed(0) : 'N/A',
        voltage: typeof voltage === 'number' ? voltage.toFixed(2) : voltage, // Tegangan Pack
        busVoltage: (data.bus_voltage !== undefined) ? data.bus_voltage.toFixed(2) : 'N/A',
        current: typeof current === 'number' ? current.toFixed(2) : current, // Arus Pack
        capacity: (data.full_capacity !== undefined) ? data.full_capacity.toFixed(2) : 'N/A', // Kapasitas Penuh (Ah)
        remaining: (data.rem_capacity !== undefined) ? data.rem_capacity.toFixed(2) : 'N/A', // Sisa Kapasitas (Ah)
        cycles: data.cycle_count || 0,
        cell_vmax: typeof cell_vmax_val === 'number' ? cell_vmax_val.toFixed(3) : 'N/A', // Pastikan N/A jika bukan angka
        cell_vmin: typeof cell_vmin_val === 'number' ? cell_vmin_val.toFixed(3) : 'N/A', // Pastikan N/A jika bukan angka
        cell_vdif: typeof cell_vdiff_val === 'number' ? cell_vdiff_val.toFixed(0) : 'N/A',
        tempStatus: data.temp_status || 'Normal', // Status Suhu (Placeholder)
        time: getCurrentTimeHHMMSS(),
        cells: cells, // Tambahkan data cell voltages
        power: power // Daya 2 desimal
      };
    }

    const grid = document.getElementById("batteryGrid");
    const modal = document.getElementById("batteryModal");
    const emptyState = document.getElementById("empty-state");
    let currentAddr = null;

    const cardTimers = {};

    /**
     * Menghilangkan semua kelas warna teks yang berkaitan dengan Arus Baterai
     */
    function removeCurrentColorClasses(element) {
        if (element) {
            element.classList.remove('text-charging', 'text-discharging', 'text-standby', 'text-dc-color');
        }
    }

    function renderCards(datane) {
        
        // --- LOGIC PEWARNAAN SOC SUMMARY & PROGRESS BAR ---
        const summarySocEl = document.getElementById('summary-soc');
        const iconSocEl = document.getElementById('icon-soc-summary');
        const socProgress = document.getElementById("soc-progress-summary");
        
        const socValue = parseInt(datane.soc);

        // Fungsi untuk menentukan kelas warna SOC
        function getSocColorClasses(soc) {
            let textColor = 'text-soc-yellow'; // Default Kuning
            let progressColor = 'bg-soc-yellow'; 

            if (soc > 70) {
                textColor = 'text-soc-green';
                progressColor = 'bg-soc-green';
            } else if (soc < 30) {
                textColor = 'text-soc-red';
                progressColor = 'bg-soc-red';
            }
            // Return array of classes to remove old ones safely
            const textClassesToRemove = ['text-soc-red', 'text-soc-yellow', 'text-soc-green', 'text-blue-bat', 'text-green-400', 'text-warning-red'];
            const bgClassesToRemove = ['bg-soc-red', 'bg-soc-yellow', 'bg-soc-green', 'bg-blue-500', 'bg-yellow-500', 'bg-red-500'];

            return { textColor, progressColor, textClassesToRemove, bgClassesToRemove };
        }

        const { textColor: summaryTextColor, progressColor: summaryProgressColor, textClassesToRemove, bgClassesToRemove } = getSocColorClasses(socValue);
        
        // --- LOGIC PEWARNAAN ARUS BATERAI (SUMMARY CARD) ---
        const currentVal = parseFloat(datane.current);
        const currentSummaryEl = document.getElementById('summary-current');
        const currentIconEl = document.getElementById('icon-current-summary');
        const currentStatusTextEl = document.getElementById('current-status-text');
        
        let currentStatusText = 'Standby';
        let currentColorClass = 'text-standby';
        const currentThreshold = 0.1; // Threshold 0.1A untuk dianggap Standby

        if (!isNaN(currentVal)) {
            if (currentVal > currentThreshold) {
                currentColorClass = 'text-charging';
                currentStatusText = 'Charging';
            } else if (currentVal < -currentThreshold) {
                currentColorClass = 'text-discharging';
                currentStatusText = 'Discharging';
            } else {
                currentColorClass = 'text-standby';
                currentStatusText = 'Standby';
            }
        } else {
            // Jika N/A
            currentColorClass = 'text-standby';
            currentStatusText = 'N/A';
        }

        // Apply Current Color to Summary Card
        removeCurrentColorClasses(currentSummaryEl);
        currentSummaryEl.classList.add(currentColorClass);
        
        removeCurrentColorClasses(currentIconEl);
        currentIconEl.classList.add(currentColorClass);
        
        // Update status text
        safeUpdate('current-status-text', currentStatusText);
        
        // --- Update elemen summary SOC/SOH/Voltage/Current ---
        const socContent = datane.soc !== 'N/A' ? `${datane.soc}%` : 'N/A';
        safeUpdate('summary-soc', socContent);
        
        if (summarySocEl) { 
            summarySocEl.classList.remove(...textClassesToRemove);
            summarySocEl.classList.add(summaryTextColor);
        }
        if (iconSocEl) {
            iconSocEl.classList.remove(...textClassesToRemove);
            iconSocEl.classList.add(summaryTextColor);
        }
        
        if (datane.soc !== 'N/A' && socProgress) {
            socProgress.style.width = `${socValue}%`;
            socProgress.classList.remove(...bgClassesToRemove);
            socProgress.classList.add(summaryProgressColor);
        }
        
        // SOH
        const sohContent = datane.soh !== 'N/A' ? `${datane.soh}%` : 'N/A';
        safeUpdate('summary-soh', sohContent);
        
        if (datane.soh !== 'N/A' && datane.soh !== 0) {
            const sohValue = parseInt(datane.soh);
            const sohProgress = document.getElementById("soh-progress-summary");
            if(sohProgress){
                sohProgress.style.width = `${sohValue}%`;
                if (sohValue > 80) sohProgress.className = "progress-fill bg-green-500";
                else if (sohValue > 60) sohProgress.className = "progress-fill bg-yellow-500";
                else sohProgress.className = "progress-fill bg-red-500";
            }
        }

        safeUpdate('summary-current', datane.current);
        safeUpdate('summary-voltage', datane.voltage);
        // --- END Update elemen summary ---


        if (batteries.length === 0) {
          if (grid) grid.classList.add('hidden');
          if (emptyState) emptyState.classList.remove('hidden');
          safeUpdate('total-batteries', '0');
          return;
        }

        if (grid) grid.classList.remove('hidden');
        if (emptyState) emptyState.classList.add('hidden');
        safeUpdate('total-batteries', batteries.length.toString());

        const fragment = document.createDocumentFragment();

        batteries.forEach(batt => {
          let cardId = `card-${batt.typeBattery}-${batt.addr}`;
          let card = document.getElementById(cardId);
          
          const { textColor: cardTextColor, progressColor: cardProgressColor } = getSocColorClasses(parseInt(batt.soc));
          
          // --- LOGIC PEWARNAAN ARUS BATERAI (INDIVIDUAL CARD) ---
          const battCurrentVal = parseFloat(batt.current);
          let battCurrentColorClass = 'text-standby';
          if (!isNaN(battCurrentVal)) {
              if (battCurrentVal > currentThreshold) {
                  battCurrentColorClass = 'text-charging';
              } else if (battCurrentVal < -currentThreshold) {
                  battCurrentColorClass = 'text-discharging';
              }
          }
          // --- END LOGIC ARUS BATERAI ---


          if (!card) {
            card = document.createElement("div");
            card.id = cardId;
            // Menggunakan solar-card (transparan)
            card.className = "solar-card rounded-xl shadow-md p-5 cursor-pointer hover:shadow-lg transition fade-in";
            card.dataset.addr = String(batt.addr);
            
            // =========================================================================
            // STRUKTUR KARTU RINGKASAN (Tampilan 3x2)
            // =========================================================================
            card.innerHTML = `
              <div class="flex items-center justify-between mb-3 border-b border-gray-700 pb-2">
                <h3 class="text-lg font-bold text-white">${batt.typeBattery} <span class="text-blue-400 font-semibold">#${batt.addr}</span></h3>
                <div class="led" id="led-card-${batt.typeBattery}-${batt.addr}"></div>
              </div>
              
              <!-- SOC BAR (Diperbarui) -->
              <div class="mb-3">
                <div class="flex justify-between items-center mb-1 text-sm">
                  <span class="text-gray-400">SOC</span> <!-- TEKS DIGANTI -->
                  <span class="font-bold ${cardTextColor}" id="soc-text-${batt.typeBattery}-${batt.addr}">${batt.soc}%</span> 
                  <span class="font-bold text-gray-400">/ ${batt.soh}%</span>
                </div>
                <div class="progress-bar mt-1">
                    <div id="soc-bar-${batt.typeBattery}-${batt.addr}" class="progress-fill ${cardProgressColor}" style="width: ${batt.soc}%"></div>
                </div>
              </div>

              <!-- GRID METRIK DETAIL 3x2 (2 BARIS, 3 KOLOM DI DESKTOP) -->
              <div class="metric-group text-xs mt-2">
                
                <!-- ROW 1 | KIRI: Voltage -->
                <div class="flex items-center space-x-2 p-1">
                    <i data-lucide="zap" class="lucide w-6 h-4 text-yellow-500"></i>
                    <div>
                        <div class="text-gray-500">Tegangan</div>
                        <div id="voltage-${batt.typeBattery}-${batt.addr}" class="font-semibold text-white">${batt.voltage} V</div>
                    </div>
                </div>
                
                <!-- ROW 1 | TENGAH: Current (ARUS DENGAN PEWARNAAN DINAMIS) -->
                <div class="flex items-center space-x-2 p-1">
                    <i data-lucide="activity" class="lucide w-4 h-4 ${battCurrentColorClass}"></i>
                    <div>
                        <div class="text-gray-500">Arus</div>
                        <!-- Tambahkan ID untuk angka, dan kelas warna dinamis -->
                        <div id="current-${batt.typeBattery}-${batt.addr}" class="font-semibold ${battCurrentColorClass}">${batt.current} A</div>
                    </div>
                </div>

                <!-- ROW 2 | KIRI: Diff Cell (Selisih Sel) -->                

                <div class="flex items-center space-x-2 p-1">
                    <i data-lucide="divide" class="lucide w-4 h-4 text-blue-400"></i>
                    <div>
                        <div class="text-gray-500">Selisih Sel</div>
                        <div id="voltagedif-${batt.typeBattery}-${batt.addr}" class="font-semibold text-blue-400">${batt.cell_vdif} mV</div>
                    </div>
                </div>

                <!-- ROW 2 | KANAN: Power (Daya) -->
                <div class="flex items-center space-x-2 p-1">
                    <i data-lucide="power" class="lucide w-4 h-4 text-red-400"></i>
                    <div>
                        <div class="text-gray-500">Daya</div>
                        <div id="power-${batt.typeBattery}-${batt.addr}" class="font-semibold text-white">${batt.power} W</div>
                    </div>
                </div>

                <!-- ROW 3 | KIRI: Min Cell -->
                <div class="flex items-center space-x-2 p-1">
                    <i data-lucide="minus-circle" class="lucide w-4 h-4 text-red-500"></i>
                    <div>
                        <div class="text-gray-500">Sel Min</div>
                        <div id="cellmin-${batt.typeBattery}-${batt.addr}" class="font-semibold text-red-400">${batt.cell_vmin} V</div>
                    </div>
                </div>
                
                <!-- ROW 3 | KANAN: Max Cell -->
                <div class="flex items-center space-x-2 p-1">
                    <i data-lucide="plus-circle" class="lucide w-4 h-4 text-green-500"></i>
                    <div>
                        <div class="text-gray-500">Sel Max</div>
                        <div id="cellmax-${batt.typeBattery}-${batt.addr}" class="font-semibold text-green-400">${batt.cell_vmax} V</div>
                    </div>
                </div>
                
              </div>

              <!-- Footer Metrik -->
              <div class="mt-4 pt-3 border-t border-gray-700 text-xs text-gray-400 flex justify-between">
                <span>Siklus: ${batt.cycles}</span>
                <span class="last-update"><i data-lucide="clock" class="lucide w-3 h-3 inline mr-1"></i>${batt.time}</span>
              </div>
            `;
            // =========================================================================
            // AKHIR STRUKTUR KARTU RINGKASAN
            // =========================================================================

            card.onclick = () => openModal(batt.addr);
            fragment.appendChild(card);
          } else {
            if (datane.typeBattery === batt.typeBattery && datane.addr === batt.addr) {
              // Update ringkasan SOH/SOC di kartu utama
              safeUpdate('summary-soc', batt.soc !== 'N/A' ? `${batt.soc}%` : 'N/A');
              if (summarySocEl) { summarySocEl.classList.remove(...textClassesToRemove); summarySocEl.classList.add(summaryTextColor); }
              if (iconSocEl) { iconSocEl.classList.remove(...textClassesToRemove); iconSocEl.classList.add(summaryTextColor); }
              if (socProgress) { socProgress.style.width = `${batt.soc}%`; socProgress.classList.remove(...bgClassesToRemove); socProgress.classList.add(summaryProgressColor); }

              // Update arus di kartu ringkasan utama
              removeCurrentColorClasses(currentSummaryEl);
              currentSummaryEl.classList.add(currentColorClass);
              removeCurrentColorClasses(currentIconEl);
              currentIconEl.classList.add(currentColorClass);
              safeUpdate('current-status-text', currentStatusText);

              safeUpdate('summary-soh', batt.soh !== 'N/A' ? `${batt.soh}%` : 'N/A');
              safeUpdate('summary-current', datane.current);
              safeUpdate('summary-voltage', datane.voltage);
              
              const sohProgress = document.getElementById("soh-progress-summary");
              if (sohProgress) {
                  sohProgress.style.width = `${batt.soh}%`;
              }

              // Update kartu individu (SOC BAR)
              const socBar = document.getElementById(`soc-bar-${batt.typeBattery}-${batt.addr}`);
              const socTextEl = document.getElementById(`soc-text-${batt.typeBattery}-${batt.addr}`);

              if (socBar && socTextEl) {
                socBar.style.width = `${batt.soc}%`;
                
                socTextEl.classList.remove(...textClassesToRemove);
                socTextEl.classList.add(cardTextColor);
                
                socBar.classList.remove(...bgClassesToRemove);
                socBar.classList.add(cardProgressColor);
              }

              // Update kartu individu (ARUS)
              const currentTextEl = document.getElementById(`current-${batt.typeBattery}-${batt.addr}`);
              const currentIconCardEl = card.querySelector(`.metric-group .space-x-2:nth-child(2) .lucide`);

              if (currentTextEl && currentIconCardEl) {
                  removeCurrentColorClasses(currentTextEl);
                  currentTextEl.classList.add(battCurrentColorClass);
                  
                  removeCurrentColorClasses(currentIconCardEl);
                  currentIconCardEl.classList.add(battCurrentColorClass);
              }
              
              // ðŸ”¹ Pembaruan Metrik Detail (Harus sinkron dengan HTML di atas)
              safeUpdate(`voltage-${batt.typeBattery}-${batt.addr}`, `${batt.voltage} V`, true);
              safeUpdate(`current-${batt.typeBattery}-${batt.addr}`, `${batt.current} A`, true);
              safeUpdate(`voltagedif-${batt.typeBattery}-${batt.addr}`, `${batt.cell_vdif} mV`, true); 
              safeUpdate(`power-${batt.typeBattery}-${batt.addr}`, `${batt.power} W`, true);       
              safeUpdate(`cellmin-${batt.typeBattery}-${batt.addr}`, `${batt.cell_vmin} V`, true);
              safeUpdate(`cellmax-${batt.typeBattery}-${batt.addr}`, `${batt.cell_vmax} V`, true); 
              
              const lastUpdateEl = card.querySelector(".last-update");
              if (lastUpdateEl) {
                  lastUpdateEl.innerHTML = `<i data-lucide="clock" class="lucide w-3 h-3 inline mr-1"></i>${batt.time}`;
              }

              const led = document.getElementById(`led-card-${batt.typeBattery}-${batt.addr}`);
              if (led) {
                led.classList.add("active");
                setTimeout(() => led.classList.remove("active"), 250);
              }
            }
          }

          // ðŸ”¹ RESET / SET timeout tiap update
          if (cardTimers[cardId]) {
            clearTimeout(cardTimers[cardId]);
          }
          cardTimers[cardId] = setTimeout(() => {
            let c = document.getElementById(cardId);
            if (c) c.remove();
            delete cardTimers[cardId];
          }, 30000); // 30 detik timeout jika tidak ada data masuk

        });

        if (fragment.childNodes.length > 0) {
          if (grid) grid.appendChild(fragment);
        }
        
        // Render Lucide icons for new cards
        lucide.createIcons();
      }

    // Open modal
    function openModal(addr) {
      currentAddr = addr;
      updateModal();
      if (modal) modal.classList.remove("hidden");
      document.body.style.overflow = 'hidden';
    }

    // Update modal content
    function updateModal() {
      if (currentAddr === null) return;
      const batt = batteries.find(b => b.addr === currentAddr);
      
      // --- PERBAIKAN KRITIS: Hanya update jika data baterai ditemukan DAN modal sedang TERBUKA ---
      if (!batt || (modal && modal.classList.contains("hidden"))) return;

      safeUpdate("modalAddr", batt.addr);
      
      // 1. Update Kartu Header (Sesuai Screenshot)
      safeUpdate("modalSOCPercent", batt.soc);
      safeUpdate("modalRemaining", batt.remaining !== 'N/A' ? `${batt.remaining}` : 'N/A');
      
      safeUpdate("modalSOHPercent", batt.soh);
      safeUpdate("modalCapacity", batt.capacity !== 'N/A' ? `${batt.capacity}` : 'N/A');
      
      safeUpdate("modalCycles", batt.cycles);
      safeUpdate("modalLastUpdate", batt.time);
      
      // 2. Update Metrik Tegangan
      safeUpdate("modalVoltage", batt.voltage !== 'N/A' ? `${batt.voltage} V` : 'N/A');
      safeUpdate("modalBusVoltage", batt.busVoltage !== 'N/A' ? `${batt.busVoltage} V` : 'N/A');
      // Max Cell - ID: modalcellmax
      safeUpdate("modalcellmax", batt.cell_vmax !== 'N/A' ? `${batt.cell_vmax} V` : 'N/A');
      safeUpdate("modalcellmin", batt.cell_vmin !== 'N/A' ? `${batt.cell_vmin} V` : 'N/A');
      safeUpdate("modalcelldif", batt.cell_vdif !== 'N/A' ? `${batt.cell_vdif} mV` : 'N/A');
      
      // 3. Update Metrik Arus & Daya
      // LOGIC PEWARNAAN ARUS DI MODAL
      const currentVal = parseFloat(batt.current);
      let currentModalColor = 'text-standby';
      const currentThreshold = 0.1;

      if (!isNaN(currentVal)) {
            if (currentVal > currentThreshold) {
                currentModalColor = 'text-charging';
            } else if (currentVal < -currentThreshold) {
                currentModalColor = 'text-discharging';
            }
      }
      
      const modalCurrentEl = document.getElementById("modalCurrent");
      if(modalCurrentEl){
          removeCurrentColorClasses(modalCurrentEl);
          modalCurrentEl.classList.add(currentModalColor);
      }
      
      safeUpdate("modalCurrent", batt.current !== 'N/A' ? `${batt.current} A` : 'N/A');
      // Daya (Power) - ID: modalPower
      safeUpdate("modalPower", batt.power !== 'N/A' ? `${batt.power} W` : 'N/A');
      safeUpdate("modalTemp", batt.tempStatus); // Placeholder
      
      // 4. Render Cell Voltages
      const cellsDiv = document.getElementById("modalCells");
      if (cellsDiv) {
          cellsDiv.innerHTML = "";
          
          batt.cells.forEach((v, i) => {
            const cellValue = parseFloat(v);
            let statusClass = "cell-normal";
            if (cellValue < 3.2) statusClass = "cell-danger";
            else if (cellValue < 3.4) statusClass = "cell-warning";
            
            // Tentukan warna teks
            let textColor = 'text-green-400';
            let borderColor = '#34D399';

            if (statusClass === "cell-danger") {
              textColor = 'text-red-400';
              borderColor = '#F87171';
            } else if (statusClass === "cell-warning") {
              textColor = 'text-yellow-400';
              borderColor = '#FACC15';
            }
            
            const cellBox = document.createElement("div");

            cellBox.innerHTML = `
              <div class="text-xs font-medium text-gray-400 mb-1">Sel ${i + 1}</div>
              <div class="text-sm font-bold ${textColor}">${v} V</div>
            `;
            
            cellBox.className = `cell-voltage bg-gray-800 rounded-lg shadow-sm p-3 flex flex-col items-start justify-center`; 
            cellBox.style.borderLeft = `4px solid ${borderColor}`; 

            cellsDiv.appendChild(cellBox);
          });
      }
      
      blinkLed("led-modal");
      lucide.createIcons(); // Re-render icons inside modal
    }

    // Close modal
    const closeModalEl = document.getElementById("closeModal");
    if (closeModalEl) {
        closeModalEl.onclick = () => {
            if (modal) modal.classList.add("hidden");
            document.body.style.overflow = 'auto';
            currentAddr = null;
        };
    }
    
    if (modal) {
        modal.onclick = e => {
          if (e.target === modal) {
            modal.classList.add("hidden");
            document.body.style.overflow = 'auto';
            currentAddr = null;
          }
        };
    }

    function blinkLed(id) {
      const el = document.getElementById(id);
      if (!el) return;
      
      el.classList.remove("bg-gray-300");
      el.classList.add("active");
      
      setTimeout(() => {
        el.classList.remove("active");
        el.classList.add("bg-gray-300");
      }, 250);
    }

    // Initialize on load
    window.onload = function() {
      // Pastikan IP disetel ke 'N/A' secara eksplisit sebelum data masuk
      safeUpdate("bms-logger-ip-header-desktop", 'N/A');
      safeUpdate("bms-logger-ip-header-mobile", 'N/A');
      safeUpdate("bms-logger-ip-footer", 'N/A');

      startMQTT();
      
      // Atur jam
      updateTime();
      setInterval(updateTime, 1000); // Perbarui jam setiap detik
      
      // Gunakan Lucide icons
      lucide.createIcons(); 
    };
  </script>
</body>
</html>

