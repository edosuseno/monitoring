<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AE BMS MONITORING</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Memuat ikon Lucide untuk Navigasi -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* Menggunakan skema warna Dark dari Dasbor PLTS */
    :root {
      --primary: #4B87FF; 
      --secondary: #10B981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --solar-dark: #0F172A;
      --solar-card: #1E293B;
    }
     .led {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 6px;
      background: #ccc;
      transition: background-color 0.3s ease;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    
    .led.active {
      background: var(--secondary);
      box-shadow: 0 0 8px var(--secondary);
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--solar-dark);
      color: #F8FAFC; /* Light text on dark background */
    }
    
    .battery-card {
      background-color: var(--solar-card);
      color: #F8FAFC;
      border-left: 5px solid var(--primary); /* Memberi aksen biru */
    }

    .battery-card h3 {
      color: #F8FAFC;
    }

    .battery-card span {
      color: #94A3B8; /* Slate-400 */
    }

    .progress-bar {
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background-color: #334155; /* Slate-700 */
    }
    
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .cell-voltage {
      position: relative;
    }
    
    .cell-voltage::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 70%;
      width: 4px;
      border-radius: 2px;
    }
    
    .cell-normal::before { background-color: #34D399; } /* Green */
    .cell-warning::before { background-color: #FACC15; } /* Yellow */
    .cell-danger::before { background-color: #F87171; } /* Red */
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Style Modal yang di-override agar match Dark Mode */
    #batteryModal, #networkModal {
        background-color: rgba(0, 0, 0, 0.7);
    }
    #batteryModal > div, #networkModal > div {
        background-color: var(--solar-card);
        color: #F8FAFC;
    }
    #batteryModal h2, #networkModal h2 {
        color: #F8FAFC;
    }
    #batteryModal .border-b {
        border-color: #334155;
    }
    #batteryModal .bg-gray-50, #networkModal .bg-gray-50 {
        background-color: var(--solar-dark);
    }
    #batteryModal .text-gray-600, #batteryModal .text-gray-700, #batteryModal .text-gray-800 {
        color: #F8FAFC;
    }
    #batteryModal .text-xs.text-gray-500 {
        color: #94A3B8;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
<!-- Header -->
<header id="mainHeader" class="bg-gradient-to-r from-solar-card to-solar-dark text-white shadow-lg w-full relative">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
    <div class="flex items-center">
      <!-- Tombol Kembali ke PLTS (Diperbarui ke aeproplts.html) -->
      <button onclick="window.location.href='./aeproplts.html'" class="text-white hover:text-gray-300 mr-4 p-2 rounded-full bg-white/10 transition">
        <i data-lucide="arrow-left" class="lucide w-6 h-6"></i>
      </button>

      <div class="bg-white/20 p-2 rounded-lg mr-3">
        <i class="fas fa-car-battery text-2xl"></i>
      </div>
      <h1 class="text-2xl font-bold">AE BMS MONITORING</h1>
    </div>

    <div class="flex items-center space-x-4">
      <div class="hidden md:flex items-center space-x-2 text-sm bg-white/10 px-3 py-1 rounded-full">
        <i class="fas fa-satellite-dish"></i>
        <span id="id_monitoring">-</span>
      </div>

      <!-- Tombol Settings dengan Dropdown -->
      <div class="relative">
        <!-- Ikon Roda Gigi -->
        <button id="settingsBtn" class="bg-white/10 hover:bg-white/20 p-2 rounded-full transition">
          <i class="fas fa-cog"></i>
        </button>

        <!-- Dropdown Menu -->
        <div id="dropdownMenu"
          class="absolute right-0 mt-2 w-44 bg-solar-card text-gray-200 rounded-lg shadow-lg hidden">
            <a id="batteryConfigLink" href="#" target="_blank" class="block px-4 py-2 hover:bg-gray-700 flex items-center">‚öôÔ∏è Device Config</a>
            <a id="networkBtn" href="#" class="block px-4 py-2 hover:bg-gray-700 flex items-center">üì° Network</a>
            <a id="timerLink" href="#" target="_blank" class="block px-4 py-2 hover:bg-gray-700 flex items-center">‚è± Timer</a>
          <hr class="my-1 border-gray-700">
          <a id="themeToggleLink" href="#" class="block px-4 py-2 hover:bg-gray-700 flex items-center">üåô Dark Mode</a>
        </div>
      </div>
    </div>
  </div>
</header>
<!-- Modal Network -->
<div id="networkModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
  <div class="bg-solar-card rounded-lg shadow-lg w-96 p-6 relative">
    <button id="closeNetwork" class="absolute top-2 right-2 text-gray-400 hover:text-white">
      ‚úñ
    </button>
    <h2 class="text-xl font-bold mb-4 text-white">Network Info</h2>
    <p id="network_ip" class="mb-2 text-gray-300">IP Address: -</p>
    <p id="network_signal" class="text-gray-300">Signal: -</p>
  </div>
</div>

  <!-- Main content -->
  <main class="flex-1 p-4 sm:p-6 w-full">
    <div class="max-w-7xl mx-auto">
      <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center">
        <h2 class="text-xl font-semibold text-gray-300 mb-2 sm:mb-0">Daftar Baterai BMS</h2>
        <div class="text-sm text-gray-400">
          <span id="total-batteries">0</span> baterai terhubung.
        </div>
      </div>
      
      <div id="batteryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
      
      <div id="empty-state" class="hidden text-center py-12 bg-solar-card rounded-xl shadow-sm">
        <div class="text-blue-500 mb-4">
          <i class="fas fa-car-battery text-5xl opacity-50"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-300 mb-2">Tidak ada baterai terhubung</h3>
        <p class="text-gray-400 max-w-md mx-auto">Data baterai akan muncul di sini setelah sistem BMS Anda terhubung dan mengirim data.</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
<footer class="bg-solar-dark text-gray-500 py-4 w-full">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 flex flex-col items-center text-center">
    <div class="text-sm">
      ¬© 2025 BMS Monitor System | ID Logger: <span class="font-bold text-white" id="bms-logger-id-footer"></span>
    </div>
  </div>
</footer>

  <!-- Modal Detail Baterai -->
  <div id="batteryModal" class="fixed inset-0 hidden bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-solar-card rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header Modal -->
      <div class="flex items-center justify-between px-6 py-4 border-b">
        <div class="flex items-center">
          <div id="led-modal" class="w-3 h-3 rounded-full bg-gray-300 mr-3"></div>
          <h2 id="modalTitle" class="text-xl font-semibold text-white"></h2>
        </div>
        <button id="closeModal" class="text-gray-400 hover:text-white">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="overflow-y-auto flex-1 p-6">
        <!-- Battery Status Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="bg-blue-950 p-4 rounded-lg">
            <div class="flex justify-between items-start mb-2">
              <div class="text-blue-300 font-medium">State of Charge</div>
              <div class="text-2xl font-bold text-blue-400" id="modalSOC"></div>
            </div>
            <div class="progress-bar">
              <div id="soc-progress" class="progress-fill bg-blue-500"></div>
            </div>
            <div class="text-xs text-gray-400 mt-1">Sisa Kapasitas: <span id="modalRemaining"></span> Ah</div>
          </div>
          
          <div class="bg-green-950 p-4 rounded-lg">
            <div class="flex justify-between items-start mb-2">
              <div class="text-green-300 font-medium">State of Health</div>
              <div class="text-2xl font-bold text-green-400" id="modalSOH"></div>
            </div>
            <div class="progress-bar">
              <div id="soh-progress" class="progress-fill bg-green-500"></div>
            </div>
            <div class="text-xs text-gray-400 mt-1">Kapasitas Penuh: <span id="modalCapacity"></span> Ah</div>
          </div>
          
          <div class="bg-purple-950 p-4 rounded-lg">
            <div class="flex justify-between items-center mb-2">
              <div class="text-purple-300 font-medium">Cycle Count</div>
              <div class="text-2xl font-bold text-purple-400" id="modalCycles"></div>
            </div>
            <div class="text-xs text-gray-400 mt-1">Terakhir diperbarui: <span id="modalLastUpdate"></span></div>
          </div>
        </div>

        <!-- 2 Kolom -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <!-- Left: Voltage -->
          <div class="space-y-4">
            <div class="bg-solar-dark p-4 rounded-lg">
              <h3 class="font-medium text-gray-300 mb-3 flex items-center">
                <i class="fas fa-bolt text-yellow-500 mr-2"></i> Metrik Tegangan
              </h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Tegangan Pack</span>
                  <span class="font-semibold text-white" id="modalVoltage"></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Tegangan Bus</span>
                  <span class="font-semibold text-white" id="modalBusVoltage"></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Tegangan Sel Min</span>
                  <span class="font-semibold text-white" id="modalcellmin"></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Tegangan Sel Max</span>
                  <span class="font-semibold text-white" id="modalcellmax"></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Perbedaan Tegangan</span>
                  <span class="font-semibold text-white" id="modalcelldif"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Current & Power --> 
          <div class="space-y-4">
            <div class="bg-solar-dark p-4 rounded-lg">
              <h3 class="font-medium text-gray-300 mb-3 flex items-center">
                <i class="fas fa-tachometer-alt text-blue-500 mr-2"></i> Metrik Arus & Daya
              </h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Arus Pack</span>
                  <span class="font-semibold text-white" id="modalCurrent"></span>
                </div>
               
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Daya (Power)</span>
                  <span class="font-semibold text-white" id="modalPower"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cell Voltages -->
        <div class="bg-solar-dark p-4 rounded-lg">
          <h3 class="font-medium text-gray-300 mb-4 flex items-center">
            <i class="fas fa-battery-three-quarters text-green-500 mr-2"></i> Tegangan Sel (Cell Voltages)
          </h3>
          <!-- Responsive grid 3, 4, 5 kolom -->
          <div id="modalCells" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Patenkan ID Logger
    const BMS_LOGGER_ID = "316506218";
    
    let client;
    let batteries = [];
    
    document.getElementById("bms-logger-id-footer").innerText = BMS_LOGGER_ID;
    
    function startMQTT(){
      client = mqtt.connect("wss://public.cloud.shiftr.io", {
        username: "public",
        password: "public"
      });
      
      client.on("connect", () => {
        console.log("Connected to MQTT");
        client.subscribe("sysMon/"+BMS_LOGGER_ID+"/AutoPoll/#");
        client.subscribe("sysMon/"+BMS_LOGGER_ID+"/info/#");
        
        // Update connection status
        updateConnectionStatus(true);
      });

      client.on("message", (topic, message) => {
        if(topic == "sysMon/"+BMS_LOGGER_ID+"/info" ){
          let a = message.toString().split(",");
          
          document.getElementById("network_ip").innerText = "IP Address: " + a[0];
          document.getElementById("network_signal").innerText = "Signal: " + a[1];
          document.getElementById("id_monitoring").innerText = " üåê " + a[0] + " üì∂"+a[1];
          
          // update link Battery Config sesuai IP dari MQTT
          let batteryLink = document.getElementById("batteryConfigLink");
          if (batteryLink) {
            batteryLink.href = "http://" + a[0] + "/";
          }
          let timerLink = document.getElementById("timerLink");
          if (timerLink) {
            timerLink.href = "http://" + a[0] + "/timer";
          }
        } else {
          try {
            const raw = JSON.parse(message.toString());
            const batt = normalizeFromMqtt(raw);

            const idx = batteries.findIndex(b => (b.addr === batt.addr)&&(b.typeBattery === batt.typeBattery));
            if (idx >= 0) {
              batteries[idx] = batt; // update
            } else {
              batt.elementId = `battery-${batt.typeBattery}-${batt.addr}`;
              batteries.push(batt); // kalau address baru
            }

            renderCards(batt);
            updateModal();
          } catch (e) {
            console.error("Invalid JSON Error: ", e);
          }
        }
      });
      
      client.on("close", () => {
        updateConnectionStatus(false);
      });
      
      client.on("error", (error) => {
        console.error("MQTT Error:", error);
        updateConnectionStatus(false);
      });
    }

    function updateConnectionStatus(connected) {
      // Implementasi status koneksi di BMS (jika diperlukan)
    }

    function getCurrentTimeHHMMSS() {
      const now = new Date();
      let hours = now.getHours().toString().padStart(2, '0');
      // PERBAIKAN: now.getMinutes().getMinutes() diubah menjadi now.getMinutes()
      let minutes = now.getMinutes().toString().padStart(2, '0');
      let seconds = now.getSeconds().toString().padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    function normalizeFromMqtt(data) {
      const cells = data.cell_voltages.map(v => (v/1000).toFixed(3));
      const cell_vmax = Math.max(...data.cell_voltages) / 1000;
      const cell_vmin = Math.min(...data.cell_voltages) / 1000;
      const cell_vdiff = (cell_vmax - cell_vmin) * 1000;
      
      return {
        typeBattery: data.typeBattery,
        addr: data.AddrBattery,
        soc: data.SOC.toFixed(1),
        soh: data.SOH.toFixed(1),
        voltage: data.bat_voltage.toFixed(2),
        busVoltage: data.bus_voltage.toFixed(2),
        current: data.bat_current.toFixed(2),
        capacity: data.full_capacity.toFixed(2),
        remaining: data.rem_capacity.toFixed(2),
        cycles: data.cycle_count,
        cycle_count: data.cycle_count,
        cells,
        cell_vmax: cell_vmax.toFixed(3),
        cell_vmin: cell_vmin.toFixed(3),
        cell_vdif: cell_vdiff.toFixed(0),
        time: getCurrentTimeHHMMSS(),
        power: (data.bat_voltage * data.bat_current).toFixed(2)
      };
    }

    const grid = document.getElementById("batteryGrid");
    const modal = document.getElementById("batteryModal");
    const emptyState = document.getElementById("empty-state");
    let currentAddr = null;

    const cardTimers = {};

    function renderCards(datane) {
        if (batteries.length === 0) {
          grid.classList.add('hidden');
          emptyState.classList.remove('hidden');
          document.getElementById('total-batteries').textContent = '0';
          return;
        }

        grid.classList.remove('hidden');
        emptyState.classList.add('hidden');
        document.getElementById('total-batteries').textContent = batteries.length.toString();

        const fragment = document.createDocumentFragment();

        batteries.forEach(batt => {
          let cardId = `card-${batt.typeBattery}-${batt.addr}`;
          let card = document.getElementById(cardId);

          if (!card) {
            card = document.createElement("div");
            card.id = cardId;
            card.className = "battery-card rounded-xl shadow-sm p-5 cursor-pointer hover:shadow-md fade-in";
            card.dataset.addr = String(batt.addr);
            card.innerHTML = `
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">${batt.typeBattery} <span class="text-blue-400">#${batt.addr}</span></h3>
                <div class="led" id="led-card-${batt.typeBattery}-${batt.addr}"></div>
              </div>
              <div class="mb-4">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm text-gray-400">SOC</span>
                  <span class="font-semibold" id="soc-value-${batt.typeBattery}-${batt.addr}">${batt.soc}%</span>
                </div>
                <div class="progress-bar">
                  <div id="soc-bar-${batt.typeBattery}-${batt.addr}" class="progress-fill" style="width: ${batt.soc}%"></div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-5 text-sm">
                <div class="space-y-2">
                  <div class="flex items-center">
                    <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                    <div>
                      <div class="text-gray-500">Tegangan</div>
                      <div id="voltage-${batt.typeBattery}-${batt.addr}" class="font-semibold">${batt.voltage} V</div>
                    </div>
                  </div>
                   <div class="flex items-center">
                    <i class="fas fa-minus-circle  text-blue-500 mr-2"></i>
                    <div>
                      <div class="text-gray-500">Selisih Sel</div>
                      <div id="voltagedif-${batt.typeBattery}-${batt.addr}" class="font-semibold">${batt.cell_vdif} mV</div>
                    </div>
                  </div>

                  <div class="flex items-center">
                    <i class="fas fa-minus-circle text-red-500 mr-2"></i>
                    <div>
                      <div class="text-gray-500">Sel Min</div>
                      <div id="cellmin-${batt.typeBattery}-${batt.addr}" class="font-semibold">${batt.cell_vmin} V</div>
                    </div>
                  </div>
                </div>
                <div class="space-y-2">
                  <div class="flex items-center">
                    <i class="fas fa-tachometer-alt text-blue-500 mr-2"></i>
                    <div>
                      <div class="text-gray-500">Arus</div>
                      <div id="current-${batt.typeBattery}-${batt.addr}" class="font-semibold">${batt.current} A</div>
                    </div>
                  </div>
                   <div class="flex items-center">
                    <i class="fas fa-bolt text-red-500 mr-2"></i>
                    <div>
                      <div class="text-gray-500">Daya</div>
                      <div id="power-${batt.typeBattery}-${batt.addr}" class="font-semibold">${(batt.voltage*batt.current).toFixed(1)} W</div>
                    </div>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-plus-circle text-green-500 mr-2"></i>
                    <div>
                      <div class="text-gray-500">Sel Max</div>
                      <div id="cellmax-${batt.typeBattery}-${batt.addr}" class="font-semibold">${batt.cell_vmax} V</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-4 pt-3 border-t border-gray-700 text-xs text-gray-400 flex justify-between">
                <span>Siklus: ${batt.cycles}</span>
                <span class="last-update"><i class="far fa-clock mr-1"></i>${batt.time}</span>
              </div>
            `;
            card.onclick = () => openModal(batt.addr);
            fragment.appendChild(card);
          } else {
            if (datane.typeBattery === batt.typeBattery && datane.addr === batt.addr) {
              document.getElementById(`soc-value-${batt.typeBattery}-${batt.addr}`).textContent = `${batt.soc}%`;
              document.getElementById(`soc-bar-${batt.typeBattery}-${batt.addr}`).style.width = `${batt.soc}%`;
              document.getElementById(`voltage-${batt.typeBattery}-${batt.addr}`).innerHTML = `${batt.voltage} V`;
              document.getElementById(`current-${batt.typeBattery}-${batt.addr}`).innerHTML = `${batt.current} A`;
              document.getElementById(`cellmin-${batt.typeBattery}-${batt.addr}`).innerHTML = `${batt.cell_vmin} V`;
              document.getElementById(`cellmax-${batt.typeBattery}-${batt.addr}`).innerHTML = `${batt.cell_vmax} V`;
              document.getElementById(`power-${batt.typeBattery}-${batt.addr}`).innerHTML = `${(batt.voltage*batt.current).toFixed(1)} W`;
              document.getElementById(`voltagedif-${batt.typeBattery}-${batt.addr}`).innerHTML = `${batt.cell_vdif} mV`;

              const socBar = document.getElementById(`soc-bar-${batt.typeBattery}-${batt.addr}`);
              if (batt.soc > 70) socBar.className = 'progress-fill bg-green-500';
              else if (batt.soc > 30) socBar.className = 'progress-fill bg-yellow-500';
              else socBar.className = 'progress-fill bg-red-500';

              card.querySelector(".last-update").innerHTML = `<i class="far fa-clock mr-1"></i>${batt.time}`;

              const led = document.getElementById(`led-card-${batt.typeBattery}-${batt.addr}`);
              led.classList.add("active");
              setTimeout(() => led.classList.remove("active"), 250);
            }
          }

          // üîπ RESET / SET timeout tiap update
          if (cardTimers[cardId]) {
            clearTimeout(cardTimers[cardId]);
          }
          cardTimers[cardId] = setTimeout(() => {
            let c = document.getElementById(cardId);
            if (c) c.remove();
            delete cardTimers[cardId];
          }, 30000); // 30 detik timeout jika tidak ada data masuk

        });

        if (fragment.childNodes.length > 0) {
          grid.appendChild(fragment);
        }
      }

    // Open modal
    function openModal(addr) {
      currentAddr = addr;
      updateModal();
      modal.classList.remove("hidden");
      document.body.style.overflow = 'hidden';
    }

    // Update modal content
    function updateModal() {
      if (currentAddr === null) return;
      const batt = batteries.find(b => b.addr === currentAddr);
      if (!batt) return;

      document.getElementById("modalTitle").textContent = `${batt.typeBattery} #${batt.addr}`;
      document.getElementById("modalSOC").textContent = `${batt.soc}%`;
      document.getElementById("modalSOH").textContent = `${batt.soh}%`;
      document.getElementById("modalCycles").textContent = batt.cycles;
      document.getElementById("modalVoltage").textContent = `${batt.voltage} V`;
      document.getElementById("modalBusVoltage").textContent = `${batt.busVoltage} V`;
      document.getElementById("modalCurrent").textContent = `${batt.current} A`;
      document.getElementById("modalCapacity").textContent = `${batt.capacity} Ah`;
      document.getElementById("modalRemaining").textContent = `${batt.remaining} Ah`;
      document.getElementById("modalLastUpdate").textContent = batt.time;
      document.getElementById("modalcellmin").textContent = `${batt.cell_vmin} V`;
      document.getElementById("modalcellmax").textContent = `${batt.cell_vmax} V`;
      document.getElementById("modalcelldif").textContent = `${batt.cell_vdif} mV`;
      document.getElementById("modalPower").textContent = `${batt.power} W`;

      // Update progress bars
      document.getElementById("soc-progress").style.width = `${batt.soc}%`;
      document.getElementById("soh-progress").style.width = `${batt.soh}%`;
      
      // Set progress bar colors
      const socProgress = document.getElementById("soc-progress");
      const sohProgress = document.getElementById("soh-progress");
      
      if (batt.soc > 70) socProgress.className = "progress-fill bg-blue-500";
      else if (batt.soc > 30) socProgress.className = "progress-fill bg-yellow-500";
      else socProgress.className = "progress-fill bg-red-500";
      
      if (batt.soh > 80) sohProgress.className = "progress-fill bg-green-500";
      else if (batt.soh > 60) sohProgress.className = "progress-fill bg-yellow-500";
      else sohProgress.className = "progress-fill bg-red-500";

      // Render cell voltages
      const cellsDiv = document.getElementById("modalCells");
      cellsDiv.innerHTML = "";
      
      batt.cells.forEach((v, i) => {
        const cellValue = parseFloat(v);
        let statusClass = "cell-normal";
        if (cellValue < 3.2) statusClass = "cell-danger";
        else if (cellValue < 3.4) statusClass = "cell-warning";
        
        const cellBox = document.createElement("div");
        cellBox.className = `cell-voltage ${statusClass} bg-solar-card rounded-lg shadow-sm p-3 flex flex-col items-center`;
        
        const label = document.createElement("div");
        label.className = "text-xs font-medium text-gray-400 mb-1";
        label.textContent = `Sel ${i + 1}`;

        const value = document.createElement("div");
        value.className = "text-sm font-bold";
        value.textContent = `${v} V`;
        
        if (statusClass === "cell-danger") value.className += " text-red-400";
        else if (statusClass === "cell-warning") value.className += " text-yellow-400";
        else value.className += " text-green-400";

        cellBox.appendChild(label);
        cellBox.appendChild(value);
        cellsDiv.appendChild(cellBox);
      });
      
      blinkLed("led-modal");
    }

    // Close modal
    document.getElementById("closeModal").onclick = () => {
      modal.classList.add("hidden");
      document.body.style.overflow = 'auto';
      currentAddr = null;
    };
    
    modal.onclick = e => {
      if (e.target === modal) {
        modal.classList.add("hidden");
        document.body.style.overflow = 'auto';
        currentAddr = null;
      }
    };

    function blinkLed(id) {
      const el = document.getElementById(id);
      if (!el) return;
      
      el.classList.remove("bg-gray-300");
      el.classList.add("bg-green-500");
      
      setTimeout(() => {
        el.classList.remove("bg-green-500");
        el.classList.add("bg-gray-300");
      }, 250);
    }

    // Initialize on load
    window.onload = function() {
      // Patenkan ID ditampilkan
      document.getElementById('bms-logger-id-footer').textContent = BMS_LOGGER_ID;

      // Hapus logika prompt dan langsung mulai MQTT
      startMQTT();
      // Gunakan Lucide icons
      lucide.createIcons(); 

      // === Dropdown Toggle ===
      const btn = document.getElementById("settingsBtn");
      const menu = document.getElementById("dropdownMenu");

      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        menu.classList.toggle("hidden");
      });

      window.addEventListener("click", () => {
        menu.classList.add("hidden");
      });

      // === Network Modal Control ===
      const networkBtn = document.getElementById("networkBtn");
      const networkModal = document.getElementById("networkModal");
      const closeNetwork = document.getElementById("closeNetwork");

      networkBtn.addEventListener("click", (e) => {
        e.preventDefault();
        networkModal.classList.remove("hidden");
      });

      closeNetwork.addEventListener("click", () => {
        networkModal.classList.add("hidden");
      });

      window.addEventListener("click", (e) => {
        if (e.target === networkModal) {
          networkModal.classList.add("hidden");
        }
      });
      
    };
  </script>
</body>
</html>
